(window.webpackJsonp=window.webpackJsonp||[]).push([[130],{545:function(e,t,n){"use strict";n.r(t);var l=n(30),a=Object(l.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"ä»æºç æ·±å…¥è¯¦è§£threadlocalå†…å­˜æ³„æ¼é—®é¢˜"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ä»æºç æ·±å…¥è¯¦è§£threadlocalå†…å­˜æ³„æ¼é—®é¢˜"}},[e._v("#")]),e._v(" ä»æºç æ·±å…¥è¯¦è§£ThreadLocalå†…å­˜æ³„æ¼é—®é¢˜")]),e._v(" "),n("h2",{attrs:{id:"_1-é€ æˆå†…å­˜æ³„æ¼çš„åŸå› "}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-é€ æˆå†…å­˜æ³„æ¼çš„åŸå› "}},[e._v("#")]),e._v(" 1. é€ æˆå†…å­˜æ³„æ¼çš„åŸå› ï¼Ÿ")]),e._v(" "),n("p",[e._v("threadLocal æ˜¯ä¸ºäº†è§£å†³"),n("strong",[e._v("å¯¹è±¡ä¸èƒ½è¢«å¤šçº¿ç¨‹å…±äº«è®¿é—®")]),e._v("çš„é—®é¢˜ï¼Œé€šè¿‡ threadLocal.set æ–¹æ³•å°†å¯¹è±¡å®ä¾‹ä¿å­˜åœ¨æ¯ä¸ªçº¿ç¨‹è‡ªå·±æ‰€æ‹¥æœ‰çš„ threadLocalMap ä¸­ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨è‡ªå·±çš„å¯¹è±¡å®ä¾‹ï¼Œå½¼æ­¤ä¸ä¼šå½±å“è¾¾åˆ°éš”ç¦»çš„ä½œç”¨ï¼Œä»è€Œå°±è§£å†³äº†å¯¹è±¡åœ¨è¢«å…±äº«è®¿é—®å¸¦æ¥çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¦‚æœå°†åŒæ­¥æœºåˆ¶å’Œ threadLocal åšä¸€ä¸ªæ¨ªå‘æ¯”è¾ƒçš„è¯ï¼ŒåŒæ­¥æœºåˆ¶å°±æ˜¯é€šè¿‡æ§åˆ¶çº¿ç¨‹è®¿é—®å…±äº«å¯¹è±¡çš„é¡ºåºï¼Œè€Œ threadLocal å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªè¯¥å¯¹è±¡ï¼Œå„ç”¨å„çš„äº’ä¸å½±å“ã€‚æ‰“ä¸ªæ¯”æ–¹è¯´ï¼Œç°åœ¨æœ‰ 100 ä¸ªåŒå­¦éœ€è¦å¡«å†™ä¸€å¼ è¡¨æ ¼ä½†æ˜¯åªæœ‰ä¸€æ”¯ç¬”ï¼ŒåŒæ­¥å°±ç›¸å½“äº A ä½¿ç”¨å®Œè¿™æ”¯ç¬”åç»™ Bï¼ŒB ä½¿ç”¨åç»™ C ç”¨......è€å¸ˆå°±æ§åˆ¶ç€è¿™æ”¯ç¬”çš„ä½¿ç”¨é¡ºåºï¼Œä½¿å¾—åŒå­¦ä¹‹é—´ä¸ä¼šäº§ç”Ÿå†²çªã€‚è€Œ threadLocal å°±ç›¸å½“äºï¼Œè€å¸ˆç›´æ¥å‡†å¤‡äº† 100 æ”¯ç¬”ï¼Œè¿™æ ·æ¯ä¸ªåŒå­¦éƒ½ä½¿ç”¨è‡ªå·±çš„ï¼ŒåŒå­¦ä¹‹é—´å°±ä¸ä¼šäº§ç”Ÿå†²çªã€‚å¾ˆæ˜¾ç„¶è¿™å°±æ˜¯ä¸¤ç§ä¸åŒçš„æ€è·¯ï¼ŒåŒæ­¥æœºåˆ¶ä»¥â€œæ—¶é—´æ¢ç©ºé—´â€ï¼Œç”±äºæ¯ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»å…±äº«å¯¹è±¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®é€ æˆæ•´ä½“ä¸Šå“åº”æ—¶é—´å¢åŠ ï¼Œä½†æ˜¯å¯¹è±¡åªå æœ‰ä¸€ä»½å†…å­˜ï¼Œç‰ºç‰²äº†æ—¶é—´æ•ˆç‡æ¢æ¥äº†ç©ºé—´æ•ˆç‡å³â€œæ—¶é—´æ¢ç©ºé—´â€ã€‚è€Œ threadLocalï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ†é…äº†ä¸€ä»½å¯¹è±¡ï¼Œè‡ªç„¶è€Œç„¶å†…å­˜ä½¿ç”¨ç‡å¢åŠ ï¼Œæ¯ä¸ªçº¿ç¨‹å„ç”¨å„çš„ï¼Œæ•´ä½“ä¸Šæ—¶é—´æ•ˆç‡è¦å¢åŠ å¾ˆå¤šï¼Œç‰ºç‰²äº†ç©ºé—´æ•ˆç‡æ¢æ¥æ—¶é—´æ•ˆç‡å³â€œç©ºé—´æ¢æ—¶é—´â€ã€‚")]),e._v(" "),n("p",[e._v("å…³äº threadLocal,threadLocalMap æ›´å¤šçš„ç»†èŠ‚å¯ä»¥çœ‹"),n("a",{attrs:{href:"https://juejin.im/post/6844903602436177933",target:"_blank",rel:"noopener noreferrer"}},[e._v("è¿™ç¯‡æ–‡ç« "),n("OutboundLink")],1),e._v("ï¼Œç»™å‡ºäº†å¾ˆè¯¦ç»†çš„å„ä¸ªæ–¹é¢çš„çŸ¥è¯†ï¼ˆå¾ˆå¤šä¹Ÿæ˜¯é¢è¯•é«˜é¢‘è€ƒç‚¹ï¼‰ã€‚threadLocal,threadLocalMap,entry ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed57af821e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"threadLocalå¼•ç”¨ç¤ºæ„å›¾"}}),e._v("threadLocalå¼•ç”¨ç¤ºæ„å›¾")]),e._v(" "),n("p",[e._v("ä¸Šå›¾ä¸­ï¼Œå®çº¿ä»£è¡¨å¼ºå¼•ç”¨ï¼Œè™šçº¿ä»£è¡¨çš„æ˜¯å¼±å¼•ç”¨ï¼Œå¦‚æœ threadLocal å¤–éƒ¨å¼ºå¼•ç”¨è¢«ç½®ä¸º null(threadLocalInstance=null)çš„è¯ï¼ŒthreadLocal å®ä¾‹å°±æ²¡æœ‰ä¸€æ¡å¼•ç”¨é“¾è·¯å¯è¾¾ï¼Œå¾ˆæ˜¾ç„¶åœ¨ gc(åƒåœ¾å›æ”¶)çš„æ—¶å€™åŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œå› æ­¤ entry å°±å­˜åœ¨ key ä¸º null çš„æƒ…å†µï¼Œæ— æ³•é€šè¿‡ä¸€ä¸ª Key ä¸º null å»è®¿é—®åˆ°è¯¥ entry çš„ valueã€‚åŒæ—¶ï¼Œå°±å­˜åœ¨äº†è¿™æ ·ä¸€æ¡å¼•ç”¨é“¾ï¼šthreadRef->currentThread->threadLocalMap->entry->valueRef->valueMemory,å¯¼è‡´åœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™è¿›è¡Œå¯è¾¾æ€§åˆ†æçš„æ—¶å€™,value å¯è¾¾ä»è€Œä¸ä¼šè¢«å›æ”¶æ‰ï¼Œä½†æ˜¯è¯¥ value æ°¸è¿œä¸èƒ½è¢«è®¿é—®åˆ°ï¼Œè¿™æ ·å°±å­˜åœ¨äº†"),n("strong",[e._v("å†…å­˜æ³„æ¼")]),e._v("ã€‚å½“ç„¶ï¼Œå¦‚æœçº¿ç¨‹æ‰§è¡Œç»“æŸåï¼ŒthreadLocalï¼ŒthreadRef ä¼šæ–­æ‰ï¼Œå› æ­¤ threadLocal,threadLocalMapï¼Œentry éƒ½ä¼šè¢«å›æ”¶æ‰ã€‚å¯æ˜¯ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­æˆ‘ä»¬éƒ½æ˜¯ä¼šç”¨çº¿ç¨‹æ± å»ç»´æŠ¤æˆ‘ä»¬çš„çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨ Executors.newFixedThreadPool()æ—¶åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†å¤ç”¨çº¿ç¨‹æ˜¯ä¸ä¼šç»“æŸçš„ï¼Œæ‰€ä»¥ threadLocal å†…å­˜æ³„æ¼å°±å€¼å¾—æˆ‘ä»¬å…³æ³¨ã€‚")]),e._v(" "),n("h2",{attrs:{id:"_2-å·²ç»åšå‡ºäº†å“ªäº›æ”¹è¿›"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-å·²ç»åšå‡ºäº†å“ªäº›æ”¹è¿›"}},[e._v("#")]),e._v(" 2. å·²ç»åšå‡ºäº†å“ªäº›æ”¹è¿›ï¼Ÿ")]),e._v(" "),n("p",[e._v("å®é™…ä¸Šï¼Œä¸ºäº†è§£å†³ threadLocal æ½œåœ¨çš„å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼ŒJosh Bloch and Doug Lea å¤§å¸ˆå·²ç»åšäº†ä¸€äº›æ”¹è¿›ã€‚åœ¨ threadLocal çš„ set å’Œ get æ–¹æ³•ä¸­éƒ½æœ‰ç›¸åº”çš„å¤„ç†ã€‚ä¸‹æ–‡ä¸ºäº†å™è¿°ï¼Œé’ˆå¯¹ key ä¸º null çš„ entryï¼Œæºç æ³¨é‡Šä¸º stale entryï¼Œç›´è¯‘ä¸ºä¸æ–°é²œçš„ entryï¼Œè¿™é‡Œæˆ‘å°±ç§°ä¹‹ä¸ºâ€œè„ entryâ€ã€‚æ¯”å¦‚åœ¨ ThreadLocalMap çš„ set æ–¹æ³•ä¸­ï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("private void set(ThreadLocal<?> key, Object value) { // We don't use a fast path as with get() because it is at // least as common to use set() to create new entries as // it is to replace existing ones, in which case, a fast // path would fail more often than not. Entry[] tab = table; int len = tab.length; int i = key.threadLocalHashCode & (len-1); for (Entry e = tab[i];         e != null;         e = tab[i = nextIndex(i, len)]) {    ThreadLocal<?> k = e.get();     if (k == key) {        e.value = value;        return;    }     if (k == null) {        replaceStaleEntry(key, value, i);        return;    } } tab[i] = new Entry(key, value); int sz = ++size; if (!cleanSomeSlots(i, sz) && sz >= threshold)    rehash(); å¤åˆ¶ä»£ç  å¤åˆ¶ä»£ç \n} \n")])])]),n("p",[e._v("åœ¨è¯¥æ–¹æ³•ä¸­é’ˆå¯¹è„ entry åšäº†è¿™æ ·çš„å¤„ç†ï¼š")]),e._v(" "),n("ol",[n("li",[e._v("å¦‚æœå½“å‰ table[i]ï¼=null çš„è¯è¯´æ˜ hash å†²çªå°±éœ€è¦å‘åç¯å½¢æŸ¥æ‰¾ï¼Œè‹¥åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­é‡åˆ°è„ entry å°±é€šè¿‡ replaceStaleEntry è¿›è¡Œå¤„ç†ï¼›")]),e._v(" "),n("li",[e._v("å¦‚æœå½“å‰ table[i]==null çš„è¯è¯´æ˜æ–°çš„ entry å¯ä»¥ç›´æ¥æ’å…¥ï¼Œä½†æ˜¯æ’å…¥åä¼šè°ƒç”¨ cleanSomeSlots æ–¹æ³•æ£€æµ‹å¹¶æ¸…é™¤è„ entry")])]),e._v(" "),n("h4",{attrs:{id:"_2-1-cleansomeslots"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-cleansomeslots"}},[e._v("#")]),e._v(" 2.1 cleanSomeSlots")]),e._v(" "),n("p",[e._v("è¯¥æ–¹æ³•çš„æºç ä¸ºï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("/* @param i a position known NOT to hold a stale entry. The\n * scan starts at the element after i.\n *\n * @param n scan control: {@code log2(n)} cells are scanned,\n * unless a stale entry is found, in which case\n * {@code log2(table.length)-1} additional cells are scanned.\n * When called from insertions, this parameter is the number\n * of elements, but when from replaceStaleEntry, it is the\n * table length. (Note: all this could be changed to be either\n * more or less aggressive by weighting n instead of just\n * using straight log n. But this version is simple, fast, and\n * seems to work well.)\n *\n * @return true if any stale entries have been removed.\n */\nprivate boolean cleanSomeSlots(int i, int n) {\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do {\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null && e.get() == null) {\n            n = len;\n            removed = true;\n            i = expungeStaleEntry(i);\n        }\n    } while ( (n >>>= 1) != 0);\n    return removed;\n}\nå¤åˆ¶ä»£ç \n")])])]),n("p",[n("strong",[e._v("å…¥å‚ï¼š")])]),e._v(" "),n("ol",[n("li",[n("p",[e._v("i è¡¨ç¤ºï¼šæ’å…¥ entry çš„ä½ç½® iï¼Œå¾ˆæ˜¾ç„¶åœ¨ä¸Šè¿°æƒ…å†µ 2ï¼ˆtable[i]==nullï¼‰ä¸­ï¼Œentry åˆšæ’å…¥åè¯¥ä½ç½® i å¾ˆæ˜¾ç„¶ä¸æ˜¯è„ entry;")])]),e._v(" "),n("li",[n("p",[e._v("å‚æ•° n")]),e._v(" "),n("p",[e._v("2.1. n çš„ç”¨é€”")]),e._v(" "),n("p",[e._v("ä¸»è¦ç”¨äº"),n("strong",[e._v("æ‰«ææ§åˆ¶ï¼ˆscan controlï¼‰ï¼Œä» while ä¸­æ˜¯é€šè¿‡ n æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­çš„è¯´æ˜ n å°±æ˜¯ç”¨æ¥æ§åˆ¶æ‰«æè¶Ÿæ•°ï¼ˆå¾ªç¯æ¬¡æ•°ï¼‰çš„")]),e._v("ã€‚åœ¨æ‰«æè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰é‡åˆ°è„ entry å°±æ•´ä¸ªæ‰«æè¿‡ç¨‹æŒç»­ log2(n)æ¬¡ï¼Œlog2(n)çš„å¾—æ¥æ˜¯å› ä¸º"),n("code",[e._v("n >>>= 1")]),e._v("ï¼Œæ¯æ¬¡ n å³ç§»ä¸€ä½ç›¸å½“äº n é™¤ä»¥ 2ã€‚å¦‚æœåœ¨æ‰«æè¿‡ç¨‹ä¸­é‡åˆ°è„ entry çš„è¯å°±ä¼šä»¤ n ä¸ºå½“å‰ hash è¡¨çš„é•¿åº¦ï¼ˆ"),n("code",[e._v("n=len")]),e._v("ï¼‰ï¼Œå†æ‰«æ log2(n)è¶Ÿï¼Œæ³¨æ„æ­¤æ—¶ n å¢åŠ æ— éå°±æ˜¯å¤šå¢åŠ äº†å¾ªç¯æ¬¡æ•°ä»è€Œé€šè¿‡ nextIndex å¾€åæœç´¢çš„èŒƒå›´æ‰©å¤§ï¼Œç¤ºæ„å›¾å¦‚ä¸‹")])])]),e._v(" "),n("p",[e._v('![cleanSomeSlotsç¤ºæ„å›¾.png](data:image/svg+xml;utf8,<?xml version="1.0"?>'),n("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"543",height:"212"}}),e._v(")cleanSomeSlotsç¤ºæ„å›¾.png")]),e._v(" "),n("p",[e._v("æŒ‰ç…§ n çš„åˆå§‹å€¼ï¼Œæœç´¢èŒƒå›´ä¸ºé»‘çº¿ï¼Œå½“é‡åˆ°äº†è„ entryï¼Œæ­¤æ—¶ n å˜æˆäº†å“ˆå¸Œæ•°ç»„çš„é•¿åº¦ï¼ˆn å–å€¼å¢å¤§ï¼‰ï¼Œæœç´¢èŒƒå›´ log2(n)å¢å¤§ï¼Œçº¢çº¿è¡¨ç¤ºã€‚å¦‚æœåœ¨æ•´ä¸ªæœç´¢è¿‡ç¨‹æ²¡é‡åˆ°è„ entry çš„è¯ï¼Œæœç´¢ç»“æŸï¼Œé‡‡ç”¨è¿™ç§æ–¹å¼çš„ä¸»è¦æ˜¯ç”¨äºæ—¶é—´æ•ˆç‡ä¸Šçš„å¹³è¡¡ã€‚")]),e._v(" "),n("p",[e._v("2.2. n çš„å–å€¼ å¦‚æœæ˜¯åœ¨ set æ–¹æ³•æ’å…¥æ–°çš„ entry åè°ƒç”¨ï¼ˆä¸Šè¿°æƒ…å†µ 2ï¼‰ï¼Œn ä½å½“å‰å·²ç»æ’å…¥çš„ entry ä¸ªæ•° sizeï¼›å¦‚æœæ˜¯åœ¨ replaceSateleEntry æ–¹æ³•ä¸­è°ƒç”¨ n ä¸ºå“ˆå¸Œè¡¨çš„é•¿åº¦ lenã€‚")]),e._v(" "),n("h4",{attrs:{id:"_2-2-expungestaleentry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-expungestaleentry"}},[e._v("#")]),e._v(" 2.2 expungeStaleEntry")]),e._v(" "),n("p",[e._v("å¦‚æœå¯¹è¾“å…¥å‚æ•°èƒ½å¤Ÿç†è§£çš„è¯ï¼Œé‚£ä¹ˆ cleanSomeSlots æ–¹æ³•æœç´¢åŸºæœ¬ä¸Šæ¸…é™¤äº†ï¼Œä½†æ˜¯å…¨éƒ¨æå®šè¿˜éœ€è¦æŒæ¡ expungeStaleEntry æ–¹æ³•ï¼Œå½“åœ¨æœç´¢è¿‡ç¨‹ä¸­é‡åˆ°äº†è„ entry çš„è¯å°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•å»æ¸…ç†æ‰è„ entryã€‚æºç ä¸ºï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("/** * Expunge a stale entry by rehashing any possibly colliding entries * lying between staleSlot and the next null slot.  This also expunges * any other stale entries encountered before the trailing null.  See * Knuth, Section 6.4 * * @param staleSlot index of slot known to have null key * @return the index of the next null slot after staleSlot * (all between staleSlot and this slot will have been checked * for expunging). */ private int expungeStaleEntry(int staleSlot) {    Entry[] tab = table;    int len = tab.length; //æ¸…é™¤å½“å‰è„entry // expunge entry at staleSlot tab[staleSlot].value = null; tab[staleSlot] = null; size--; // Rehash until we encounter null Entry e; int i; //2.å¾€åç¯å½¢ç»§ç»­æŸ¥æ‰¾,ç›´åˆ°é‡åˆ°table[i]==nullæ—¶ç»“æŸ for (i = nextIndex(staleSlot, len);     (e = tab[i]) != null;     i = nextIndex(i, len)) {    ThreadLocal<?> k = e.get(); //3. å¦‚æœåœ¨å‘åæœç´¢è¿‡ç¨‹ä¸­å†æ¬¡é‡åˆ°è„entryï¼ŒåŒæ ·å°†å…¶æ¸…ç†æ‰    if (k == null) {        e.value = null;        tab[i] = null;        size--;    } else { \t//å¤„ç†rehashçš„æƒ…å†µ        int h = k.threadLocalHashCode & (len - 1);        if (h != i) {            tab[i] = null;             // Unlike Knuth 6.4 Algorithm R, we must scan until            // null because multiple entries could have been stale.            while (tab[h] != null)                h = nextIndex(h, len);            tab[h] = e;        }    } } return i; å¤åˆ¶ä»£ç  å¤åˆ¶ä»£ç \n} \n")])])]),n("p",[e._v("è¯¥æ–¹æ³•é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼ˆç¬¬ 1,2,3 æ­¥ï¼‰ï¼Œä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š")]),e._v(" "),n("ol",[n("li",[e._v("æ¸…ç†å½“å‰è„ entryï¼Œå³å°†å…¶ value å¼•ç”¨ç½®ä¸º nullï¼Œå¹¶ä¸”å°† table[staleSlot]ä¹Ÿç½®ä¸º nullã€‚value ç½®ä¸º null åè¯¥ value åŸŸå˜ä¸ºä¸å¯è¾¾ï¼Œåœ¨ä¸‹ä¸€æ¬¡ gc çš„æ—¶å€™å°±ä¼šè¢«å›æ”¶æ‰ï¼ŒåŒæ—¶ table[staleSlot]ä¸º null åä»¥ä¾¿äºå­˜æ”¾æ–°çš„ entry;")]),e._v(" "),n("li",[e._v("ä»å½“å‰ staleSlot ä½ç½®å‘åç¯å½¢ï¼ˆnextIndexï¼‰ç»§ç»­æœç´¢ï¼Œç›´åˆ°é‡åˆ°å“ˆå¸Œæ¡¶ï¼ˆtab[i]ï¼‰ä¸º null çš„æ—¶å€™é€€å‡ºï¼›")]),e._v(" "),n("li",[e._v("è‹¥åœ¨æœç´¢è¿‡ç¨‹å†æ¬¡é‡åˆ°è„ entryï¼Œç»§ç»­å°†å…¶æ¸…é™¤ã€‚")])]),e._v(" "),n("p",[e._v("ä¹Ÿå°±æ˜¯è¯´è¯¥æ–¹æ³•ï¼Œ"),n("strong",[e._v("æ¸…ç†æ‰å½“å‰è„ entry åï¼Œå¹¶æ²¡æœ‰é—²ä¸‹æ¥ç»§ç»­å‘åæœç´¢ï¼Œè‹¥å†æ¬¡é‡åˆ°è„ entry ç»§ç»­å°†å…¶æ¸…ç†ï¼Œç›´åˆ°å“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null æ—¶é€€å‡º")]),e._v("ã€‚å› æ­¤æ–¹æ³•æ‰§è¡Œå®Œçš„ç»“æœä¸º "),n("strong",[e._v("ä»å½“å‰è„ entryï¼ˆstaleSlotï¼‰ä½åˆ°è¿”å›çš„ i ä½ï¼Œè¿™ä¸­é—´æ‰€æœ‰çš„ entry ä¸æ˜¯è„ entry")]),e._v("ã€‚ä¸ºä»€ä¹ˆæ˜¯é‡åˆ° null é€€å‡ºå‘¢ï¼ŸåŸå› æ˜¯å­˜åœ¨è„ entry çš„å‰ææ¡ä»¶æ˜¯ "),n("strong",[e._v("å½“å‰å“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸ä¸º null")]),e._v(",åªæ˜¯è¯¥ entry çš„ key åŸŸä¸º nullã€‚å¦‚æœé‡åˆ°å“ˆå¸Œæ¡¶ä¸º null,å¾ˆæ˜¾ç„¶å®ƒè¿æˆä¸ºè„ entry çš„å‰ææ¡ä»¶éƒ½ä¸å…·å¤‡ã€‚")]),e._v(" "),n("p",[e._v("ç°åœ¨å¯¹ cleanSomeSlot æ–¹æ³•åšä¸€ä¸‹æ€»ç»“ï¼Œå…¶æ–¹æ³•æ‰§è¡Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed57b2b9e9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"cleanSomeSlotsç¤ºæ„å›¾.png"}}),e._v("cleanSomeSlotsç¤ºæ„å›¾.png")]),e._v(" "),n("p",[e._v("å¦‚å›¾æ‰€ç¤ºï¼ŒcleanSomeSlot æ–¹æ³•ä¸»è¦æœ‰è¿™æ ·å‡ ç‚¹ï¼š")]),e._v(" "),n("ol",[n("li",[e._v("ä»å½“å‰ä½ç½® i å¤„ï¼ˆä½äº i å¤„çš„ entry ä¸€å®šä¸æ˜¯è„ entryï¼‰ä¸ºèµ·ç‚¹åœ¨åˆå§‹å°èŒƒå›´ï¼ˆlog2(n)ï¼Œn ä¸ºå“ˆå¸Œè¡¨å·²æ’å…¥ entry çš„ä¸ªæ•° sizeï¼‰å¼€å§‹å‘åæœç´¢è„ entryï¼Œè‹¥åœ¨æ•´ä¸ªæœç´¢è¿‡ç¨‹æ²¡æœ‰è„ entryï¼Œæ–¹æ³•ç»“æŸé€€å‡º")]),e._v(" "),n("li",[e._v("å¦‚æœåœ¨æœç´¢è¿‡ç¨‹ä¸­é‡åˆ°è„ entryt é€šè¿‡ expungeStaleEntry æ–¹æ³•æ¸…ç†æ‰å½“å‰è„ entryï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ä¼šè¿”å›ä¸‹ä¸€ä¸ªå“ˆå¸Œæ¡¶(table[i])ä¸º null çš„ç´¢å¼•ä½ç½®ä¸º iã€‚è¿™æ—¶é‡æ–°ä»¤æœç´¢èµ·ç‚¹ä¸ºç´¢å¼•ä½ç½® iï¼Œn ä¸ºå“ˆå¸Œè¡¨çš„é•¿åº¦ lenï¼Œå†æ¬¡æ‰©å¤§æœç´¢èŒƒå›´ä¸º log2(n')ç»§ç»­æœç´¢ã€‚")])]),e._v(" "),n("p",[e._v("ä¸‹é¢ï¼Œä»¥ä¸€ä¸ªä¾‹å­æ›´æ¸…æ™°çš„æ¥è¯´ä¸€ä¸‹ï¼Œå‡è®¾å½“å‰ table æ•°ç»„çš„æƒ…å†µå¦‚ä¸‹å›¾ã€‚")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed57de77a2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"cleanSomeSlotsæ‰§è¡Œæƒ…æ™¯å›¾.png"}}),e._v("cleanSomeSlotsæ‰§è¡Œæƒ…æ™¯å›¾.png")]),e._v(" "),n("ol",[n("li",[e._v("å¦‚å›¾å½“å‰ n ç­‰äº hash è¡¨çš„ size å³ n=10ï¼Œi=1,åœ¨ç¬¬ä¸€è¶Ÿæœç´¢è¿‡ç¨‹ä¸­é€šè¿‡ nextIndex,i æŒ‡å‘äº†ç´¢å¼•ä¸º 2 çš„ä½ç½®ï¼Œæ­¤æ—¶ table[2]ä¸º nullï¼Œè¯´æ˜ç¬¬ä¸€è¶Ÿæœªå‘ç°è„ entry,åˆ™ç¬¬ä¸€è¶Ÿç»“æŸè¿›è¡Œç¬¬äºŒè¶Ÿçš„æœç´¢ã€‚")]),e._v(" "),n("li",[e._v("ç¬¬äºŒè¶Ÿæ‰€æœå…ˆé€šè¿‡ nextIndex æ–¹æ³•ï¼Œç´¢å¼•ç”± 2 çš„ä½ç½®å˜æˆäº† i=3,å½“å‰ table[3]!=null ä½†æ˜¯è¯¥ entry çš„ key ä¸º nullï¼Œè¯´æ˜æ‰¾åˆ°äº†ä¸€ä¸ªè„ entryï¼Œ"),n("strong",[e._v("å…ˆå°† n ç½®ä¸ºå“ˆå¸Œè¡¨çš„é•¿åº¦ len,ç„¶åç»§ç»­è°ƒç”¨ expungeStaleEntry æ–¹æ³•")]),e._v("ï¼Œè¯¥æ–¹æ³•ä¼šå°†å½“å‰ç´¢å¼•ä¸º 3 çš„è„ entry ç»™æ¸…é™¤æ‰ï¼ˆä»¤ value ä¸º nullï¼Œå¹¶ä¸” table[3]ä¹Ÿä¸º nullï¼‰,ä½†æ˜¯"),n("strong",[e._v("è¯¥æ–¹æ³•å¯ä¸æƒ³å·æ‡’ï¼Œå®ƒä¼šç»§ç»­å¾€åç¯å½¢æœç´¢")]),e._v("ï¼Œå¾€åä¼šå‘ç°ç´¢å¼•ä¸º 4,5 çš„ä½ç½®çš„ entry åŒæ ·ä¸ºè„ entryï¼Œç´¢å¼•ä¸º 6 çš„ä½ç½®çš„ entry ä¸æ˜¯è„ entry ä¿æŒä¸å˜ï¼Œç›´è‡³ i=7 çš„æ—¶å€™æ­¤å¤„ table[7]ä½ nullï¼Œè¯¥æ–¹æ³•å°±ä»¥ i=7 è¿”å›ã€‚è‡³æ­¤ï¼Œç¬¬äºŒè¶Ÿæœç´¢ç»“æŸï¼›")]),e._v(" "),n("li",[e._v("ç”±äºåœ¨ç¬¬äºŒè¶Ÿæœç´¢ä¸­å‘ç°è„ entryï¼Œn å¢å¤§ä¸ºæ•°ç»„çš„é•¿åº¦ lenï¼Œå› æ­¤æ‰©å¤§æœç´¢èŒƒå›´ï¼ˆå¢å¤§å¾ªç¯æ¬¡æ•°ï¼‰ç»§ç»­å‘åç¯å½¢æœç´¢ï¼›")]),e._v(" "),n("li",[e._v("ç›´åˆ°åœ¨æ•´ä¸ªæœç´¢èŒƒå›´é‡Œéƒ½æœªå‘ç°è„ entryï¼ŒcleanSomeSlot æ–¹æ³•æ‰§è¡Œç»“æŸé€€å‡ºã€‚")])]),e._v(" "),n("h4",{attrs:{id:"_2-3-replacestaleentry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-replacestaleentry"}},[e._v("#")]),e._v(" 2.3 replaceStaleEntry")]),e._v(" "),n("p",[e._v("å…ˆæ¥çœ‹ replaceStaleEntry æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æºç ä¸ºï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("/* * @param  key the key * @param  value the value to be associated with key * @param  staleSlot index of the first stale entry encountered while *         searching for key. */ private void replaceStaleEntry(ThreadLocal<?> key, Object value,                               int staleSlot) {    Entry[] tab = table;    int len = tab.length;    Entry e; // Back up to check for prior stale entry in current run. // We clean out whole runs at a time to avoid continual // incremental rehashing due to garbage collector freeing // up refs in bunches (i.e., whenever the collector runs). //å‘å‰æ‰¾åˆ°ç¬¬ä¸€ä¸ªè„entry int slotToExpunge = staleSlot; for (int i = prevIndex(staleSlot, len);     (e = tab[i]) != null;     i = prevIndex(i, len))    if (e.get() == null) å¤åˆ¶ä»£ç       slotToExpunge = i; å¤åˆ¶ä»£ç  // Find either the key or trailing null slot of run, whichever // occurs first for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) { ThreadLocal<?> k = e.get(); // If we find key, then we need to swap it // with the stale entry to maintain hash table order. // The newly stale slot, or any other stale slot // encountered above it, can then be sent to expungeStaleEntry // to remove or rehash all of the other entries in run. if (k == key) {  \t//å¦‚æœåœ¨å‘åç¯å½¢æŸ¥æ‰¾è¿‡ç¨‹ä¸­å‘ç°keyç›¸åŒçš„entryå°±è¦†ç›–å¹¶ä¸”å’Œè„entryè¿›è¡Œäº¤æ¢ å¤åˆ¶ä»£ç         e.value = value; å¤åˆ¶ä»£ç         tab[i] = tab[staleSlot]; å¤åˆ¶ä»£ç         tab[staleSlot] = e;      // Start expunge at preceding stale entry if it exists \t//å¦‚æœåœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­è¿˜æœªå‘ç°è„entryï¼Œé‚£ä¹ˆå°±ä»¥å½“å‰ä½ç½®ä½œä¸ºcleanSomeSlots \t//çš„èµ·ç‚¹     if (slotToExpunge == staleSlot) å¤åˆ¶ä»£ç             slotToExpunge = i; \t//æœç´¢è„entryå¹¶è¿›è¡Œæ¸…ç† å¤åˆ¶ä»£ç         cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);     return; }  // If we didn't find stale entry on backward scan, the // first stale entry seen while scanning for key is the // first still present in the run. //å¦‚æœå‘å‰æœªæœç´¢åˆ°è„entryï¼Œåˆ™åœ¨æŸ¥æ‰¾è¿‡ç¨‹é‡åˆ°è„entryçš„è¯ï¼Œåé¢å°±ä»¥æ­¤æ—¶è¿™ä¸ªä½ç½® //ä½œä¸ºèµ·ç‚¹æ‰§è¡ŒcleanSomeSlots if (k == null && slotToExpunge == staleSlot) å¤åˆ¶ä»£ç         slotToExpunge = i; å¤åˆ¶ä»£ç  } // If key not found, put new entry in stale slot //å¦‚æœåœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­æ²¡æœ‰æ‰¾åˆ°å¯ä»¥è¦†ç›–çš„entryï¼Œåˆ™å°†æ–°çš„entryæ’å…¥åœ¨è„entry  tab[staleSlot].value = null;  tab[staleSlot] = new Entry(key, value);  // If there are any other stale entries in run, expunge them å¤åˆ¶ä»£ç  if (slotToExpunge != staleSlot) //æ‰§è¡ŒcleanSomeSlots    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len); å¤åˆ¶ä»£ç   å¤åˆ¶ä»£ç \n} \n")])])]),n("p",[e._v("è¯¥æ–¹æ³•çš„é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼Œä¸‹é¢æˆ‘ç»“åˆå„ç§æƒ…å†µè¯¦ç»†è¯´ä¸€ä¸‹è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ã€‚é¦–å…ˆå…ˆçœ‹è¿™ä¸€éƒ¨åˆ†çš„ä»£ç ï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("int slotToExpunge = staleSlot;\n    for (int i = prevIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = prevIndex(i, len))\n        if (e.get() == null)\n            slotToExpunge = i;\nå¤åˆ¶ä»£ç \n")])])]),n("p",[e._v("è¿™éƒ¨åˆ†ä»£ç é€šè¿‡ PreIndex æ–¹æ³•å®ç°å¾€å‰ç¯å½¢æœç´¢è„ entry çš„åŠŸèƒ½ï¼Œåˆå§‹æ—¶ slotToExpunge å’Œ staleSlot ç›¸åŒï¼Œè‹¥åœ¨æœç´¢è¿‡ç¨‹ä¸­å‘ç°äº†è„ entryï¼Œåˆ™æ›´æ–° slotToExpunge ä¸ºå½“å‰ç´¢å¼• iã€‚å¦å¤–ï¼Œè¯´æ˜ replaceStaleEntry å¹¶ä¸ä»…ä»…å±€é™äºå¤„ç†å½“å‰å·²çŸ¥çš„è„ entryï¼Œå®ƒè®¤ä¸ºåœ¨å‡º"),n("strong",[e._v("ç°è„ entry çš„ç›¸é‚»ä½ç½®ä¹Ÿæœ‰å¾ˆå¤§æ¦‚ç‡å‡ºç°è„ entryï¼Œæ‰€ä»¥ä¸ºäº†ä¸€æ¬¡å¤„ç†åˆ°ä½ï¼Œå°±éœ€è¦å‘å‰ç¯å½¢æœç´¢ï¼Œæ‰¾åˆ°å‰é¢çš„è„ entry")]),e._v("ã€‚é‚£ä¹ˆæ ¹æ®åœ¨å‘å‰æœç´¢ä¸­æ˜¯å¦è¿˜æœ‰è„ entry ä»¥åŠåœ¨ for å¾ªç¯åå‘ç¯å½¢æŸ¥æ‰¾ä¸­æ˜¯å¦æ‰¾åˆ°å¯è¦†ç›–çš„ entryï¼Œæˆ‘ä»¬åˆ†è¿™å››ç§æƒ…å†µæ¥å……åˆ†ç†è§£è¿™ä¸ªæ–¹æ³•ï¼š")]),e._v(" "),n("h6",{attrs:{id:"_2-3-1-å‰å‘æœ‰è„-entry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-å‰å‘æœ‰è„-entry"}},[e._v("#")]),e._v(" 2.3.1 å‰å‘æœ‰è„ entry")]),e._v(" "),n("p",[e._v("######## 2.3.1.1 åå‘ç¯å½¢æŸ¥æ‰¾æ‰¾åˆ°å¯è¦†ç›–çš„ entry")]),e._v(" "),n("p",[e._v("è¯¥æƒ…å½¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed57f12f50?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"å‘å‰ç¯å½¢æœç´¢åˆ°è„entryï¼Œå‘åç¯å½¢æŸ¥æ‰¾åˆ°å¯è¦†ç›–çš„entryçš„æƒ…å†µ.png"}}),e._v(" å¦‚å›¾ï¼ŒslotToExpunge åˆå§‹çŠ¶æ€å’Œ staleSlot ç›¸åŒï¼Œå½“å‰å‘ç¯å½¢æœç´¢é‡åˆ°è„ entry æ—¶ï¼Œåœ¨ç¬¬ 1 è¡Œä»£ç ä¸­ slotToExpunge ä¼šæ›´æ–°ä¸ºå½“å‰è„ entry çš„ç´¢å¼• iï¼Œç›´åˆ°é‡åˆ°å“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null çš„æ—¶å€™ï¼Œå‰å‘æœç´¢è¿‡ç¨‹ç»“æŸã€‚åœ¨æ¥ä¸‹æ¥çš„ for å¾ªç¯ä¸­è¿›è¡Œåå‘ç¯å½¢æŸ¥æ‰¾ï¼Œè‹¥æŸ¥æ‰¾åˆ°äº†å¯è¦†ç›–çš„ entryï¼Œç¬¬ 2,3,4 è¡Œä»£ç å…ˆè¦†ç›–å½“å‰ä½ç½®çš„ entryï¼Œç„¶åå†ä¸ staleSlot ä½ç½®ä¸Šçš„è„ entry è¿›è¡Œäº¤æ¢ã€‚äº¤æ¢ä¹‹åè„ entry å°±æ›´æ¢åˆ°äº† i å¤„ï¼Œæœ€åä½¿ç”¨ cleanSomeSlots æ–¹æ³•ä» slotToExpunge ä¸ºèµ·ç‚¹å¼€å§‹è¿›è¡Œæ¸…ç†è„ entry çš„è¿‡ç¨‹")]),e._v(" "),n("p",[e._v("######## 2.3.1.2 åå‘ç¯å½¢æŸ¥æ‰¾æœªæ‰¾åˆ°å¯è¦†ç›–çš„ entry")]),e._v(" "),n("p",[e._v("è¯¥æƒ…å½¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  "),n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2020/1/12/16f987a27465aebb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"å‰å‘ç¯å½¢æœç´¢åˆ°è„entry,å‘åç¯å½¢æœªæœç´¢å¯è¦†ç›–entry.png"}}),e._v(" å¦‚å›¾ï¼ŒslotToExpunge åˆå§‹çŠ¶æ€å’Œ staleSlot ç›¸åŒï¼Œå½“å‰å‘ç¯å½¢æœç´¢é‡åˆ°è„ entry æ—¶ï¼Œåœ¨ç¬¬ 1 è¡Œä»£ç ä¸­ slotToExpunge ä¼šæ›´æ–°ä¸ºå½“å‰è„ entry çš„ç´¢å¼• iï¼Œç›´åˆ°é‡åˆ°å“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null çš„æ—¶å€™ï¼Œå‰å‘æœç´¢è¿‡ç¨‹ç»“æŸã€‚åœ¨æ¥ä¸‹æ¥çš„ for å¾ªç¯ä¸­è¿›è¡Œåå‘ç¯å½¢æŸ¥æ‰¾ï¼Œè‹¥æ²¡æœ‰æŸ¥æ‰¾åˆ°äº†å¯è¦†ç›–çš„ entryï¼Œå“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null çš„æ—¶å€™ï¼Œåå‘ç¯å½¢æŸ¥æ‰¾è¿‡ç¨‹ç»“æŸã€‚é‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 8,9 è¡Œä»£ç ä¸­ï¼Œå°†æ’å…¥çš„æ–° entry ç›´æ¥æ”¾åœ¨ staleSlot å¤„å³å¯ï¼Œæœ€åä½¿ç”¨ cleanSomeSlots æ–¹æ³•ä» slotToExpunge ä¸ºèµ·ç‚¹å¼€å§‹è¿›è¡Œæ¸…ç†è„ entry çš„è¿‡ç¨‹")]),e._v(" "),n("h6",{attrs:{id:"_2-3-2-å‰å‘æ²¡æœ‰è„-entry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-å‰å‘æ²¡æœ‰è„-entry"}},[e._v("#")]),e._v(" 2.3.2 å‰å‘æ²¡æœ‰è„ entry")]),e._v(" "),n("p",[e._v("######## 2.3.2.1 åå‘ç¯å½¢æŸ¥æ‰¾æ‰¾åˆ°å¯è¦†ç›–çš„ entry")]),e._v(" "),n("p",[e._v("è¯¥æƒ…å½¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ "),n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed585ef797?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"å‰å‘æœªæœç´¢åˆ°è„entryï¼Œåå‘ç¯å½¢æœç´¢åˆ°å¯è¦†ç›–çš„entry.png.png"}}),e._v(" å¦‚å›¾ï¼ŒslotToExpunge åˆå§‹çŠ¶æ€å’Œ staleSlot ç›¸åŒï¼Œå½“å‰å‘ç¯å½¢æœç´¢ç›´åˆ°é‡åˆ°å“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null çš„æ—¶å€™ï¼Œå‰å‘æœç´¢è¿‡ç¨‹ç»“æŸï¼Œè‹¥åœ¨æ•´ä¸ªè¿‡ç¨‹æœªé‡åˆ°è„ entryï¼ŒslotToExpunge åˆå§‹çŠ¶æ€ä¾æ—§å’Œ staleSlot ç›¸åŒã€‚åœ¨æ¥ä¸‹æ¥çš„ for å¾ªç¯ä¸­è¿›è¡Œåå‘ç¯å½¢æŸ¥æ‰¾ï¼Œè‹¥é‡åˆ°äº†è„ entryï¼Œåœ¨ç¬¬ 7 è¡Œä»£ç ä¸­æ›´æ–° slotToExpunge ä¸ºä½ç½® iã€‚è‹¥æŸ¥æ‰¾åˆ°äº†å¯è¦†ç›–çš„ entryï¼Œç¬¬ 2,3,4 è¡Œä»£ç å…ˆè¦†ç›–å½“å‰ä½ç½®çš„ entryï¼Œç„¶åå†ä¸ staleSlot ä½ç½®ä¸Šçš„è„ entry è¿›è¡Œäº¤æ¢ï¼Œäº¤æ¢ä¹‹åè„ entry å°±æ›´æ¢åˆ°äº† i å¤„ã€‚å¦‚æœåœ¨æ•´ä¸ªæŸ¥æ‰¾è¿‡ç¨‹ä¸­éƒ½è¿˜æ²¡æœ‰é‡åˆ°è„ entry çš„è¯ï¼Œä¼šé€šè¿‡ç¬¬ 5 è¡Œä»£ç ï¼Œå°† slotToExpunge æ›´æ–°å½“å‰ i å¤„ï¼Œæœ€åä½¿ç”¨ cleanSomeSlots æ–¹æ³•ä» slotToExpunge ä¸ºèµ·ç‚¹å¼€å§‹è¿›è¡Œæ¸…ç†è„ entry çš„è¿‡ç¨‹ã€‚")]),e._v(" "),n("p",[e._v("######## 2.3.2.2 åå‘ç¯å½¢æŸ¥æ‰¾æœªæ‰¾åˆ°å¯è¦†ç›–çš„ entry")]),e._v(" "),n("p",[e._v("è¯¥æƒ…å½¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed588785ec?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"å‰å‘ç¯å½¢æœªæœç´¢åˆ°è„entry,åå‘ç¯å½¢æŸ¥æ‰¾æœªæŸ¥æ‰¾åˆ°å¯è¦†ç›–çš„entry.png"}}),e._v("å‰å‘ç¯å½¢æœªæœç´¢åˆ°è„entry,åå‘ç¯å½¢æŸ¥æ‰¾æœªæŸ¥æ‰¾åˆ°å¯è¦†ç›–çš„entry.png")]),e._v(" "),n("p",[e._v("å¦‚å›¾ï¼ŒslotToExpunge åˆå§‹çŠ¶æ€å’Œ staleSlot ç›¸åŒï¼Œå½“å‰å‘ç¯å½¢æœç´¢ç›´åˆ°é‡åˆ°å“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null çš„æ—¶å€™ï¼Œå‰å‘æœç´¢è¿‡ç¨‹ç»“æŸï¼Œè‹¥åœ¨æ•´ä¸ªè¿‡ç¨‹æœªé‡åˆ°è„ entryï¼ŒslotToExpunge åˆå§‹çŠ¶æ€ä¾æ—§å’Œ staleSlot ç›¸åŒã€‚åœ¨æ¥ä¸‹æ¥çš„ for å¾ªç¯ä¸­è¿›è¡Œåå‘ç¯å½¢æŸ¥æ‰¾ï¼Œè‹¥é‡åˆ°äº†è„ entryï¼Œåœ¨ç¬¬ 7 è¡Œä»£ç ä¸­æ›´æ–° slotToExpunge ä¸ºä½ç½® iã€‚è‹¥æ²¡æœ‰æŸ¥æ‰¾åˆ°äº†å¯è¦†ç›–çš„ entryï¼Œå“ˆå¸Œæ¡¶ï¼ˆtable[i]ï¼‰ä¸º null çš„æ—¶å€™ï¼Œåå‘ç¯å½¢æŸ¥æ‰¾è¿‡ç¨‹ç»“æŸã€‚é‚£ä¹ˆæ¥ä¸‹æ¥åœ¨ 8,9 è¡Œä»£ç ä¸­ï¼Œå°†æ’å…¥çš„æ–° entry ç›´æ¥æ”¾åœ¨ staleSlot å¤„å³å¯ã€‚å¦å¤–ï¼Œå¦‚æœå‘ç° slotToExpunge è¢«é‡ç½®ï¼Œåˆ™ç¬¬ 10 è¡Œä»£ç  if åˆ¤æ–­ä¸º true,å°±ä½¿ç”¨ cleanSomeSlots æ–¹æ³•ä» slotToExpunge ä¸ºèµ·ç‚¹å¼€å§‹è¿›è¡Œæ¸…ç†è„ entry çš„è¿‡ç¨‹ã€‚")]),e._v(" "),n("p",[e._v("ä¸‹é¢ç”¨ä¸€ä¸ªå®ä¾‹æ¥æœ‰ä¸ªç›´è§‚çš„æ„Ÿå—ï¼Œç¤ºä¾‹ä»£ç å°±ä¸ç»™å‡ºäº†ï¼Œä»£ç  debug æ—¶ table çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/5/6/163346ed7e84c9e0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"1.2æƒ…å†µç¤ºæ„å›¾.png"}}),e._v("1.2æƒ…å†µç¤ºæ„å›¾.png")]),e._v(" "),n("p",[e._v("å¦‚å›¾æ‰€ç¤ºï¼Œå½“å‰çš„ staleSolt ä¸º i=4ï¼Œé¦–å…ˆå…ˆè¿›è¡Œå‰å‘æœç´¢è„ entryï¼Œå½“ i=3 çš„æ—¶å€™é‡åˆ°è„ entryï¼ŒslotToExpung æ›´æ–°ä¸º 3ï¼Œå½“ i=2 çš„æ—¶å€™ tabel[2]ä¸º nullï¼Œå› æ­¤å‰å‘æœç´¢è„ entry çš„è¿‡ç¨‹ç»“æŸã€‚ç„¶åè¿›è¡Œåå‘ç¯å½¢æŸ¥æ‰¾ï¼ŒçŸ¥é“ i=7 çš„æ—¶å€™é‡åˆ° table[7]ä¸º nullï¼Œç»“æŸåå‘æŸ¥æ‰¾è¿‡ç¨‹ï¼Œå¹¶ä¸”åœ¨è¯¥è¿‡ç¨‹å¹¶æ²¡æœ‰æ‰¾åˆ°å¯ä»¥è¦†ç›–çš„ entryã€‚æœ€ååªèƒ½åœ¨ staleSlotï¼ˆ4ï¼‰å¤„æ’å…¥æ–° entryï¼Œç„¶åä» slotToExpungeï¼ˆ3ï¼‰ä¸ºèµ·ç‚¹è¿›è¡Œ cleanSomeSlots è¿›è¡Œè„ entry çš„æ¸…ç†ã€‚æ˜¯ä¸æ˜¯ä¸Šé¢çš„ 1.2 çš„æƒ…å†µã€‚")]),e._v(" "),n("p",[e._v("è¿™äº›æ ¸å¿ƒæ–¹æ³•ï¼Œé€šè¿‡æºç åˆç»™å‡ºç¤ºä¾‹å›¾ï¼Œåº”è¯¥æœ€ç»ˆéƒ½èƒ½æŒæ¡äº†ï¼Œä¹Ÿè¿˜æŒºæœ‰æ„æ€çš„ã€‚è‹¥è§‰å¾—ä¸é”™ï¼Œå¯¹æˆ‘çš„è¾›åŠ³ä»˜å‡ºèƒ½ç»™å‡ºé¼“åŠ±æ¬¢è¿ç‚¹èµï¼Œç»™å°å¼Ÿé¼“åŠ±ï¼Œåœ¨æ­¤è°¢è¿‡ ğŸ˜ƒã€‚")]),e._v(" "),n("p",[n("strong",[e._v("å½“æˆ‘ä»¬è°ƒç”¨ threadLocal çš„ get æ–¹æ³•")]),e._v("æ—¶ï¼Œå½“ table[i]ä¸æ˜¯å’Œæ‰€è¦æ‰¾çš„ key ç›¸åŒçš„è¯ï¼Œä¼šç»§ç»­é€šè¿‡ threadLocalMap çš„ getEntryAfterMiss æ–¹æ³•å‘åç¯å½¢å»æ‰¾ï¼Œè¯¥æ–¹æ³•ä¸ºï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("private Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {    Entry[] tab = table;    int len = tab.length; while (e != null) {    ThreadLocal<?> k = e.get();    if (k == key)        return e;    if (k == null)        expungeStaleEntry(i);    else        i = nextIndex(i, len);    e = tab[i]; } return null; å¤åˆ¶ä»£ç  å¤åˆ¶ä»£ç \n} \n")])])]),n("p",[e._v("å½“ key==null çš„æ—¶å€™ï¼Œå³é‡åˆ°è„ entry ä¹Ÿä¼šè°ƒç”¨ expungeStleEntry å¯¹è„ entry è¿›è¡Œæ¸…ç†ã€‚")]),e._v(" "),n("p",[n("strong",[e._v("å½“æˆ‘ä»¬è°ƒç”¨ threadLocal.remove æ–¹æ³•æ—¶å€™")]),e._v("ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨ threadLocalMap çš„ remove æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æºç ä¸ºï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("private void remove(ThreadLocal<?> key) {\n    Entry[] tab = table;\n    int len = tab.length;\n    int i = key.threadLocalHashCode & (len-1);\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        if (e.get() == key) {\n            e.clear();\n            expungeStaleEntry(i);\n            return;\n        }\n    }\n}\nå¤åˆ¶ä»£ç \n")])])]),n("p",[e._v("åŒæ ·çš„å¯ä»¥çœ‹å‡ºï¼Œå½“é‡åˆ°äº† key ä¸º null çš„è„ entry çš„æ—¶å€™ï¼Œä¹Ÿä¼šè°ƒç”¨ expungeStaleEntry æ¸…ç†æ‰è„ entryã€‚")]),e._v(" "),n("p",[e._v("ä»ä»¥ä¸Š set,getEntry,remove æ–¹æ³•çœ‹å‡ºï¼Œ"),n("strong",[e._v("åœ¨ threadLocal çš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œé’ˆå¯¹ threadLocal å­˜åœ¨çš„å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œéƒ½ä¼šé€šè¿‡ expungeStaleEntryï¼ŒcleanSomeSlots,replaceStaleEntry è¿™ä¸‰ä¸ªæ–¹æ³•æ¸…ç†æ‰ key ä¸º null çš„è„ entry")]),e._v("ã€‚")]),e._v(" "),n("h4",{attrs:{id:"_2-4-ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨"}},[e._v("#")]),e._v(" 2.4 ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ")]),e._v(" "),n("p",[e._v("ä»æ–‡ç« å¼€å¤´é€šè¿‡ threadLocal,threadLocalMap,entry çš„å¼•ç”¨å…³ç³»çœ‹èµ·æ¥ threadLocal å­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜ä¼¼ä¹æ˜¯å› ä¸º threadLocal æ˜¯è¢«å¼±å¼•ç”¨ä¿®é¥°çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼±å¼•ç”¨å‘¢ï¼Ÿ")]),e._v(" "),n("blockquote",[n("p",[e._v("å¦‚æœä½¿ç”¨å¼ºå¼•ç”¨")])]),e._v(" "),n("p",[e._v("å‡è®¾ threadLocal ä½¿ç”¨çš„æ˜¯å¼ºå¼•ç”¨ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­æ‰§è¡Œ"),n("code",[e._v("threadLocalInstance==null")]),e._v("æ“ä½œï¼Œä»¥æ¸…ç†æ‰ threadLocal å®ä¾‹çš„ç›®çš„ï¼Œä½†æ˜¯å› ä¸º threadLocalMap çš„ Entry å¼ºå¼•ç”¨ threadLocalï¼Œå› æ­¤åœ¨ gc çš„æ—¶å€™è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼ŒthreadLocal ä¾ç„¶å¯è¾¾ï¼Œå¯¹ threadLocal å¹¶ä¸ä¼šè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¿™æ ·å°±æ— æ³•çœŸæ­£è¾¾åˆ°ä¸šåŠ¡é€»è¾‘çš„ç›®çš„ï¼Œå‡ºç°é€»è¾‘é”™è¯¯")]),e._v(" "),n("blockquote",[n("p",[e._v("å¦‚æœä½¿ç”¨å¼±å¼•ç”¨")])]),e._v(" "),n("p",[e._v("å‡è®¾ Entry å¼±å¼•ç”¨ threadLocalï¼Œå°½ç®¡ä¼šå‡ºç°å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨ threadLocal çš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼ˆset,getEntry,removeï¼‰é‡Œï¼Œéƒ½ä¼šé’ˆå¯¹ key ä¸º null çš„è„ entry è¿›è¡Œå¤„ç†ã€‚")]),e._v(" "),n("p",[e._v("ä»ä»¥ä¸Šçš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨å¼±å¼•ç”¨çš„è¯åœ¨ threadLocal ç”Ÿå‘½å‘¨æœŸé‡Œä¼šå°½å¯èƒ½çš„ä¿è¯ä¸å‡ºç°å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œè¾¾åˆ°å®‰å…¨çš„çŠ¶æ€ã€‚")]),e._v(" "),n("h4",{attrs:{id:"_2-5-thread-exit"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-thread-exit"}},[e._v("#")]),e._v(" 2.5 Thread.exit()")]),e._v(" "),n("p",[e._v("å½“çº¿ç¨‹é€€å‡ºæ—¶ä¼šæ‰§è¡Œ exit æ–¹æ³•ï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("private void exit() {\n    if (group != null) {\n        group.threadTerminated(this);\n        group = null;\n    }\n    /* Aggressively null out all reference fields: see bug 4006245 */\n    target = null;\n    /* Speed the release of some of these resources */\n    threadLocals = null;\n    inheritableThreadLocals = null;\n    inheritedAccessControlContext = null;\n    blocker = null;\n    uncaughtExceptionHandler = null;\n}\nå¤åˆ¶ä»£ç \n")])])]),n("p",[e._v("ä»æºç å¯ä»¥çœ‹å‡ºå½“çº¿ç¨‹ç»“æŸæ—¶ï¼Œä¼šä»¤ threadLocals=nullï¼Œä¹Ÿå°±æ„å‘³ç€ GC çš„æ—¶å€™å°±å¯ä»¥å°† threadLocalMap è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ¢å¥è¯è¯´ threadLocalMap ç”Ÿå‘½å‘¨æœŸå®é™…ä¸Š thread çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒã€‚")]),e._v(" "),n("h2",{attrs:{id:"_3-threadlocal-æœ€ä½³å®è·µ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-threadlocal-æœ€ä½³å®è·µ"}},[e._v("#")]),e._v(" 3. threadLocal æœ€ä½³å®è·µ")]),e._v(" "),n("p",[e._v("é€šè¿‡è¿™ç¯‡æ–‡ç« å¯¹ threadLocal çš„å†…å­˜æ³„æ¼åšäº†å¾ˆè¯¦ç»†çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨ç†è§£ threadLocal å†…å­˜æ³„æ¼çš„å‰å› åæœï¼Œé‚£ä¹ˆå®è·µä¸­æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšï¼Ÿ")]),e._v(" "),n("ol",[n("li",[e._v("æ¯æ¬¡ä½¿ç”¨å®Œ ThreadLocalï¼Œéƒ½è°ƒç”¨å®ƒçš„ remove()æ–¹æ³•ï¼Œæ¸…é™¤æ•°æ®ã€‚")]),e._v(" "),n("li",[e._v("åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰åŠæ—¶æ¸…ç† ThreadLocalï¼Œä¸ä»…æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ›´ä¸¥é‡çš„æ˜¯å¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘å‡ºç°é—®é¢˜ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ ThreadLocal å°±è·ŸåŠ é”å®Œè¦è§£é”ä¸€æ ·ï¼Œç”¨å®Œå°±æ¸…ç†ã€‚")])]),e._v(" "),n("p",[e._v("æ¥æºäº https://juejin.cn/post/6844903602436358157")])])}),[],!1,null,null,null);t.default=a.exports}}]);