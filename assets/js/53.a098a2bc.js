(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{480:function(t,s,e){"use strict";e.r(s);var a=e(30),r=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"使用-jenkins-部署-spring-boot"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-jenkins-部署-spring-boot"}},[t._v("#")]),t._v(" 使用 Jenkins 部署 Spring Boot")]),t._v(" "),e("p",[t._v("Jenkins 搭建、部署分为四个步骤；")]),t._v(" "),e("ul",[e("li",[t._v("第一步，Jenkins 安装")]),t._v(" "),e("li",[t._v("第二步，插件安装和配置")]),t._v(" "),e("li",[t._v("第三步，Push SSH")]),t._v(" "),e("li",[t._v("第四步，部署项目")])]),t._v(" "),e("h2",{attrs:{id:"第一步-jenkins-安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第一步-jenkins-安装"}},[t._v("#")]),t._v(" 第一步 ，Jenkins 安装")]),t._v(" "),e("p",[t._v("准备环境：")]),t._v(" "),e("p",[t._v("JDK:1.8\nJenkins:2.83 Centos:7.3\nmaven 3.5")]),t._v(" "),e("blockquote",[e("p",[t._v("Jdk 默认已经安装完成")])]),t._v(" "),e("h3",{attrs:{id:"配置-maven"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-maven"}},[t._v("#")]),t._v(" 配置 Maven")]),t._v(" "),e("p",[t._v("版本要求 Maven3.5.0")]),t._v(" "),e("p",[t._v("软件下载")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("wget http://mirror.bit.edu.cn/apache/maven/maven-3/3.5.0/binaries/apache-maven-3.5.0-bin.tar.gz\n")])])]),e("p",[t._v("安装")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("## 解压\ntar vxf apache-maven-3.5.0-bin.tar.gz\n## 移动\nmv apache-maven-3.5.0 /usr/local/maven3\n")])])]),e("p",[t._v("修改环境变量， 在"),e("code",[t._v("/etc/profile")]),t._v("中添加以下几行")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("MAVEN_HOME=/usr/local/maven3\nexport MAVEN_HOME\nexport PATH=${PATH}:${MAVEN_HOME}/bin\n")])])]),e("p",[t._v("记得执行"),e("code",[t._v("source /etc/profile")]),t._v("使环境变量生效。")]),t._v(" "),e("p",[t._v("验证 最后运行"),e("code",[t._v("mvn -v")]),t._v("验证maven是否安装成功")]),t._v(" "),e("h3",{attrs:{id:"配置防护墙"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置防护墙"}},[t._v("#")]),t._v(" 配置防护墙")]),t._v(" "),e("p",[t._v("关闭防护墙")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("#centos7\nsystemctl stop firewalld.service\n==============================\n#以下为：centOS 6.5关闭防火墙步骤\n#关闭命令：  \nservice iptables stop \n#永久关闭防火墙：\nchkconfig iptables off\n")])])]),e("p",[t._v("两个命令同时运行，运行完成后查看防火墙关闭状态")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("service iptables status\n")])])]),e("h3",{attrs:{id:"jenkins-安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-安装"}},[t._v("#")]),t._v(" Jenkins 安装")]),t._v(" "),e("p",[t._v("下载")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("cd /opt\nwget http://mirrors.jenkins.io/war/2.83/jenkins.war\n")])])]),e("p",[t._v("启动服务")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("java -jar jenkins.war &\n")])])]),e("p",[t._v("Jenkins 就启动成功了！它的war包自带Jetty服务器")]),t._v(" "),e("p",[t._v("第一次启动 Jenkins 时，出于安全考虑，Jenkins 会自动生成一个随机的按照口令。"),e("strong",[t._v("注意控制台输出的口令，复制下来")]),t._v("，然后在浏览器输入密码：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("INFO: \n\n*************************************************************\n*************************************************************\n*************************************************************\n\nJenkins initial setup is required. An admin user has been created and a password generated.\nPlease use the following password to proceed to installation:\n\n0cca37389e6540c08ce6e4c96f46da0f\n\nThis may also be found at: /root/.jenkins/secrets/initialAdminPassword\n\n*************************************************************\n*************************************************************\n*************************************************************\n")])])]),e("p",[t._v("访问 浏览器访问："),e("code",[t._v("http://localhost:8080/")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/1.png",alt:"img"}})]),t._v(" "),e("p",[t._v("输入：0cca37389e6540c08ce6e4c96f46da0f")]),t._v(" "),e("p",[t._v("进入用户自定义插件界面，建议选择安装官方推荐插件，因为安装后自己也得安装:")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/2.png",alt:"img"}})]),t._v(" "),e("p",[t._v("接下来是进入插件安装进度界面:")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://favorites.ren/assets/images/2017/jenkins/3.png",alt:"img"}})]),t._v(" "),e("p",[t._v("插件一次可能不会完全安装成功，可以点击Retry再次安装。直到全部安装成功")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/32.png",alt:"img"}})]),t._v(" "),e("p",[t._v("等待一段时间之后，插件安装完成，配置用户名密码:")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://favorites.ren/assets/images/2017/jenkins/4.png",alt:"img"}})]),t._v(" "),e("p",[t._v("输入：admin/admin")]),t._v(" "),e("p",[t._v("系统管理-》全局工具配置 jdk路径，")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/5.png",alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"第二步-插件安装和配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第二步-插件安装和配置"}},[t._v("#")]),t._v(" 第二步，插件安装和配置")]),t._v(" "),e("p",[t._v("有很多插件都是选择的默认的安装的，所以现在需要我们安装的插件不多，Git plugin 和 Maven Integration plugin，publish over SSH。")]),t._v(" "),e("p",[t._v("插件安装：系统管理 > 插件管理 > 可选插件,勾选需要安装的插件，点击直接安装或者下载重启后安装")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/6.png",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"配置全局变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置全局变量"}},[t._v("#")]),t._v(" 配置全局变量")]),t._v(" "),e("p",[t._v("系统管理 > 全局工具配置")]),t._v(" "),e("p",[e("strong",[t._v("JDK")])]),t._v(" "),e("p",[t._v("配置本地 JDK 的路径，去掉勾选自动安装")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/7.png",alt:"img"}})]),t._v(" "),e("p",[e("strong",[t._v("Maven")])]),t._v(" "),e("p",[t._v("配置本地maven的路径，去掉勾选自动安装")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/8.png",alt:"img"}})]),t._v(" "),e("p",[t._v("其它内容可以根据自己的情况选择安装。")]),t._v(" "),e("h3",{attrs:{id:"使用密钥方式登录目标发布服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用密钥方式登录目标发布服务器"}},[t._v("#")]),t._v(" 使用密钥方式登录目标发布服务器")]),t._v(" "),e("p",[t._v("ssh 的配置可使用密钥，也可以使用密码，这里我们使用密钥来配置，在配置之前先配置好jenkins服务器和应用服务器的密钥认证 "),e("strong",[t._v("Jenkins服务器")]),t._v("上生成密钥对，使用"),e("code",[t._v("ssh-keygen -t rsa")]),t._v("命令")]),t._v(" "),e("p",[t._v("输入下面命令 一直回车，一个矩形图形出现就说明成功，在~/.ssh/下会有私钥id_rsa和公钥id_rsa.pub")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ssh-keygen -t rsa\n")])])]),e("p",[t._v("将"),e("strong",[t._v("jenkins服务器")]),t._v("的公钥"),e("code",[t._v("id_rsa.pub")]),t._v("中的内容复制到"),e("strong",[t._v("应用服务器")]),t._v(" 的~/.ssh/下的 "),e("code",[t._v("authorized_keys")]),t._v("文件")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ssh-copy-id -i id_rsa.pub 192.168.0.xx\nchmod 644 authorized_keys\n")])])]),e("p",[t._v("在"),e("strong",[t._v("应用服务器")]),t._v("上重启 ssh 服务，"),e("code",[t._v("service sshd restart")]),t._v("现在 Jenkins 服务器可免密码直接登陆应用服务器")]),t._v(" "),e("p",[t._v("之后在用 ssh B尝试能否免密登录 B 服务器，如果还是提示需要输入密码，则有以下原因")]),t._v(" "),e("ul",[e("li",[t._v("a. 非 root 账户可能不支持 ssh 公钥认证（看服务器是否有限制）")]),t._v(" "),e("li",[t._v("b. 传过来的公钥文件权限不够，可以给这个文件授权下 chmod 644 authorized_keys")]),t._v(" "),e("li",[t._v("c. 使用 root 账户执行 ssh-copy-id -i ~/.ssh/id_rsa.pub 这个指令的时候如果需要输入密码则要配置sshd_config")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("vi /etc/ssh/sshd_config\n#内容\nPermitRootLogin no\n")])])]),e("p",[t._v("修改完后要重启 sshd 服务")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("service sshd restart\n")])])]),e("p",[t._v("最后，如果可以 SSH IP 免密登录成功说明 SSH 公钥认证成功。")]),t._v(" "),e("p",[e("strong",[t._v("上面这种方式比较复杂，其实在 Jenkins 后台直接添加操作即可，参考下面方式")])]),t._v(" "),e("h3",{attrs:{id:"使用用户名-密码方式登录目标发布服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用用户名-密码方式登录目标发布服务器"}},[t._v("#")]),t._v(" 使用用户名+密码方式登录目标发布服务器")]),t._v(" "),e("p",[t._v("(1)点击”高级”展开配置")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/40.png",alt:"img"}})]),t._v(" "),e("p",[t._v("(2)配置SSH的登陆密码")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/41.png",alt:"img"}})]),t._v(" "),e("p",[t._v("配置完成后可点击“Test Configuration”测试到目标主机的连接，出现”success“则成功连接，如果有多台应用服务器，可以点击”增加“，配置多个“SSH Servers” 点击“保存”以保存配置。")]),t._v(" "),e("h2",{attrs:{id:"第三步-push-ssh"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第三步-push-ssh"}},[t._v("#")]),t._v(" 第三步，Push SSH")]),t._v(" "),e("p",[t._v("系统管理 > 系统设置")]),t._v(" "),e("p",[t._v("选择 Publish over SSH")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/9.png",alt:"img"}})]),t._v(" "),e("p",[t._v("Passphrase 不用设置 Path to key 写上生成的ssh路径："),e("code",[t._v("/root/.ssh/id_rsa")])]),t._v(" "),e("p",[t._v("下面的 SSH Servers 是重点")]),t._v(" "),e("ul",[e("li",[t._v("Name 随意起名代表这个服务，待会要根据它来选择")]),t._v(" "),e("li",[t._v("Hostname 配置应用服务器的地址")]),t._v(" "),e("li",[t._v("Username 配置 linux 登陆用户名")]),t._v(" "),e("li",[t._v("Remote Directory 不填")])]),t._v(" "),e("blockquote",[e("p",[t._v("点击下方增加可以添加多个应用服务器的地址")])]),t._v(" "),e("h2",{attrs:{id:"第四步-部署项目"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第四步-部署项目"}},[t._v("#")]),t._v(" 第四步，部署项目")]),t._v(" "),e("p",[t._v("首页点击"),e("strong",[t._v("新建")]),t._v("：输入项目名称")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/10.png",alt:"img"}})]),t._v(" "),e("p",[t._v("下方选择构建一个 Maven 项目，点击确定。")]),t._v(" "),e("p",[t._v("勾选"),e("strong",[t._v("丢弃旧的构建")]),t._v("，选择是否备份被替换的旧包。我这里选择备份最近的10个")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/12.png",alt:"img"}})]),t._v(" "),e("p",[t._v("源码管理，选择 SVN，配置 SVN 相关信息，点击 add 可以输入 SVN 的账户和密码")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/11.png",alt:"img"}})]),t._v(" "),e("p",[t._v("SVN 地址：http://192.168.0.xx/svn/xxx@HEAD,"),e("code",[t._v("@HEAD")]),t._v("意思取最新版本")]),t._v(" "),e("p",[t._v("构建环境中勾选“Add timestamps to the Console Output”，代码构建的过程中会将日志打印出来")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/13.png",alt:"img"}})]),t._v(" "),e("p",[t._v("在 Build 中输入打包前的 mvn 命令，如：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("clean install -Dmaven.test.skip=true -Ptest\n")])])]),e("p",[t._v("意思是：排除测试的包内容，使用后缀为 test 的配置文件。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/14.png",alt:"img"}})]),t._v(" "),e("p",[t._v("Post Steps 选择 Run only if build succeeds")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/15.png",alt:"img"}})]),t._v(" "),e("p",[t._v("点击"),e("strong",[t._v("Add post-build step")]),t._v("，选择 Send files or execute commands over SSH")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/16.png",alt:"img"}})]),t._v(" "),e("p",[t._v("Name 选择上面配置的 Push SSH")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/17.png",alt:"img"}})]),t._v(" "),e("p",[t._v("Source files配置:target/xxx-0.0.1-SNAPSHOT.jar 项目jar包名 Remove prefix:target/ Remote directory:Jenkins-in/ 代码应用服务器的目录地址， Exec command：Jenkins-in/xxx.sh 应用服务器对应的脚本。")]),t._v(" "),e("p",[t._v("需要在应用服务器创建文件夹：Jenkins-in，在文件夹中复制一下脚本内容：xxx.sh")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("DATE=$(date +%Y%m%d)\nexport JAVA_HOME PATH CLASSPATH\nJAVA_HOME=/usr/java/jdk1.8.0_131\nPATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH\nCLASSPATH=.:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$CLASSPATH\nDIR=/root/xxx\nJARFILE=xxx-0.0.1-SNAPSHOT.jar\n\nif [ ! -d $DIR/backup ];then\n   mkdir -p $DIR/backup\nfi\ncd $DIR\n\nps -ef | grep $JARFILE | grep -v grep | awk '{print $2}' | xargs kill -9\nmv $JARFILE backup/$JARFILE$DATE\nmv -f /root/Jenkins-in/$JARFILE .\n\njava -jar $JARFILE > out.log &\nif [ $? = 0 ];then\n        sleep 30\n        tail -n 50 out.log\nfi\n\ncd backup/\nls -lt|awk 'NR>5{print $NF}'|xargs rm -rf\n")])])]),e("p",[t._v("这段脚本的意思，就是 kill 旧项目，删除旧项目，启动新项目，备份老项目。")])])}),[],!1,null,null,null);s.default=r.exports}}]);