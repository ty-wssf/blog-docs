(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{461:function(a,t,s){"use strict";s.r(t);var e=s(30),r=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"nacos-server服务搭建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nacos-server服务搭建"}},[a._v("#")]),a._v(" nacos-server服务搭建")]),a._v(" "),s("ul",[s("li",[a._v("Nacos官方网站："),s("a",{attrs:{href:"https://nacos.io/zh-cn/",target:"_blank",rel:"noopener noreferrer"}},[a._v("nacos.io/zh-cn/"),s("OutboundLink")],1)])]),a._v(" "),s("h2",{attrs:{id:"什么是nacos"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是nacos"}},[a._v("#")]),a._v(" 什么是Nacos")]),a._v(" "),s("p",[a._v("Nacos是阿里巴巴开源的一个动态服务发现、配置管理和服务管理平台。")]),a._v(" "),s("p",[a._v("Nacos英文全称Dynamic Naming and Configuration Service，Na为naming/nameServer即注册中心,co为configuration即注册中心，service是指该注册/配置中心都是以服务为核心。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/df8d64edf9824d3ca4084a8a4b3099e1~tplv-k3u1fbpfcp-watermark.png",alt:"Nacos 生态图"}})]),a._v(" "),s("p",[a._v("Nacos 无缝支持一些主流的开源生态，使用Nacos，可以简化服务发现、配置管理、服务治理及管理。")]),a._v(" "),s("p",[a._v("如果要把Nacas和SpringCloud Netflix的组件对标的话，那么：")]),a._v(" "),s("p",[s("strong",[a._v("Nacos = Eureka/Consule + Config + Admin")])]),a._v(" "),s("h2",{attrs:{id:"nacos基本原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nacos基本原理"}},[a._v("#")]),a._v(" Nacos基本原理")]),a._v(" "),s("p",[a._v("Nacos作为注册中心分为server与client。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/2bf437f1db384be49fa8e898ac29b3fa~tplv-k3u1fbpfcp-watermark.png",alt:"Naocs Client与Server"}})]),a._v(" "),s("p",[a._v("Server采用Java编写，为client提供注册发现服务与配置服务。而client可以用多语言实现，client与微服务嵌套在一起，nacos提供sdk和openApi，如果没有sdk也可以根据openApi手动写服务注册与发现和配置拉取的逻辑。")]),a._v(" "),s("h3",{attrs:{id:"注册中心原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册中心原理"}},[a._v("#")]),a._v(" 注册中心原理")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/198ab7bf538c4b94b451cd0e11d74e0c~tplv-k3u1fbpfcp-watermark.png",alt:"注册中心原理"}})]),a._v(" "),s("p",[a._v("服务注册方法：服务注册的策略的是每5秒向nacos server发送一次心跳，心跳带上了服务名，服务ip，服务端口等信息。同时 nacos server也会向client 主动发起健康检查，支持tcp/http检查。如果15秒内无心跳且健康检查失败则认为实例不健康，如果30秒内健康检查失败则剔除实例。")]),a._v(" "),s("h3",{attrs:{id:"配置中心原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置中心原理"}},[a._v("#")]),a._v(" 配置中心原理")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/edb0b2d3d8ad4d52b44764f12b29d845~tplv-k3u1fbpfcp-watermark.png",alt:"配置中心原理"}})]),a._v(" "),s("h1",{attrs:{id:"nacos-server服务部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nacos-server服务部署"}},[a._v("#")]),a._v(" Nacos-Server服务部署")]),a._v(" "),s("p",[a._v("Nacos 依赖 "),s("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fcd%2FE19182-01%2F820-7851%2Finst_cli_jdk_javahome_t%2F",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java"),s("OutboundLink")],1),a._v(" 环境来运行。如果是从代码开始构建并运行Nacos，还需要配置 "),s("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fmaven.apache.org%2Findex.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Maven"),s("OutboundLink")],1),a._v("环境。我们直接使用发行版，需要保证JDK版本在1.8以上。")]),a._v(" "),s("p",[a._v("Nacos Server 有两种运行模式：")]),a._v(" "),s("ul",[s("li",[a._v("standalone")]),a._v(" "),s("li",[a._v("cluster")])]),a._v(" "),s("h2",{attrs:{id:"standalone-模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#standalone-模式"}},[a._v("#")]),a._v(" standalone 模式")]),a._v(" "),s("p",[a._v("我们使用win10来进行Nacos Server的standalone 模式的部署。")]),a._v(" "),s("ol",[s("li",[a._v("下载nacos-server")])]),a._v(" "),s("p",[a._v("从"),s("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fnacos%2Freleases",target:"_blank",rel:"noopener noreferrer"}},[a._v("github.com/alibaba/nac…"),s("OutboundLink")],1),a._v(" 下载nacos-server发行版。")]),a._v(" "),s("p",[a._v("官方推荐的版本是1.4.2或2.0.1。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d7a7f3a9c1b43ed9ed84085a33f42a2~tplv-k3u1fbpfcp-watermark.awebp",alt:"官方推荐"}})]),a._v(" "),s("p",[a._v("按照官方推荐，我们来尝（踩）鲜（坑）最新的发行版2.0.1，下载压缩包，下载完成后解压")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/d53f8217983e47fba0956632209f8d17~tplv-k3u1fbpfcp-watermark.png",alt:"Nacos下载解压"}})]),a._v(" "),s("ol",[s("li",[a._v("启动nacos-server服务")])]),a._v(" "),s("p",[a._v("进入%path%\\nacos\\bin文件夹,执行cmd命令"),s("code",[a._v("startup.cmd -m standalone")]),a._v("，其中-m standalone指定为单机模式，否则以cluster集群模式启动。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/831e0d6ce21f4a06b5a19d766f7f1a8d~tplv-k3u1fbpfcp-watermark.png",alt:"nacos-server启动"}})]),a._v(" "),s("p",[a._v("可以看到Nacos Server的地址，访问 "),s("a",{attrs:{href:"https://link.juejin.cn?target=http%3A%2F%2F192.168.31.39%3A8848%2Fnacos%2Findex.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://192.168.31.39:8848/nacos/index.html"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("需要登录，初始账号/密码是 "),s("code",[a._v("nacos/nacos")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/760e7ca5849846878826c21c5a438835~tplv-k3u1fbpfcp-watermark.png",alt:"Nacos登录"}})]),a._v(" "),s("p",[a._v("登录之后可以看到Nacos的控制台。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/670322ea4f944b0e98aedc5342bfdfe0~tplv-k3u1fbpfcp-watermark.png",alt:"Nacos控制台"}})]),a._v(" "),s("p",[a._v("Linux下部署Nacos-Server服务也是类似，同样是先解压发行压缩包，然后执行启动脚本启动：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("startup.sh -m standalone\n\n")])])]),s("p",[a._v("这种默认情况下，我们的数据写入了了嵌入式数据库。不太方便观察数据存储的情况，nacos也提供了支持mysql数据源的能力。")]),a._v(" "),s("blockquote",[s("p",[a._v("注意：以下操作我在2.0.1版本失败了，所以以下操作是基于1.4.2版本。")])]),a._v(" "),s("p",[a._v("MySQL数据库版本要求5.5以上。")]),a._v(" "),s("ol",[s("li",[a._v("创建数据库库，使用初始化文件"),s("code",[a._v("nacos-mysql.sql")]),a._v("初始化")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/423255cfa192454b82c8a18bc42def81~tplv-k3u1fbpfcp-watermark.png",alt:"初始化数据库"}})]),a._v(" "),s("ol",[s("li",[a._v("修改"),s("code",[a._v("conf/application.properties")]),a._v("文件，增加支持mysql数据源配置（目前只支持mysql），修改mysql数据源的url、用户名和密码。")])]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("spring"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("datasource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("platform"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mysql\n\n### "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Count")]),a._v(" of DB"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("num"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n\n### "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Connect")]),a._v(" URL of DB"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("jdbc"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3306")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("nacos"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("?")]),a._v("characterEncoding"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("utf8"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("connectTimeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("socketTimeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("autoReconnect"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("useUnicode"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("useSSL"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("serverTimezone"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("UTC\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root\n\n### "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Connection")]),a._v(" pool configuration"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" hikariCP\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("pool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("connectionTimeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("30000")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("pool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("validationTimeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10000")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("pool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("maximumPoolSize"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("20")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("pool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("minimumIdle"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\n")])])]),s("ol",[s("li",[a._v("使用命令"),s("code",[a._v("startup.cmd -m standalone")]),a._v("启动Nacos Server")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/f6d216f253354f348984df69c143d716~tplv-k3u1fbpfcp-watermark.png",alt:"使用MySQL存储Nacos数据示例"}})]),a._v(" "),s("h2",{attrs:{id:"cluster-模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cluster-模式"}},[a._v("#")]),a._v(" cluster 模式")]),a._v(" "),s("p",[a._v("开发和测试，我们直接用standalone 模式，OK，没什么问题。但是生产环境，为了保证Nacos的高可用，我们就得使用 cluster模式。")]),a._v(" "),s("p",[a._v("cluster 模式必须要用 MySQL，MySQL数据导入和上面一致，然后改两个配置文件：")]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("conf"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("cluster"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("conf\nconf"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("application"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("properties\n\n")])])]),s("p",[a._v("大致如下：")]),a._v(" "),s("ol",[s("li",[a._v("cluster.conf，填入要运行 Nacos Server 机器的 ip")])]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".100")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".155")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".100")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".156")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".100")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".157")]),a._v("    \n\n")])])]),s("ol",[s("li",[a._v("修改NACOS_PATH/conf/application.properties，加入 MySQL 配置")])]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("num"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("jdbc"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("localhost"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3306")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("nacos_config"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("?")]),a._v("characterEncoding"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("utf8"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("connectTimeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("socketTimeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("autoReconnect"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("user"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("password"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root\n\n")])])]),s("p",[a._v("Nacos采用的一个Leader节点，多个Follower节点的集群架构，数据一致性算法采用的是Raft。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/e32a0b72bcb447799ecc550abee01b3e~tplv-k3u1fbpfcp-watermark.png",alt:"nacos集群示意图"}})]),a._v(" "),s("p",[a._v("至于实战，由于机器资源资源原因，这里就不再演示。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/wuyilong/picture-bed/raw/master/img/5a57a55df5864e019517f3ce06df0421~tplv-k3u1fbpfcp-watermark.png",alt:"穷"}})]),a._v(" "),s("p",[a._v("下一节，我们会把服务注册到Nacos注册中心，敬请期待！")]),a._v(" "),s("p",[a._v("作者：三分恶\n链接：https://juejin.cn/post/6976108108787482655\n来源：掘金\n著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。")])])}),[],!1,null,null,null);t.default=r.exports}}]);