<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security源码解析 | 吴益龙的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="吴益龙的博客">
    
    <link rel="preload" href="/blog-docs/assets/css/0.styles.51dfe6fe.css" as="style"><link rel="preload" href="/blog-docs/assets/js/app.8540afd8.js" as="script"><link rel="preload" href="/blog-docs/assets/js/2.d20fb779.js" as="script"><link rel="preload" href="/blog-docs/assets/js/140.2b733f65.js" as="script"><link rel="prefetch" href="/blog-docs/assets/js/10.ce89d165.js"><link rel="prefetch" href="/blog-docs/assets/js/100.ead7e371.js"><link rel="prefetch" href="/blog-docs/assets/js/101.7a7619df.js"><link rel="prefetch" href="/blog-docs/assets/js/102.20346e15.js"><link rel="prefetch" href="/blog-docs/assets/js/103.64b30ebc.js"><link rel="prefetch" href="/blog-docs/assets/js/104.522b4976.js"><link rel="prefetch" href="/blog-docs/assets/js/105.74b26057.js"><link rel="prefetch" href="/blog-docs/assets/js/106.7e839b9a.js"><link rel="prefetch" href="/blog-docs/assets/js/107.eb23121d.js"><link rel="prefetch" href="/blog-docs/assets/js/108.8a32a2e5.js"><link rel="prefetch" href="/blog-docs/assets/js/109.6be0c37b.js"><link rel="prefetch" href="/blog-docs/assets/js/11.7af1ea0e.js"><link rel="prefetch" href="/blog-docs/assets/js/110.238cb720.js"><link rel="prefetch" href="/blog-docs/assets/js/111.3e99f827.js"><link rel="prefetch" href="/blog-docs/assets/js/112.eb22a5fa.js"><link rel="prefetch" href="/blog-docs/assets/js/113.de1dd438.js"><link rel="prefetch" href="/blog-docs/assets/js/114.4581bf91.js"><link rel="prefetch" href="/blog-docs/assets/js/115.fbeac0d9.js"><link rel="prefetch" href="/blog-docs/assets/js/116.67ec9709.js"><link rel="prefetch" href="/blog-docs/assets/js/117.79d7c802.js"><link rel="prefetch" href="/blog-docs/assets/js/118.1f537ce0.js"><link rel="prefetch" href="/blog-docs/assets/js/119.3ebcb7db.js"><link rel="prefetch" href="/blog-docs/assets/js/12.5f02203f.js"><link rel="prefetch" href="/blog-docs/assets/js/120.2d112561.js"><link rel="prefetch" href="/blog-docs/assets/js/121.fe7b63ad.js"><link rel="prefetch" href="/blog-docs/assets/js/122.f73684d2.js"><link rel="prefetch" href="/blog-docs/assets/js/123.719ba570.js"><link rel="prefetch" href="/blog-docs/assets/js/124.6298f285.js"><link rel="prefetch" href="/blog-docs/assets/js/125.b2902409.js"><link rel="prefetch" href="/blog-docs/assets/js/126.12319946.js"><link rel="prefetch" href="/blog-docs/assets/js/127.a81472d8.js"><link rel="prefetch" href="/blog-docs/assets/js/128.c2787c56.js"><link rel="prefetch" href="/blog-docs/assets/js/129.6b3a41be.js"><link rel="prefetch" href="/blog-docs/assets/js/13.7c743478.js"><link rel="prefetch" href="/blog-docs/assets/js/130.1b5d965f.js"><link rel="prefetch" href="/blog-docs/assets/js/131.bd76e1d1.js"><link rel="prefetch" href="/blog-docs/assets/js/132.f937896b.js"><link rel="prefetch" href="/blog-docs/assets/js/133.f3cc98a9.js"><link rel="prefetch" href="/blog-docs/assets/js/134.530efb7d.js"><link rel="prefetch" href="/blog-docs/assets/js/135.d668b1c5.js"><link rel="prefetch" href="/blog-docs/assets/js/136.e3fa82ba.js"><link rel="prefetch" href="/blog-docs/assets/js/137.61e88439.js"><link rel="prefetch" href="/blog-docs/assets/js/138.07a7ea2b.js"><link rel="prefetch" href="/blog-docs/assets/js/139.867a32e4.js"><link rel="prefetch" href="/blog-docs/assets/js/14.ba2733bb.js"><link rel="prefetch" href="/blog-docs/assets/js/141.556a5bcb.js"><link rel="prefetch" href="/blog-docs/assets/js/142.2ca73758.js"><link rel="prefetch" href="/blog-docs/assets/js/143.88d05133.js"><link rel="prefetch" href="/blog-docs/assets/js/144.6381db40.js"><link rel="prefetch" href="/blog-docs/assets/js/145.7b91c410.js"><link rel="prefetch" href="/blog-docs/assets/js/146.ef447713.js"><link rel="prefetch" href="/blog-docs/assets/js/147.292d3f0c.js"><link rel="prefetch" href="/blog-docs/assets/js/148.d2280eae.js"><link rel="prefetch" href="/blog-docs/assets/js/149.06a2add4.js"><link rel="prefetch" href="/blog-docs/assets/js/15.5b47152f.js"><link rel="prefetch" href="/blog-docs/assets/js/150.bbfea0e7.js"><link rel="prefetch" href="/blog-docs/assets/js/151.5418de67.js"><link rel="prefetch" href="/blog-docs/assets/js/152.63ee28ad.js"><link rel="prefetch" href="/blog-docs/assets/js/153.c8327d38.js"><link rel="prefetch" href="/blog-docs/assets/js/154.e28b7778.js"><link rel="prefetch" href="/blog-docs/assets/js/155.2ef06949.js"><link rel="prefetch" href="/blog-docs/assets/js/156.ca021dfd.js"><link rel="prefetch" href="/blog-docs/assets/js/157.585973f7.js"><link rel="prefetch" href="/blog-docs/assets/js/158.d9144f9c.js"><link rel="prefetch" href="/blog-docs/assets/js/159.1ae8e842.js"><link rel="prefetch" href="/blog-docs/assets/js/16.5c1ff9fb.js"><link rel="prefetch" href="/blog-docs/assets/js/160.bd59a846.js"><link rel="prefetch" href="/blog-docs/assets/js/161.9a8b09d5.js"><link rel="prefetch" href="/blog-docs/assets/js/162.7f0e64aa.js"><link rel="prefetch" href="/blog-docs/assets/js/163.70999779.js"><link rel="prefetch" href="/blog-docs/assets/js/164.4dc9b207.js"><link rel="prefetch" href="/blog-docs/assets/js/165.0955e3e4.js"><link rel="prefetch" href="/blog-docs/assets/js/166.d4c3997a.js"><link rel="prefetch" href="/blog-docs/assets/js/167.01a7767a.js"><link rel="prefetch" href="/blog-docs/assets/js/168.34177aba.js"><link rel="prefetch" href="/blog-docs/assets/js/169.b604228c.js"><link rel="prefetch" href="/blog-docs/assets/js/17.9e3fb97a.js"><link rel="prefetch" href="/blog-docs/assets/js/18.78ccb707.js"><link rel="prefetch" href="/blog-docs/assets/js/19.288e2506.js"><link rel="prefetch" href="/blog-docs/assets/js/20.4bbf35de.js"><link rel="prefetch" href="/blog-docs/assets/js/21.66a3f7e9.js"><link rel="prefetch" href="/blog-docs/assets/js/22.53103f80.js"><link rel="prefetch" href="/blog-docs/assets/js/23.7d3b191c.js"><link rel="prefetch" href="/blog-docs/assets/js/24.3e1c653d.js"><link rel="prefetch" href="/blog-docs/assets/js/25.72b659bd.js"><link rel="prefetch" href="/blog-docs/assets/js/26.79a9eade.js"><link rel="prefetch" href="/blog-docs/assets/js/27.a4f0209b.js"><link rel="prefetch" href="/blog-docs/assets/js/28.bc36032c.js"><link rel="prefetch" href="/blog-docs/assets/js/29.77ec583b.js"><link rel="prefetch" href="/blog-docs/assets/js/3.1291babf.js"><link rel="prefetch" href="/blog-docs/assets/js/30.ffca4ac6.js"><link rel="prefetch" href="/blog-docs/assets/js/31.005446e8.js"><link rel="prefetch" href="/blog-docs/assets/js/32.c4bf0cce.js"><link rel="prefetch" href="/blog-docs/assets/js/33.7c9331d1.js"><link rel="prefetch" href="/blog-docs/assets/js/34.c0827e26.js"><link rel="prefetch" href="/blog-docs/assets/js/35.6f50269a.js"><link rel="prefetch" href="/blog-docs/assets/js/36.34976541.js"><link rel="prefetch" href="/blog-docs/assets/js/37.0b7d15c6.js"><link rel="prefetch" href="/blog-docs/assets/js/38.931d2ddc.js"><link rel="prefetch" href="/blog-docs/assets/js/39.2a8d35ff.js"><link rel="prefetch" href="/blog-docs/assets/js/4.04ab9679.js"><link rel="prefetch" href="/blog-docs/assets/js/40.4aa9327a.js"><link rel="prefetch" href="/blog-docs/assets/js/41.2dffb318.js"><link rel="prefetch" href="/blog-docs/assets/js/42.9c456f1a.js"><link rel="prefetch" href="/blog-docs/assets/js/43.6d2a19a3.js"><link rel="prefetch" href="/blog-docs/assets/js/44.18cb6971.js"><link rel="prefetch" href="/blog-docs/assets/js/45.ecd9f4d0.js"><link rel="prefetch" href="/blog-docs/assets/js/46.626ba871.js"><link rel="prefetch" href="/blog-docs/assets/js/47.e8ebb045.js"><link rel="prefetch" href="/blog-docs/assets/js/48.881dade0.js"><link rel="prefetch" href="/blog-docs/assets/js/49.5594ab03.js"><link rel="prefetch" href="/blog-docs/assets/js/5.1873b179.js"><link rel="prefetch" href="/blog-docs/assets/js/50.bcd443d4.js"><link rel="prefetch" href="/blog-docs/assets/js/51.8c84becb.js"><link rel="prefetch" href="/blog-docs/assets/js/52.ee31a612.js"><link rel="prefetch" href="/blog-docs/assets/js/53.ef72ee44.js"><link rel="prefetch" href="/blog-docs/assets/js/54.ada4baf0.js"><link rel="prefetch" href="/blog-docs/assets/js/55.310a1b2a.js"><link rel="prefetch" href="/blog-docs/assets/js/56.dabb55ad.js"><link rel="prefetch" href="/blog-docs/assets/js/57.57be9686.js"><link rel="prefetch" href="/blog-docs/assets/js/58.bc2af85c.js"><link rel="prefetch" href="/blog-docs/assets/js/59.57695909.js"><link rel="prefetch" href="/blog-docs/assets/js/6.ffc21dda.js"><link rel="prefetch" href="/blog-docs/assets/js/60.e1469407.js"><link rel="prefetch" href="/blog-docs/assets/js/61.28a5ef7a.js"><link rel="prefetch" href="/blog-docs/assets/js/62.65746977.js"><link rel="prefetch" href="/blog-docs/assets/js/63.9385a046.js"><link rel="prefetch" href="/blog-docs/assets/js/64.4c58f8cb.js"><link rel="prefetch" href="/blog-docs/assets/js/65.f5def24f.js"><link rel="prefetch" href="/blog-docs/assets/js/66.edcbb351.js"><link rel="prefetch" href="/blog-docs/assets/js/67.a9580d80.js"><link rel="prefetch" href="/blog-docs/assets/js/68.d349e673.js"><link rel="prefetch" href="/blog-docs/assets/js/69.f89e0ad1.js"><link rel="prefetch" href="/blog-docs/assets/js/7.604f2cf3.js"><link rel="prefetch" href="/blog-docs/assets/js/70.d8037a02.js"><link rel="prefetch" href="/blog-docs/assets/js/71.2c659dbc.js"><link rel="prefetch" href="/blog-docs/assets/js/72.30ff712e.js"><link rel="prefetch" href="/blog-docs/assets/js/73.d6124c43.js"><link rel="prefetch" href="/blog-docs/assets/js/74.b368add8.js"><link rel="prefetch" href="/blog-docs/assets/js/75.710c78a6.js"><link rel="prefetch" href="/blog-docs/assets/js/76.d02af389.js"><link rel="prefetch" href="/blog-docs/assets/js/77.772d7877.js"><link rel="prefetch" href="/blog-docs/assets/js/78.acdf1204.js"><link rel="prefetch" href="/blog-docs/assets/js/79.3841a692.js"><link rel="prefetch" href="/blog-docs/assets/js/8.02188626.js"><link rel="prefetch" href="/blog-docs/assets/js/80.9f8115b4.js"><link rel="prefetch" href="/blog-docs/assets/js/81.454cfc40.js"><link rel="prefetch" href="/blog-docs/assets/js/82.c9501ea9.js"><link rel="prefetch" href="/blog-docs/assets/js/83.d1f8f4b2.js"><link rel="prefetch" href="/blog-docs/assets/js/84.1a4e4481.js"><link rel="prefetch" href="/blog-docs/assets/js/85.8b5062bd.js"><link rel="prefetch" href="/blog-docs/assets/js/86.c2c231b6.js"><link rel="prefetch" href="/blog-docs/assets/js/87.11d0bd52.js"><link rel="prefetch" href="/blog-docs/assets/js/88.570ca5e4.js"><link rel="prefetch" href="/blog-docs/assets/js/89.b78d36e0.js"><link rel="prefetch" href="/blog-docs/assets/js/9.5585259d.js"><link rel="prefetch" href="/blog-docs/assets/js/90.55d0d283.js"><link rel="prefetch" href="/blog-docs/assets/js/91.d1b21ad6.js"><link rel="prefetch" href="/blog-docs/assets/js/92.77128d92.js"><link rel="prefetch" href="/blog-docs/assets/js/93.049b7031.js"><link rel="prefetch" href="/blog-docs/assets/js/94.7288d09b.js"><link rel="prefetch" href="/blog-docs/assets/js/95.14f41657.js"><link rel="prefetch" href="/blog-docs/assets/js/96.1586307c.js"><link rel="prefetch" href="/blog-docs/assets/js/97.7fae0f0e.js"><link rel="prefetch" href="/blog-docs/assets/js/98.fab6426d.js"><link rel="prefetch" href="/blog-docs/assets/js/99.a9e1819c.js">
    <link rel="stylesheet" href="/blog-docs/assets/css/0.styles.51dfe6fe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog-docs/" class="home-link router-link-active"><!----> <span class="site-name">吴益龙的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog-docs/install/" class="nav-link">
  安装文档
</a></div><div class="nav-item"><a href="/blog-docs/technology/前端/jQuery中封装ajax请求/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog-docs/technology/Rust/Rust编程语言入门/" class="nav-link">
  Rust编程语言
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="java" class="dropdown-title"><span class="title">java</span> <span class="arrow down"></span></button> <button type="button" aria-label="java" class="mobile-dropdown-title"><span class="title">java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/spring/Spring IOC/SpringBean的生命流程/" class="nav-link">
  Spring专题
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/SpringBoot专题/" class="nav-link">
  SpringBoot专题
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security oAuth2/" class="nav-link">
  基于OAuth2.0的统一身份认证中心
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/SpingCloud Alibaba实战/微服务与SpringCloud Alibaba/" class="nav-link">
  SpingCloud Alibaba实战
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/MyBatis/MyBatis 源码分析系列文章导读/" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/Dubbo/Dubbo 源码分析 - SPI 机制/" class="nav-link">
  Dubbo
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/Docker/Docker入门教程/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/Jvm系列/Java类的加载机制/" class="nav-link">
  Jvm系列
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/thread/基础知识/并发编程的优缺点/" class="nav-link">
  高并发
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/算法/Java手写二叉搜索树算法/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/查缺补漏/Java面试题基础系列228道/" class="nav-link">
  查缺补漏
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/other/基于canal的mysql数据同步/" class="nav-link">
  其它
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          在线编辑
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://app.diagrams.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在线图表编辑工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.aconvert.com/cn/image/webp-to-jpg/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  WEBP转JPG - 在线转换图像文件
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://smallpdf.com/cn/pdf-to-word" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF 转换器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.json.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JSON 编辑器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://tableconvert.com/?output=text" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MD 表格生成
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://cron.qqe2.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CRON 表达式
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://tool.oschina.net/codeformat/html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  代码格式化
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://cli.im/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  二维码生成器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="http://tool.chinaz.com/tools/native_ascii.aspx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在线编码转换
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.toyaml.com/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  YAML &lt;--&gt; Properties
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JWT解码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          客户端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.devart.com/dbforge/mysql/studio/download.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dbForge Studio for MySQL
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          趋势分析
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://index.baidu.com/v2/index.html#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度指数
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用网站" class="dropdown-title"><span class="title">常用网站</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用网站" class="mobile-dropdown-title"><span class="title">常用网站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.moyundong.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  牛魔王的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.tianxiaobo.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  田小波的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://funtl.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  千锋教育-李卫民
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://segmentfault.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  segmentfault技术社区
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://andyboke.blog.csdn.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  安迪源文
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://gitee.com/wuyilong/blog-docs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ty-wssf/blog-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog-docs/install/" class="nav-link">
  安装文档
</a></div><div class="nav-item"><a href="/blog-docs/technology/前端/jQuery中封装ajax请求/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog-docs/technology/Rust/Rust编程语言入门/" class="nav-link">
  Rust编程语言
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="java" class="dropdown-title"><span class="title">java</span> <span class="arrow down"></span></button> <button type="button" aria-label="java" class="mobile-dropdown-title"><span class="title">java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/spring/Spring IOC/SpringBean的生命流程/" class="nav-link">
  Spring专题
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/SpringBoot专题/" class="nav-link">
  SpringBoot专题
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security oAuth2/" class="nav-link">
  基于OAuth2.0的统一身份认证中心
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/SpingCloud Alibaba实战/微服务与SpringCloud Alibaba/" class="nav-link">
  SpingCloud Alibaba实战
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/MyBatis/MyBatis 源码分析系列文章导读/" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/Dubbo/Dubbo 源码分析 - SPI 机制/" class="nav-link">
  Dubbo
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/Docker/Docker入门教程/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/Jvm系列/Java类的加载机制/" class="nav-link">
  Jvm系列
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/thread/基础知识/并发编程的优缺点/" class="nav-link">
  高并发
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/算法/Java手写二叉搜索树算法/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/查缺补漏/Java面试题基础系列228道/" class="nav-link">
  查缺补漏
</a></li><li class="dropdown-item"><!----> <a href="/blog-docs/technology/java/other/基于canal的mysql数据同步/" class="nav-link">
  其它
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          在线编辑
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://app.diagrams.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在线图表编辑工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.aconvert.com/cn/image/webp-to-jpg/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  WEBP转JPG - 在线转换图像文件
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://smallpdf.com/cn/pdf-to-word" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF 转换器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.json.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JSON 编辑器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://tableconvert.com/?output=text" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MD 表格生成
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://cron.qqe2.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CRON 表达式
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://tool.oschina.net/codeformat/html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  代码格式化
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://cli.im/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  二维码生成器
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="http://tool.chinaz.com/tools/native_ascii.aspx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在线编码转换
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://www.toyaml.com/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  YAML &lt;--&gt; Properties
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JWT解码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          客户端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.devart.com/dbforge/mysql/studio/download.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dbForge Studio for MySQL
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          趋势分析
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://index.baidu.com/v2/index.html#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度指数
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用网站" class="dropdown-title"><span class="title">常用网站</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用网站" class="mobile-dropdown-title"><span class="title">常用网站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.moyundong.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  牛魔王的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.tianxiaobo.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  田小波的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://funtl.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  千锋教育-李卫民
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://segmentfault.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  segmentfault技术社区
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://andyboke.blog.csdn.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  安迪源文
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://gitee.com/wuyilong/blog-docs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ty-wssf/blog-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基于OAuth2.0的统一身份认证中心</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security oAuth2.html" class="sidebar-link">Spring Security oAuth2</a></li><li><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html" class="active sidebar-link">Spring Security源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#安全相关filter清单" class="sidebar-link">安全相关Filter清单</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#webasyncmanagerintegrationfilter" class="sidebar-link">WebAsyncManagerIntegrationFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#securitycontextpersistencefilter" class="sidebar-link">SecurityContextPersistenceFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#headerwriterfilter" class="sidebar-link">HeaderWriterFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#csrffilter" class="sidebar-link">CsrfFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#logoutfilter" class="sidebar-link">LogoutFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#usernamepasswordauthenticationfilter" class="sidebar-link">UsernamePasswordAuthenticationFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#defaultloginpagegeneratingfilter" class="sidebar-link">DefaultLoginPageGeneratingFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#defaultlogoutpagegeneratingfilter" class="sidebar-link">DefaultLogoutPageGeneratingFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#basicauthenticationfilter" class="sidebar-link">BasicAuthenticationFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#requestcacheawarefilter" class="sidebar-link">RequestCacheAwareFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#securitycontextholderawarerequestfilter" class="sidebar-link">SecurityContextHolderAwareRequestFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#remembermeauthenticationfilter" class="sidebar-link">RememberMeAuthenticationFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#anonymousauthenticationfilter" class="sidebar-link">AnonymousAuthenticationFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#sessionmanagementfilter" class="sidebar-link">SessionManagementFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#exceptiontranslationfilter" class="sidebar-link">ExceptionTranslationFilter</a></li><li class="sidebar-sub-header"><a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.html#filtersecurityinterceptor" class="sidebar-link">FilterSecurityInterceptor</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-security源码解析"><a href="#spring-security源码解析" class="header-anchor">#</a> Spring Security源码解析</h1> <h2 id="安全相关filter清单"><a href="#安全相关filter清单" class="header-anchor">#</a> 安全相关Filter清单</h2> <table><thead><tr><th>名称</th> <th>简介</th></tr></thead> <tbody><tr><td>WebAsyncManagerIntegrationFilter</td> <td>为请求处理过程中可能发生的异步调用准备安全上下文获取途径</td></tr> <tr><td>SecurityContextPersistenceFilter</td> <td>整个请求处理过程所需的安全上下文对象SecurityContext的准备和清理<br>不管请求是否针对需要登录才能访问的页面，这里都会确保SecurityContextHolder中出现一个SecurityContext对象:<br>1.未登录状态访问登录保护页面:空SecurityContext对象，所含Authentication为null<br>2.登录状态访问某个页面:从SecurityContextRepository获取的SecurityContext对象&lt;br/</td></tr> <tr><td>HeaderWriterFilter</td> <td>将指定的头部信息写入响应对象</td></tr> <tr><td>CsrfFilter</td> <td>对请求进行csrf保护</td></tr> <tr><td>LogoutFilter</td> <td>检测用户退出登录请求并做相应退出登录处理</td></tr> <tr><td>UsernamePasswordAuthenticationFilter</td> <td>检测用户名/密码表单登录认证请求并作相应认证处理:<br>  1.session管理，比如为新登录用户创建新session(session fixation防护)和设置新的csrf token等<br>  2.经过完全认证的Authentication对象设置到SecurityContextHolder中的SecurityContext上;<br>  3.发布登录认证成功事件InteractiveAuthenticationSuccessEvent<br>  4.登录认证成功时的Remember Me处理<br>  5.登录认证成功时的页面跳转&lt;br/</td></tr> <tr><td>DefaultLoginPageGeneratingFilter</td> <td>生成缺省的登录页面</td></tr> <tr><td>DefaultLogoutPageGeneratingFilter</td> <td>生成缺省的退出登录页面</td></tr> <tr><td>BasicAuthenticationFilter</td> <td>检测和处理http basic认证</td></tr> <tr><td>RequestCacheAwareFilter</td> <td>提取请求缓存中缓存的请求<br>1.请求缓存在安全机制启动时指定<br>2.请求写入缓存在其他地方完成<br>3.典型应用场景:<br>    1.用户请求保护的页面，<br>    2.系统引导用户完成登录认证,<br>    3.然后自动跳转到到用户最初请求页面</td></tr> <tr><td>SecurityContextHolderAwareRequestFilter</td> <td>包装请求对象使之可以访问SecurityContextHolder,从而使请求真正意义上拥有接口HttpServletRequest中定义的getUserPrincipal这种访问安全信息的能力</td></tr> <tr><td>RememberMeAuthenticationFilter</td> <td>针对Remember Me登录认证机制的处理逻辑</td></tr> <tr><td>AnonymousAuthenticationFilter</td> <td>如果当前SecurityContext属性Authentication为null，将其替换为一个AnonymousAuthenticationToken</td></tr> <tr><td>SessionManagementFilter</td> <td>检测从请求处理开始到目前是否有用户登录认证，如果有做相应的session管理，比如针对为新登录用户创建新的session(session fixation防护)和设置新的csrf token等。</td></tr> <tr><td>ExceptionTranslationFilter</td> <td>处理AccessDeniedException和 AuthenticationException异常，将它们转换成相应的HTTP响应</td></tr> <tr><td>FilterSecurityInterceptor</td> <td>一个请求处理的安全处理过滤器链的最后一个，检查用户是否已经认证,如果未认证执行必要的认证，对目标资源的权限检查，如果认证或者权限不足，抛出相应的异常:AccessDeniedException或者AuthenticationException</td></tr> <tr><td></td> <td></td></tr></tbody></table> <p><strong>注意 :</strong></p> <ul><li><p>上面的Filter并不总是同时被起用，根据配置的不同，会启用不同的Filter。</p></li> <li><p>对于被起用的Filter，在对一个请求进行处理时，位于以上表格上部的过滤器先被调用。</p></li> <li><p>上面的Filter被启用时并不是直接添加到Servlet容器的Filter chain中,而是先被组织成一个FilterChainProxy, 然后这个Filter会被添加到Servlet容器的Filter chain中。</p> <blockquote><p>FilterChainProxy也是一个Filter,它应用了代理模式和组合模式，它将上面的各个Filter组织到一起在自己内部形成一个filter chain,当自己被调用到时，它其实把任务代理给自己内部的filter chain完成。</p></blockquote></li> <li><p>上面的Spring Security Filter被组合到一个FilterChainProxy的过程可以参考配置类WebSecurityConfiguration的方法Filter springSecurityFilterChain(),这是一个bean定义方法，使用的bean名称为AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME:springSecurityFilterChain。</p></li></ul> <h3 id="webasyncmanagerintegrationfilter"><a href="#webasyncmanagerintegrationfilter" class="header-anchor">#</a> WebAsyncManagerIntegrationFilter</h3> <h4 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h4> <p>此过滤器用于集成<code>SecurityContext</code>到<code>Spring</code>异步执行机制中的<code>WebAsyncManager</code>。</p> <h4 id="源代码解析"><a href="#源代码解析" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 此过滤器用于集成SecurityContext到Spring异步执行机制中的WebAsyncManager。</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WebAsyncManagerIntegrationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> CALLABLE_INTERCEPTOR_KEY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从请求属性上获取所绑定的`WebAsyncManager`，如果尚未绑定，先做绑定</span>
        <span class="token comment">// 相应的属性名称为 :</span>
        <span class="token comment">// org.springframework.web.context.request.async.WebAsyncManager.WEB_ASYNC_MANAGER</span>
        <span class="token class-name">WebAsyncManager</span> asyncManager <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 从 asyncManager 中获取 key 为 CALLABLE_INTERCEPTOR_KEY 的</span>
        <span class="token comment">//  SecurityContextCallableProcessingInterceptor,  如果获取到的为 null，</span>
        <span class="token comment">// 说明其中还没有 key 为 CALLABLE_INTERCEPTOR_KEY 的</span>
        <span class="token comment">// SecurityContextCallableProcessingInterceptor, 新建一个并使用该 key</span>
        <span class="token comment">// 注册上去</span>
        <span class="token class-name">SecurityContextCallableProcessingInterceptor</span> securityProcessingInterceptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">)</span> asyncManager
                <span class="token punctuation">.</span><span class="token function">getCallableInterceptor</span><span class="token punctuation">(</span>CALLABLE_INTERCEPTOR_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>securityProcessingInterceptor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里新建的 SecurityContextCallableProcessingInterceptor 实现了</span>
            <span class="token comment">// 接口 CallableProcessingInterceptor，当它被应用于一次异步执行时，</span>
            <span class="token comment">// 它的方法beforeConcurrentHandling() 会在调用者线程执行，该方法</span>
            <span class="token comment">// 会相应地从当前线程获取SecurityContext,然后被调用者线程中执行设计的</span>
            <span class="token comment">// 逻辑时，会使用这个SecurityContext，从而实现安全上下文从调用者线程</span>
            <span class="token comment">// 到被调用者线程的传播</span>
            asyncManager<span class="token punctuation">.</span><span class="token function">registerCallableInterceptor</span><span class="token punctuation">(</span>CALLABLE_INTERCEPTOR_KEY<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 上面是本过滤器的职责逻辑:为整个请求处理过程中可能的异步处理做安全上下文相关的</span>
        <span class="token comment">// 准备。现在该任务已经完成，继续 filter chain 的调用。</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="securitycontextpersistencefilter"><a href="#securitycontextpersistencefilter" class="header-anchor">#</a> SecurityContextPersistenceFilter</h3> <p>####概述
<strong><code>SecurityContextPersistenceFilter</code>有两个主要任务:</strong></p> <ol><li>在请求到达时处理之前，从<code>SecurityContextRepository</code>中获取安全上下文信息填充到<code>SecurityContextHolder;</code></li> <li>在请求处理结束后返回响应时，将SecurityContextHolder中的安全上下文信息保存回SecurityContextRepository,并清空SecurityContextHolder。</li></ol> <p>通过SecurityContextPersistenceFilter的这种机制，在整个请求处理过程中，开发人员都可以通过使用SecurityContextHolder获取当前访问用户的安全上下文信息。</p> <blockquote><p>缺省情况下，SecurityContextPersistenceFilter使用的SecurityContextRepository是HttpSessionSecurityContextRepository，也就是将安全上下文的信息保存在用户的会话中。</p></blockquote> <p>为了解决不同Serlvet容器上，尤其是weblogic上的兼容性问题，此Filter必须在整个request处理过程中被调用最多一次。</p> <p>该Filter也必须在任何认证机制逻辑发生之前被调用。因为这些认证机制都依赖于SecurityContextHolder所包含的安全上下文对象。</p> <h4 id="源代码解析-2"><a href="#源代码解析-2" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextPersistenceFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

    <span class="token comment">// 确保该Filter在一个request处理过程中最多被调到用一次的机制：</span>
    <span class="token comment">// 一旦该Fitler被调用过，他会在当前request增加该属性值为true，利用此标记</span>
    <span class="token comment">// 可以避免Filter被调用二次。</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FILTER_APPLIED <span class="token operator">=</span> <span class="token string">&quot;__spring_security_scpf_applied&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 安全上下文存储库</span>
    <span class="token keyword">private</span> <span class="token class-name">SecurityContextRepository</span> repo<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> forceEagerSessionCreation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 缺省使用http session 作为安全上下文对象存储</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> repo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>repo <span class="token operator">=</span> repo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ensure that filter is only applied once per request</span>
            <span class="token comment">// 检查调用标志，如果request上已经存在属性FILTER_APPLIED,</span>
            <span class="token comment">// 表明该Filter在该request的处理过程中已经被调用过</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> debug <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置该Filter已经被调用的标记</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceEagerSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug <span class="token operator">&amp;&amp;</span> session<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly created session: &quot;</span> <span class="token operator">+</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">HttpRequestResponseHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从安全上下文存储库(缺省是http session)中读取安全上下文对象</span>
        <span class="token class-name">SecurityContext</span> contextBeforeChainExecution <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置安全上下文对象到SecurityContextHolder然后才继续Filter chain的调用</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>

            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">SecurityContext</span> contextAfterChainExecution <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span>
                    <span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Crucial removal of SecurityContextHolder contents - do this before anything</span>
            <span class="token comment">// else.</span>
            <span class="token comment">// 当前请求已经被处理完成了，清除SecurityContextHolder并将最新的</span>
            <span class="token comment">// 安全上下文对象保存回安全上下文存储库(缺省是http session)</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            repo<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>contextAfterChainExecution<span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityContextHolder now cleared, as request processing completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setForceEagerSessionCreation</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceEagerSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>forceEagerSessionCreation <span class="token operator">=</span> forceEagerSessionCreation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="headerwriterfilter"><a href="#headerwriterfilter" class="header-anchor">#</a> HeaderWriterFilter</h3> <h4 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h4> <p><code>Spring Securty</code> 使用该<code>Filter</code>在一个请求的处理过程中为响应对象增加一些头部信息。头部信息由外部提供，比如用于增加一些浏览器保护的头部，比如<code>X-Frame-Options,</code> <code>X-XSS-Protection</code>和<code>X-Content-Type-Options</code>等。</p> <p>具体的做法是在请求到达的时候将传入的响应对象包装成一个具有头部写入能力的<code>HeaderWriterResponse</code>对象，<code>HeaderWriterResponse</code>所具备的头部写入能力是这样的 :</p> <ol><li><p><code>HeaderWriterResponse</code> 继承自 <code>OnCommittedResponseWrapper</code> <code>OnCommittedResponseWrapper</code>会检测<code>response commit</code>,在这之前调用特定方法<code>onResponseCommitted</code>；</p> <blockquote><p>response commit 通常发生在include, redirect, sendError, flushBuffer这些事情发生时。</p></blockquote></li> <li><p>HeaderWriterResponse实现onResponseCommitted方法，该方法用于将指定的头部信息写入响应;</p></li> <li><p>HeaderWriterResponse实现了一个writeHeaders方法，该方法用于将指定的头部信息写入响应；</p></li></ol> <p>因为具备了上述能力，所以一旦在请求处理过程中检测到<code>response commit</code>,<code>onResponseCommitted</code>会被调用，
如果没有检测到<code>response commit</code>,程序再次回到当前Filter时，它会主动调用<code>HeaderWriterResponse#writeHeaders</code>
将头部信息写入响应。</p> <p>把头部信息写入响应的动作不会被执行超过一次，因为<code>onResponseCommitted</code>,<code>writeHeaders</code>方法都会检测一个头部信息是否已经写入的标记(具体请参考下面的源代码解析)。</p> <h4 id="源代码解析-3"><a href="#源代码解析-3" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderWriterFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Collection of  HeaderWriter instances to write out the headers to the
     * response.
     * 将要写入响应头部的头部写入器，注意，这里不是直接提供头部信息让该Filter自己写入响应头部，
     * 而是委托给各个头部写入器HeaderWriter完成，当前Filter并不关心每个头部信息如何写入的细节。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates a new instance. 构建一个当前Filter的实例，外部提供对响应对象的头部写入器
     *
     * @param headerWriters the  HeaderWriter instances to write out headers to the
     *                      HttpServletResponse.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeaderWriterFilter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>headerWriters<span class="token punctuation">,</span> <span class="token string">&quot;headerWriters cannot be null or empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>headerWriters <span class="token operator">=</span> headerWriters<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将传入的response对象和头部写入器放在一起包装成一个HeaderWriterResponse对象，</span>
        <span class="token comment">// 该HeaderWriterResponse本身带有执行头部写入器的能力(可以被外部主动调用,也可能在响应对象</span>
        <span class="token comment">// 的某些事件发生时自主调用)，但此时并不执行这些头部写入器，只是将响应对象携带上需要的信息</span>
        <span class="token comment">// 二次封装继续传递，在需要执行的时候再执行。</span>
        <span class="token class-name">HeaderWriterResponse</span> headerWriterResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeaderWriterResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>headerWriters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HeaderWriterRequest</span> headerWriterRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeaderWriterRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                headerWriterResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 头部写入器已经绑定到二次封装的headerWriterResponse上了，继续filter chain</span>
            <span class="token comment">// 的执行</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>headerWriterRequest<span class="token punctuation">,</span> headerWriterResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 逻辑执行到这里，说明请求处理已经完成，已经处于回写响应对象给客户的阶段了，</span>
            <span class="token comment">// 这里调用头部写入方法。</span>
            <span class="token comment">// 注意，这里虽然调用头部写入方法，但真正的头部写入动作并不一定真正在这里发生,</span>
            <span class="token comment">// 因为该动作有可能已经在其他Filter中发生，具体请参考OnCommittedResponseWrapper</span>
            <span class="token comment">// 赋予HeaderWriterResponse的这种能力。</span>
            headerWriterResponse<span class="token punctuation">.</span><span class="token function">writeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 继承OnCommittedResponseWrapper实现一个自定义的HttpServletResponse，</span>
    <span class="token comment">// HeaderWriterResponse 实现的核心逻辑是提供一个onResponseCommitted()方法实现，</span>
    <span class="token comment">// 用于写入要求的头部信息到响应对象。</span>
    <span class="token comment">// 而onResponseCommitted()会在response被commit前确保被调用，这一点是OnCommittedResponseWrapper</span>
    <span class="token comment">// 的任务。一般来讲，在处理中发生 include,sendError, redirect, flushBuffer 时会导致 response commit,</span>
    <span class="token comment">// 而OnCommittedResponseWrapper的设计目的就是就是在这些事件将要发生时，调用onResponseCommitted()。</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HeaderWriterResponse</span> <span class="token keyword">extends</span> <span class="token class-name">OnCommittedResponseWrapper</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">;</span>

        <span class="token class-name">HeaderWriterResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                             <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>headerWriters <span class="token operator">=</span> headerWriters<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * (non-Javadoc)
         *
         * @see org.springframework.security.web.util.OnCommittedResponseWrapper#
         * onResponseCommitted()
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResponseCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将头部信息写入响应对象</span>
            <span class="token function">writeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 一旦完成头部写入，设置一个标记声明这件事情，从而可以避免</span>
            <span class="token comment">// 对该方法的再次调用或者对writeHeaders()不会导致重复写入</span>
            <span class="token comment">// 头部信息到响应对象</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disableOnResponseCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDisableOnResponseCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 先检查是否已经将头部写入响应的标记，如果已经写入则不再二次写入</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 将头部写入响应</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HeaderWriter</span> headerWriter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>headerWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                headerWriter<span class="token punctuation">.</span><span class="token function">writeHeaders</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token function">getHttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">HttpServletResponse</span> <span class="token function">getHttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HeaderWriterRequest</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HeaderWriterResponse</span> response<span class="token punctuation">;</span>

        <span class="token class-name">HeaderWriterRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HeaderWriterResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">RequestDispatcher</span> <span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeaderWriterRequestDispatcher</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HeaderWriterRequestDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestDispatcher</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestDispatcher</span> delegate<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HeaderWriterResponse</span> response<span class="token punctuation">;</span>

        <span class="token class-name">HeaderWriterRequestDispatcher</span><span class="token punctuation">(</span><span class="token class-name">RequestDispatcher</span> delegate<span class="token punctuation">,</span> <span class="token class-name">HeaderWriterResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forward</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">include</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">onResponseCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">include</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="csrffilter"><a href="#csrffilter" class="header-anchor">#</a> CsrfFilter</h3> <h4 id="概述-3"><a href="#概述-3" class="header-anchor">#</a> 概述</h4> <p><code>Spring Security Web</code>使用该Filter解决Cross-Site Request Forgery (CSRF)攻击,使用的模式是Synchronizer token pattern (STP)。</p> <blockquote><p><code>STP</code>模式本意是每个请求都生成一个不同的,随机的,不可预测的<code>token</code>用于<code>CSRF</code>保护。这种严格的模式<code>CSRF</code>保护能力很强。但是每请求必验给服务端增加了额外的负担，另外它也要求浏览器必须保持正确的事件顺序，从而会带来一些可用性上的问题(比如用户打开了多个Tab的情况)。所以<code>Spring Security</code>中把这种限制放宽到了每个<code>session</code>使用一个<code>csrf token</code>，并且仅针对会对服务器进行状态更新的HTTP动作:PATCH, POST, PUT,DELETE等。</p></blockquote> <h4 id="源代码解析-4"><a href="#源代码解析-4" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CsrfFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * The default RequestMatcher that indicates if CSRF protection is required or
     * not. The default is to ignore GET, HEAD, TRACE, OPTIONS and process all other
     * requests.
     * 用于检测哪些请求需要csrf保护，这里的缺省配置是：GET, HEAD, TRACE, OPTIONS这种只读的
     * HTTP动词都被忽略不做csrf保护，而其他PATCH, POST, PUT,DELETE等会修改服务器状态的HTTP
     * 动词会受到当前Filter的csrf保护。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcher</span> DEFAULT_CSRF_MATCHER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRequiresCsrfMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CsrfTokenRepository</span> tokenRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> requireCsrfProtectionMatcher <span class="token operator">=</span> DEFAULT_CSRF_MATCHER<span class="token punctuation">;</span>
    <span class="token comment">// 用于CSRF保护验证逻辑失败进行处理</span>
    <span class="token keyword">private</span> <span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedHandlerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造函数，使用指定的csrf token存储库构造一个CsrfFilter实例</span>
    <span class="token comment">// 缺省情况下，使用Spring Security 的 Springboot web 应用，选择使用的</span>
    <span class="token comment">// csrfTokenRepository是一个做了惰性封装的HttpSessionCsrfTokenRepository实例。</span>
    <span class="token comment">// 也就是说相应的 csrf token保存在http session中。</span>
    <span class="token keyword">public</span> <span class="token class-name">CsrfFilter</span><span class="token punctuation">(</span><span class="token class-name">CsrfTokenRepository</span> csrfTokenRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>csrfTokenRepository<span class="token punctuation">,</span> <span class="token string">&quot;csrfTokenRepository cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository <span class="token operator">=</span> csrfTokenRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * (non-Javadoc)
     *
     * @see
     * org.springframework.web.filter.OncePerRequestFilter#doFilterInternal(javax.servlet
     * .http.HttpServletRequest, javax.servlet.http.HttpServletResponse,
     * javax.servlet.FilterChain)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 从csrf token存储库中获取针对当前请求的csrf token。</span>
        <span class="token class-name">CsrfToken</span> csrfToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">loadToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 记录针对当前请求是否不存在csrf token</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> missingToken <span class="token operator">=</span> csrfToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>missingToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果存储库中尚不存在针对当前请求的csrf token，生成一个，把它关联到</span>
            <span class="token comment">// 当前请求保存到csrf token存储库中</span>
            csrfToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">saveToken</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将从存储库中获取得到的或者新建并保存到存储库的csrf token保存为请求的两个属性</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">CsrfToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getParameterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requireCsrfProtectionMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 检测当前请求是否需要csrf保护，如果不需要，放行继续执行filter chain的其他逻辑</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 尝试从请求头部或者参数中获取浏览器端传递过来的实际的csrf token。</span>
        <span class="token comment">// 缺省情况下，从头部取出时使用header name: X-CSRF-TOKEN</span>
        <span class="token comment">// 从请求中获取参数时使用的参数名称是 : _csrf</span>
        <span class="token class-name">String</span> actualToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getHeaderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actualToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            actualToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getParameterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>csrfToken<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// csrf token存储库中取出的token和浏览器端传递过来的token不相等的情况有两种:</span>
            <span class="token comment">// 1. 针对该请求在存储库中并不存在csrf token</span>
            <span class="token comment">// 2. 针对该请求在存储库中的csrf token和请求参数实际携带的不一致</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid CSRF token found for &quot;</span>
                        <span class="token operator">+</span> <span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">buildFullRequestUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>missingToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1. 针对该请求在存储库中并不存在csrf token ， 处理方案:</span>
                <span class="token comment">// 抛出异常 MissingCsrfTokenException</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">MissingCsrfTokenException</span><span class="token punctuation">(</span>actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 2. 针对该请求在存储库中的csrf token和请求参数实际携带的不一致,处理方案:</span>
                <span class="token comment">// 抛出异常 InvalidCsrfTokenException</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">InvalidCsrfTokenException</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">,</span> actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 当前请求需要经该Filter的csrf验证逻辑并且通过了csrf验证，放行，继续执行filter chain</span>
        <span class="token comment">// 其他部分逻辑</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Specifies a RequestMatcher that is used to determine if CSRF protection
     * should be applied. If the RequestMatcher returns true for a given request,
     * then CSRF protection is applied.
     *
     * 指定一个RequestMatcher用来检测一个请求是否需要应用csrf保护验证逻辑。
     *
     * The default is to apply CSRF protection for any HTTP method other than GET, HEAD,
     * TRACE, OPTIONS.
     * 缺省行为是针对GET, HEAD,TRACE, OPTIONS这种只读性的HTTP请求不做csrf保护验证，验证其他
     * 那些会更新服务器状态的HTTP请求，比如PATCH, POST, PUT,DELETE等。
     *
     *
     * @param requireCsrfProtectionMatcher the RequestMatcher used to determine if
     * CSRF protection should be applied.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRequireCsrfProtectionMatcher</span><span class="token punctuation">(</span>
            <span class="token class-name">RequestMatcher</span> requireCsrfProtectionMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requireCsrfProtectionMatcher<span class="token punctuation">,</span>
                <span class="token string">&quot;requireCsrfProtectionMatcher cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requireCsrfProtectionMatcher <span class="token operator">=</span> requireCsrfProtectionMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Specifies a AccessDeniedHandler that should be used when CSRF protection
     * fails.
     * 指定一个AccessDeniedHandler用于CSRF保护验证逻辑失败进行处理。
     *
     * The default is to use AccessDeniedHandlerImpl with no arguments.
     * 缺省行为是使用一个不但参数的AccessDeniedHandlerImpl实例。
     *
     * @param accessDeniedHandler the AccessDeniedHandler to use
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccessDeniedHandler</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>accessDeniedHandler<span class="token punctuation">,</span> <span class="token string">&quot;accessDeniedHandler cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler <span class="token operator">=</span> accessDeniedHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用于检测哪些HTTP请求需要应用csrf保护的RequestMatcher，</span>
    <span class="token comment">// 缺省行为是针对GET, HEAD,TRACE, OPTIONS这种只读性的HTTP请求不做csrf保护，</span>
    <span class="token comment">// 其他那些会更新服务器状态的HTTP请求，比如PATCH, POST, PUT,DELETE等需要csrf保护。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultRequiresCsrfMatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestMatcher</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allowedMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HEAD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TRACE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * (non-Javadoc)
         *
         * @see
         * org.springframework.security.web.util.matcher.RequestMatcher#matches(javax.
         * servlet.http.HttpServletRequest)
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowedMethods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="logoutfilter"><a href="#logoutfilter" class="header-anchor">#</a> LogoutFilter</h3> <h4 id="概述-4"><a href="#概述-4" class="header-anchor">#</a> 概述</h4> <p>在进行安全配置时，不管是明确指定还是使用缺省配置，最终安全配置中都会包含以下退出登录配置信息:</p> <ul><li><p>怎样的请求是一个退出登录请求</p> <ul><li>这里包含两部分信息: url, http method</li></ul></li> <li><p>成功退出登录过程需要做哪些事情</p> <ul><li>也就是各种配置的LogoutHandler</li> <li>核心LogoutHandler:SecurityContextLogoutHandler–销毁session和SecurityContextHolder内容</li></ul></li> <li><p>成功退出登录后跳转到哪里</p> <ul><li>也就是配置中的 logoutSuccessUrl</li></ul></li></ul> <p>基于以上配置信息，<code>LogoutFilter</code>被设计用于检测用户退出登录请求,执行相应的处理工作以及退出登录后的页面跳转。</p> <h4 id="源代码解析-5"><a href="#源代码解析-5" class="header-anchor">#</a> 源代码解析</h4> <div class="language- extra-class"><pre class="language-text"><code>public class LogoutFilter extends GenericFilterBean {

    // ~ Instance fields
    // ================================================================================================

    private RequestMatcher logoutRequestMatcher;

    private final LogoutHandler handler;
    private final LogoutSuccessHandler logoutSuccessHandler;

    // ~ Constructors
    // ===================================================================================================

    /**
     * Constructor which takes a LogoutSuccessHandler instance to determine the
     * target destination after logging out. The list of LogoutHandlers are
     * intended to perform the actual logout functionality (such as clearing the security
     * context, invalidating the session, etc.).
     * 缺省情况下，这里的LogoutSuccessHandler是一个SimpleUrlLogoutSuccessHandler实例，
     * 在退出登录成功时跳转到/。
     * &lt;p&gt;
     * 安全配置信息中还会包含对cookie,remember me 等安全机制的配置，这些机制中在用户成功退出
     * 登录时也会执行一些相应的清场工作，这些工作就是通过参数handlers传递进来的。这些handlers
     * 中最核心的一个就是SecurityContextLogoutHandler,它会销毁session和针对当前请求的
     * SecurityContextHolder中的安全上下文对象，这是真正意义上的退出登录。
     */
    public LogoutFilter(LogoutSuccessHandler logoutSuccessHandler,
                        LogoutHandler... handlers) {
        this.handler = new CompositeLogoutHandler(handlers);
        Assert.notNull(logoutSuccessHandler, &quot;logoutSuccessHandler cannot be null&quot;);
        this.logoutSuccessHandler = logoutSuccessHandler;
        setFilterProcessesUrl(&quot;/logout&quot;);
    }

    // 另外一个构造函数，如果没有指定logoutSuccessHandler,而是只指定了logoutSuccessUrl,
    // 该方法会根据logoutSuccessUrl构造一个logoutSuccessHandler：SimpleUrlLogoutSuccessHandler
    public LogoutFilter(String logoutSuccessUrl, LogoutHandler... handlers) {
        this.handler = new CompositeLogoutHandler(handlers);
        Assert.isTrue(
                !StringUtils.hasLength(logoutSuccessUrl)
                        || UrlUtils.isValidRedirectUrl(logoutSuccessUrl),
                () -&gt; logoutSuccessUrl + &quot; isn't a valid redirect URL&quot;);
        SimpleUrlLogoutSuccessHandler urlLogoutSuccessHandler = new SimpleUrlLogoutSuccessHandler();
        if (StringUtils.hasText(logoutSuccessUrl)) {
            urlLogoutSuccessHandler.setDefaultTargetUrl(logoutSuccessUrl);
        }
        logoutSuccessHandler = urlLogoutSuccessHandler;
        setFilterProcessesUrl(&quot;/logout&quot;);
    }

    // ~ Methods
    // ========================================================================================================

    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;

        if (requiresLogout(request, response)) {
            // 检测到用户请求了退出当前登录,现在执行退出登录逻辑
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();

            if (logger.isDebugEnabled()) {
                logger.debug(&quot;Logging out user '&quot; + auth
                        + &quot;' and transferring to logout destination&quot;);
            }

            this.handler.logout(request, response, auth);

            // 缺省情况下，这里的LogoutSuccessHandler是一个SimpleUrlLogoutSuccessHandler实例，
            // 在退出登录成功时跳转到/。
            // 上面已经成功退出了用户登录，现在跳转到相应的页面
            logoutSuccessHandler.onLogoutSuccess(request, response, auth);

            // 注意,这里完成了用户退出登录动作和页面跳转，所以当前请求的处理任务已经结束,
            // 也就是说不用再继续filter chain的执行了，直接函数返回即可。
            return;
        }

        // 不是用户请求退出登录的情况，继续执行 filter chain 。
        chain.doFilter(request, response);
    }

    /**
     * Allow subclasses to modify when a logout should take place.
     * 根据当前请求和安全配置检测是否用户在请求退出登录，如果是用户在请求退出登录的情况返回true，
     * 否则返回false
     *
     * @param request  the request
     * @param response the response
     * @return true if logout should occur, false otherwise
     */
    protected boolean requiresLogout(HttpServletRequest request,
                                     HttpServletResponse response) {
        //     logoutRequestMatcher 是配置时明确指定的，或者是根据其他配置计算出来的
        return logoutRequestMatcher.matches(request);
    }

    // 配置阶段会将用户明确指定的logoutRequestMatcher或者根据其他配置计算出来的logoutRequestMatcher
    // 通过该方法设置到当前Filter对象
    public void setLogoutRequestMatcher(RequestMatcher logoutRequestMatcher) {
        Assert.notNull(logoutRequestMatcher, &quot;logoutRequestMatcher cannot be null&quot;);
        this.logoutRequestMatcher = logoutRequestMatcher;
    }

    // 调用该方法则会将当前Filter的logoutRequestMatcher设置为一个根据filterProcessesUrl计算出来的
    //AntPathRequestMatcher,该matcher会仅根据请求url进行匹配，而不管http method是什么
    //
    // 在该Filter的构造函数中就调用了该方法setFilterProcessesUrl(&quot;/logout&quot;),从而构建了一个缺省的
    // AntPathRequestMatcher,表示只要用户访问 url /logout,不管http method是什么，都认为用户想要
    // 退出登录。但实际上，该初始值都会被配置过程中根据用户配置信息计算出的AntPathRequestMatcher
    // 调用上面的setLogoutRequestMatcher(logoutRequestMatcher)覆盖该matcher
    public void setFilterProcessesUrl(String filterProcessesUrl) {
        this.logoutRequestMatcher = new AntPathRequestMatcher(filterProcessesUrl);
    }
}
</code></pre></div><h3 id="usernamepasswordauthenticationfilter"><a href="#usernamepasswordauthenticationfilter" class="header-anchor">#</a> UsernamePasswordAuthenticationFilter</h3> <h4 id="概述-5"><a href="#概述-5" class="header-anchor">#</a> 概述</h4> <p>该过滤器会拦截用户请求，看它是否是一个来自用户名/密码表单登录页面提交的用户登录认证请求，缺省使用的匹配模式是:<code>POST /login</code>。缺省情况下，如果是用户登录认证请求，该请求就不会在整个filter chain中继续传递了，而是会被当前过滤器处理并进入响应用户阶段。</p> <p>具体用户登录认证处理逻辑是这样的，它会调用所指定的<code>AuthenticationManager</code>认证所提交的用户名/密码。</p> <p>如果认证成功，则会 ：</p> <ol><li><p>调用所设置的<code>SessionAuthenticationStrategy</code>会话认证策略;</p> <blockquote><p>针对Servlet 3.1+,缺省所使用的SessionAuthenticationStrategy是一个ChangeSessionIdAuthenticationStrategy和CsrfAuthenticationStrategy组合。ChangeSessionIdAuthenticationStrategy会为登录的用户创建一个新的session，而CsrfAuthenticationStrategy会创建新的csrf token用于CSRF保护。</p></blockquote></li> <li><p>经过完全认证的Authentication对象设置到SecurityContextHolder中的SecurityContext上;</p></li> <li><p>如果请求要求了Remember Me,进行相应记录;</p></li> <li><p>发布事件<code>InteractiveAuthenticationSuccessEvent</code>;</p></li> <li><p>获取并跳转到目标跳转页面；</p> <blockquote><p>缺省情况下，该跳转策略是<code>SavedRequestAwareAuthenticationSuccessHandler</code>。</p></blockquote> <ol><li><p>如果有保存的请求,则获取保存的请求，跳转到相应的请求地址;</p> <blockquote><p>一般在未登录用户直接访问受保护页面时会出现该情况：先被跳转到登录页面，登录完成过后再被跳转到原始请求页面</p></blockquote></li> <li><p><code>alwaysUseDefaultTargetUrl</code>为true则总是会跳到指定的defaultTargetUrl;</p> <blockquote><p>注意: <code>defaultTargetUrl</code> 也是可以设置的，如果不设置，其值缺省为/</p></blockquote></li> <li><p><code>alwaysUseDefaultTargetUrl</code>为<code>false</code>则</p> <ol><li>看请求参数中是否含有名称为配置参数<code>targetUrlParameter</code>值的参数，如果有，跳转到它定义的地址；</li> <li>否则如果指定了<code>useReferer</code>，尝试使用请求头部Referer作为目标跳转地址;</li> <li>否则使用<code>defaultTargetUrl</code>作为目标跳转地址;</li></ol></li></ol></li></ol> <h4 id="源代码解析-6"><a href="#源代码解析-6" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2004, 2005, 2006 Acegi Technology Pty Limited
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">MessageSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">MessageSourceAware</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">NullAuthenticatedSessionStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">RequestMatcher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GenericFilterBean</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Abstract processor of browser-based HTTP-based authentication requests.
 * 基于浏览器和HTTP的认证请求的处理抽象。
 *
 * &lt;h3&gt;Authentication Process&lt;/h3&gt; 认证过程
 * &lt;p&gt;
 * The filter requires that you set the &lt;tt&gt;authenticationManager&lt;/tt&gt; property. An
 * &lt;tt&gt;AuthenticationManager&lt;/tt&gt; is required to process the authentication request tokens
 * created by implementing classes.
 * 该过滤器执行认证需要一个authenticationManager，这个AuthenticationManager用来针对
 * 所创建的认证请求token做真正的用户身份认证动作。
 * &lt;p&gt;
 * This filter will intercept a request and attempt to perform authentication from that
 * request if the request matches the
 * {@link #setRequiresAuthenticationRequestMatcher(RequestMatcher)}.
 * 该过滤器拦截请求识别当前请求是否一个用户名/密码表单认证请求的匹配方法是通过方法
 * &lt;p&gt;
 * Authentication is performed by the
 * {@link #attemptAuthentication(HttpServletRequest, HttpServletResponse)
 * attemptAuthentication} method, which must be implemented by subclasses.
 * 认证动作由方法#attemptAuthentication(HttpServletRequest, HttpServletResponse)完成，
 * 该方法由子类实现。上面的UsernamePasswordAuthenticationFilter就提供了该方法的实现。
 *
 * &lt;h4&gt;Authentication Success&lt;/h4&gt; 认证成功
 * &lt;p&gt;
 * If authentication is successful, the resulting {@link Authentication} object will be
 * placed into the &lt;code&gt;SecurityContext&lt;/code&gt; for the current thread, which is
 * guaranteed to have already been created by an earlier filter.
 * 认证成功时，结果认证对象Authentication会被放到一个SecurityContext对象中，然后保存在处理
 * 当前请求的线程中。
 * &lt;p&gt;
 * The configured {@link #setAuthenticationSuccessHandler(AuthenticationSuccessHandler)
 * AuthenticationSuccessHandler} will then be called to take the redirect to the
 * appropriate destination after a successful login. The default behaviour is implemented
 * in a {@link SavedRequestAwareAuthenticationSuccessHandler} which will make use of any
 * &lt;tt&gt;DefaultSavedRequest&lt;/tt&gt; set by the &lt;tt&gt;ExceptionTranslationFilter&lt;/tt&gt; and
 * redirect the user to the URL contained therein. Otherwise it will redirect to the
 * webapp root &quot;/&quot;. You can customize this behaviour by injecting a differently configured
 * instance of this class, or by using a different implementation.
 * 然后通过#setAuthenticationSuccessHandler(AuthenticationSuccessHandler)所设置的
 * AuthenticationSuccessHandler会被调用，从而页面被跳转到所配置的成功登录页面。
 * &lt;p&gt;
 * See the
 * {@link #successfulAuthentication(HttpServletRequest, HttpServletResponse, FilterChain, Authentication)}
 * method for more information.
 *
 * &lt;h4&gt;Authentication Failure&lt;/h4&gt; 认证失败
 * &lt;p&gt;
 * If authentication fails, it will delegate to the configured
 * {@link AuthenticationFailureHandler} to allow the failure information to be conveyed to
 * the client. The default implementation is {@link SimpleUrlAuthenticationFailureHandler}
 * , which sends a 401 error code to the client. It may also be configured with a failure
 * URL as an alternative. Again you can inject whatever behaviour you require here.
 * 如果认证失败，该过滤器会代理给AuthenticationFailureHandler将失败信息传回给客户。缺省实现是
 * 一个SimpleUrlAuthenticationFailureHandler，它会发送一个HTTP 401代码给客户端。
 * &lt;h4&gt;Event Publication&lt;/h4&gt; 事件发布
 * &lt;p&gt;
 * If authentication is successful, an {@link InteractiveAuthenticationSuccessEvent} will
 * be published via the application context. No events will be published if authentication
 * was unsuccessful, because this would generally be recorded via an
 * {@code AuthenticationManager}-specific application event.
 * 认证成功时一个InteractiveAuthenticationSuccessEvent事件会发布到应用上下文。认证不成功
 * 则不会发布任何事件。
 * &lt;h4&gt;Session Authentication&lt;/h4&gt;
 * &lt;p&gt;
 * The class has an optional {@link SessionAuthenticationStrategy} which will be invoked
 * immediately after a successful call to {@code attemptAuthentication()}. Different
 * implementations
 * {@link #setSessionAuthenticationStrategy(SessionAuthenticationStrategy) can be
 * injected} to enable things like session-fixation attack prevention or to control the
 * number of simultaneous sessions a principal may have.
 *
 * @author Ben Alex
 * @author Luke Taylor
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span>
        <span class="token keyword">implements</span> <span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>
    <span class="token comment">// ~ Static fields/initializers</span>
    <span class="token comment">// =====================================================================================</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token keyword">protected</span> <span class="token class-name">ApplicationEventPublisher</span> eventPublisher<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authenticationDetailsSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 真正执行认证的认真管理器</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RememberMeServices</span> rememberMeServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> requiresAuthenticationRequestMatcher<span class="token punctuation">;</span>

    <span class="token comment">// 登录认证成功时是否继续执行filter chain，缺省为false，该属性安全配置阶段会重新指定,</span>
    <span class="token comment">// 但安全配置阶段缺省使用的值也是false，表示登录认证成功时不继续执行filter chain，而是</span>
    <span class="token comment">// 由该页面直接进入响应用户阶段</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> continueChainBeforeSuccessfulAuthentication <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// session 认证策略</span>
    <span class="token comment">// 安全配置中缺省是一个 CompositeSessionAuthenticationStrategy 对象，应用了组合模式，组合一些其他的</span>
    <span class="token comment">// session 认证策略实现，比如针对Servlet 3.1+,缺省会是 ChangeSessionIdAuthenticationStrategy跟</span>
    <span class="token comment">// CsrfAuthenticationStrategy组合</span>
    <span class="token comment">// 这里虽然初始化为NullAuthenticatedSessionStrategy,但它会被安全配置中的值覆盖</span>
    <span class="token keyword">private</span> <span class="token class-name">SessionAuthenticationStrategy</span> sessionStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullAuthenticatedSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> allowSessionCreation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Constructors</span>
    <span class="token comment">// ===================================================================================================</span>

    <span class="token comment">/**
     * @param defaultFilterProcessesUrl the default value for &lt;tt&gt;filterProcessesUrl&lt;/tt&gt;.
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> defaultFilterProcessesUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setFilterProcessesUrl</span><span class="token punctuation">(</span>defaultFilterProcessesUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Creates a new instance
     *
     * @param requiresAuthenticationRequestMatcher the {@link RequestMatcher} used to
     *                                             determine if authentication is required. Cannot be null.
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span><span class="token punctuation">(</span>
            <span class="token class-name">RequestMatcher</span> requiresAuthenticationRequestMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requiresAuthenticationRequestMatcher<span class="token punctuation">,</span>
                <span class="token string">&quot;requiresAuthenticationRequestMatcher cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requiresAuthenticationRequestMatcher <span class="token operator">=</span> requiresAuthenticationRequestMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> <span class="token string">&quot;authenticationManager must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Invokes the
     * {@link #requiresAuthentication(HttpServletRequest, HttpServletResponse)
     * requiresAuthentication} method to determine whether the request is for
     * authentication and should be handled by this filter. If it is an authentication
     * request, the
     * {@link #attemptAuthentication(HttpServletRequest, HttpServletResponse)
     * attemptAuthentication} will be invoked to perform the authentication. There are
     * then three possible outcomes:
     * &lt;ol&gt;
     * &lt;li&gt;An &lt;tt&gt;Authentication&lt;/tt&gt; object is returned. The configured
     * {@link SessionAuthenticationStrategy} will be invoked (to handle any
     * session-related behaviour such as creating a new session to protect against
     * session-fixation attacks) followed by the invocation of
     * {@link #successfulAuthentication(HttpServletRequest, HttpServletResponse, FilterChain, Authentication)}
     * method&lt;/li&gt;
     * &lt;li&gt;An &lt;tt&gt;AuthenticationException&lt;/tt&gt; occurs during authentication. The
     * {@link #unsuccessfulAuthentication(HttpServletRequest, HttpServletResponse, AuthenticationException)
     * unsuccessfulAuthentication} method will be invoked&lt;/li&gt;
     * &lt;li&gt;Null is returned, indicating that the authentication process is incomplete. The
     * method will then return immediately, assuming that the subclass has done any
     * necessary work (such as redirects) to continue the authentication process. The
     * assumption is that a later request will be received by this method where the
     * returned &lt;tt&gt;Authentication&lt;/tt&gt; object is not null.
     * &lt;/ol&gt;
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">requiresAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 检查当前请求是否是一个用户名/密码登录表单请求，如果不是，则继续执行filter chain</span>
            <span class="token comment">// 的其他部分</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 下面是检测到这是一个用户名/密码登录表单请求时的处理逻辑</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Request is to process authentication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Authentication</span> authResult<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 交给 AuthenticationManger 执行相应的认证</span>
            authResult <span class="token operator">=</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>authResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// return immediately as subclass has indicated that it hasn't completed</span>
                <span class="token comment">// authentication</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//针对Servlet 3.1+,缺省所使用的SessionAuthenticationStrategy会是一个</span>
            <span class="token comment">//ChangeSessionIdAuthenticationStrategy和CsrfAuthenticationStrategy组合。</span>
            <span class="token comment">//ChangeSessionIdAuthenticationStrategy会为登录的用户创建一个新的session，</span>
            <span class="token comment">//而CsrfAuthenticationStrategy会创建新的csrf token用于CSRF保护。</span>
            sessionStrategy<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span><span class="token punctuation">,</span>
                    failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 认证失败</span>
            <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Authentication failed</span>
            <span class="token comment">// 认证失败</span>
            <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Authentication success</span>
        <span class="token comment">// 认证成功，如果continueChainBeforeSuccessfulAuthentication为true，</span>
        <span class="token comment">// (continueChainBeforeSuccessfulAuthentication缺省为false)</span>
        <span class="token comment">// 继续执行filter chain的其他部分</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>continueChainBeforeSuccessfulAuthentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 认证成功后的处理逻辑</span>
        <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检测当前请求是否是登录认证请求
     * Indicates whether this filter should attempt to process a login request for the
     * current invocation.
     * &lt;p&gt;
     * It strips any parameters from the &quot;path&quot; section of the request URL (such as the
     * jsessionid parameter in &lt;em&gt;http://host/myapp/index.html;jsessionid=blah&lt;/em&gt;)
     * before matching against the &lt;code&gt;filterProcessesUrl&lt;/code&gt; property.
     * &lt;p&gt;
     * Subclasses may override for special requirements, such as Tapestry integration.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the filter should attempt authentication,
     * &lt;code&gt;false&lt;/code&gt; otherwise.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">requiresAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                             <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> requiresAuthenticationRequestMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Performs actual authentication. 执行真正的认证
     * &lt;p&gt;
     * The implementation should do one of the following:
     * 会是以下三种情况之一:
     * &lt;ol&gt;
     * &lt;li&gt;Return a populated authentication token for the authenticated user, indicating
     * successful authentication&lt;/li&gt; 认证成功，填充认证了的用户的其他信息到authentication token并返回之
     * &lt;li&gt;Return null, indicating that the authentication process is still in progress.
     * Before returning, the implementation should perform any additional work required to
     * complete the process.&lt;/li&gt; 返回null表示认证仍在进行中。
     * &lt;li&gt;Throw an &lt;tt&gt;AuthenticationException&lt;/tt&gt; if the authentication process fails&lt;/li&gt;
     * 抛出一个异常AuthenticationException表示认证失败。
     * &lt;/ol&gt;
     *
     * @param request  from which to extract parameters and perform the authentication
     * @param response the response, which may be needed if the implementation has to do a
     *                 redirect as part of a multi-stage authentication process (such as OpenID).
     * @return the authenticated user token, or null if authentication is incomplete.
     * @throws AuthenticationException if authentication fails.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                                         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
            <span class="token class-name">ServletException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Default behaviour for successful authentication. 认证成功时的缺省行为
     * &lt;ol&gt;
     * &lt;li&gt;Sets the successful &lt;tt&gt;Authentication&lt;/tt&gt; object on the
     * {@link SecurityContextHolder}&lt;/li&gt;
     * &lt;li&gt;Informs the configured &lt;tt&gt;RememberMeServices&lt;/tt&gt; of the successful login&lt;/li&gt;
     * &lt;li&gt;Fires an {@link InteractiveAuthenticationSuccessEvent} via the configured
     * &lt;tt&gt;ApplicationEventPublisher&lt;/tt&gt;&lt;/li&gt;
     * &lt;li&gt;Delegates additional behaviour to the {@link AuthenticationSuccessHandler}.&lt;/li&gt;
     * &lt;/ol&gt;
     * &lt;p&gt;
     * Subclasses can override this method to continue the {@link FilterChain} after
     * successful authentication.
     *
     * @param request
     * @param response
     * @param chain
     * @param authResult the object returned from the &lt;tt&gt;attemptAuthentication&lt;/tt&gt;
     *                   method.
     * @throws IOException
     * @throws ServletException
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication success. Updating SecurityContextHolder to contain: &quot;</span>
                    <span class="token operator">+</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

        rememberMeServices<span class="token punctuation">.</span><span class="token function">loginSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Fire event</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>
                    authResult<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Default behaviour for unsuccessful authentication.
     * 认证失败时的缺省行为
     * &lt;ol&gt;
     * &lt;li&gt;Clears the {@link SecurityContextHolder}&lt;/li&gt;
     * &lt;li&gt;Stores the exception in the session (if it exists or
     * &lt;tt&gt;allowSesssionCreation&lt;/tt&gt; is set to &lt;tt&gt;true&lt;/tt&gt;)&lt;/li&gt;
     * &lt;li&gt;Informs the configured &lt;tt&gt;RememberMeServices&lt;/tt&gt; of the failed login&lt;/li&gt;
     * &lt;li&gt;Delegates additional behaviour to the {@link AuthenticationFailureHandler}.&lt;/li&gt;
     * &lt;/ol&gt;
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                              <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication request failed: &quot;</span> <span class="token operator">+</span> failed<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Updated SecurityContextHolder to contain null Authentication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Delegating to authentication failure handler &quot;</span> <span class="token operator">+</span> failureHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets the URL that determines if authentication is required
     *
     * @param filterProcessesUrl
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFilterProcessesUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> filterProcessesUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setRequiresAuthenticationRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span>
                filterProcessesUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setRequiresAuthenticationRequestMatcher</span><span class="token punctuation">(</span>
            <span class="token class-name">RequestMatcher</span> requestMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requestMatcher<span class="token punctuation">,</span> <span class="token string">&quot;requestMatcher cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requiresAuthenticationRequestMatcher <span class="token operator">=</span> requestMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RememberMeServices</span> <span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rememberMeServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRememberMeServices</span><span class="token punctuation">(</span><span class="token class-name">RememberMeServices</span> rememberMeServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">,</span> <span class="token string">&quot;rememberMeServices cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices <span class="token operator">=</span> rememberMeServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Indicates if the filter chain should be continued prior to delegation to
     * {@link #successfulAuthentication(HttpServletRequest, HttpServletResponse, FilterChain, Authentication)}
     * , which may be useful in certain environment (such as Tapestry applications).
     * Defaults to &lt;code&gt;false&lt;/code&gt;.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContinueChainBeforeSuccessfulAuthentication</span><span class="token punctuation">(</span>
            <span class="token keyword">boolean</span> continueChainBeforeSuccessfulAuthentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>continueChainBeforeSuccessfulAuthentication <span class="token operator">=</span> continueChainBeforeSuccessfulAuthentication<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span> eventPublisher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">=</span> eventPublisher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authenticationDetailsSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationDetailsSource<span class="token punctuation">,</span>
                <span class="token string">&quot;AuthenticationDetailsSource required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource <span class="token operator">=</span> authenticationDetailsSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">getAllowSessionCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> allowSessionCreation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAllowSessionCreation</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> allowSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allowSessionCreation <span class="token operator">=</span> allowSessionCreation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * The session handling strategy which will be invoked immediately after an
     * authentication request is successfully processed by the
     * &lt;tt&gt;AuthenticationManager&lt;/tt&gt;. Used, for example, to handle changing of the
     * session identifier to prevent session fixation attacks.
     *
     * @param sessionStrategy the implementation to use. If not set a null implementation
     *                        is used.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSessionAuthenticationStrategy</span><span class="token punctuation">(</span>
            <span class="token class-name">SessionAuthenticationStrategy</span> sessionStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionStrategy <span class="token operator">=</span> sessionStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets the strategy used to handle a successful authentication. By default a
     * {@link SavedRequestAwareAuthenticationSuccessHandler} is used.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>successHandler<span class="token punctuation">,</span> <span class="token string">&quot;successHandler cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler <span class="token operator">=</span> successHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>failureHandler<span class="token punctuation">,</span> <span class="token string">&quot;failureHandler cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler <span class="token operator">=</span> failureHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationSuccessHandler</span> <span class="token function">getSuccessHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> successHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationFailureHandler</span> <span class="token function">getFailureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> failureHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="defaultloginpagegeneratingfilter"><a href="#defaultloginpagegeneratingfilter" class="header-anchor">#</a> DefaultLoginPageGeneratingFilter</h3> <h4 id="概述-6"><a href="#概述-6" class="header-anchor">#</a> 概述</h4> <p>当开发人员在安全配置中没有配置登录页面时，<code>Spring Security Web</code>会自动构造一个登录页面给用户。完成这一任务是通过一个过滤器来完成的，该过滤器就是<code>DefaultLoginPageGeneratingFilter</code>。</p> <p><strong>该过滤器支持两种登录情景:</strong></p> <ul><li>用户名/密码表单登录</li> <li>OpenID表单登录</li></ul> <p>无论以上哪种登录情景，该过滤器都会使用以下信息用于构建登录HTML页面 :</p> <ul><li><p>当前请求是否为登录页面请求的匹配器定义–由配置明确指定或者使用缺省值 <code>/login</code></p></li> <li><p>当前请求是否跳转自登录错误处理以及相应异常信息 – 缺省对应url : <code>/login?error</code></p></li> <li><p>当前请求是否跳转自退出登录成功处理 – 缺省对应url : <code>/login?logout</code></p></li> <li><p>配置指定使用用户名/密码表单登录还是<code>OpenID</code>表单登录</p></li> <li><p>表单构建信息</p> <ul><li><p><code>csrf token</code>信息</p></li> <li><p>针对用户名/密码表单登录的表单构建信息</p> <ul><li>登录表单提交处理地址</li> <li>用户名表单字段名称</li> <li>密码表单字段名称</li> <li><code>RememberMe</code> 表单字段名称</li></ul></li> <li><p>针对OpenID表单登录的表单构建信息</p> <ul><li>登录表单提交处理地址</li> <li><code>OpenID</code>表单字段名称</li> <li><code>RememberMe</code> 表单字段名称</li></ul></li></ul></li></ul> <p>该过滤器被请求到达时会首先看是不是自己关注的请求，如果是，则会根据相应信息构建一个登录页面<code>HTML</code>直接写回浏览器端，对该请求的处理也到此结束，不再继续调用<code>filter chain</code>中的其他逻辑。</p> <h4 id="生成的用户名-密码表单登录页面效果"><a href="#生成的用户名-密码表单登录页面效果" class="header-anchor">#</a> 生成的用户名/密码表单登录页面效果</h4> <p>由该Filter生成的用户名/密码表单登录页面如下所示：</p> <p><img src="https://img-blog.csdnimg.cn/20181203102339102.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZHlfemhhbmcyMDA3,size_16,color_FFFFFF,t_70" alt="用户名/密码登录页面效果"></p> <h4 id="生成的openid表单登录页面效果"><a href="#生成的openid表单登录页面效果" class="header-anchor">#</a> 生成的OpenID表单登录页面效果</h4> <p>由该Filter生成的OpenID表单登录页面如下所示：</p> <p><img src="https://img-blog.csdnimg.cn/20181203104714316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZHlfemhhbmcyMDA3,size_16,color_FFFFFF,t_70" alt="OpenId登录页面效果"></p> <h4 id="源代码解析-7"><a href="#源代码解析-7" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2002-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>ui</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">WebAttributes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AbstractAuthenticationProcessingFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>rememberme<span class="token punctuation">.</span></span><span class="token class-name">AbstractRememberMeServices</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GenericFilterBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HtmlUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpSession</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Function</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * For internal use with namespace configuration in the case where a user doesn't
 * configure a login page. The configuration code will insert this filter in the chain
 * instead.
 * 内部使用的一个过滤器，当用户没有指定一个登录页面时，安全配置逻辑自动插入这样一个过滤器用于
 * 自动生成一个登录页面。
 * &lt;p&gt;
 * Will only work if a redirect is used to the login page.
 *
 * @author Luke Taylor
 * @since 2.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultLoginPageGeneratingFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_LOGIN_PAGE_URL <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ERROR_PARAMETER_NAME <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginPageUrl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logoutSuccessUrl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> failureUrl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> formLoginEnabled<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> openIdEnabled<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> oauth2LoginEnabled<span class="token punctuation">;</span>
    <span class="token comment">// 用于构造用户名/密码表单登录页面的参数</span>
    <span class="token comment">// 表单提交时的认证处理地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> authenticationUrl<span class="token punctuation">;</span>
    <span class="token comment">// 用户名表单字段的名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> usernameParameter<span class="token punctuation">;</span>
    <span class="token comment">//  密码表单字段的名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> passwordParameter<span class="token punctuation">;</span>
    <span class="token comment">// rememberMe表单字段的名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rememberMeParameter<span class="token punctuation">;</span>
    <span class="token comment">// 用于构造openID表单登录页面的参数</span>
    <span class="token comment">// 提交时的认证处理地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> openIDauthenticationUrl<span class="token punctuation">;</span>
    <span class="token comment">//  用户名表单字段的名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> openIDusernameParameter<span class="token punctuation">;</span>
    <span class="token comment">// rememberMe表单字段的名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> openIDrememberMeParameter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oauth2AuthenticationUrlToClientName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resolveHiddenInputs <span class="token operator">=</span> request <span class="token operator">-&gt;</span> <span class="token class-name">Collections</span>
            <span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">DefaultLoginPageGeneratingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultLoginPageGeneratingFilter</span><span class="token punctuation">(</span><span class="token class-name">AbstractAuthenticationProcessingFilter</span> filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token keyword">instanceof</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">)</span> filter<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultLoginPageGeneratingFilter</span><span class="token punctuation">(</span>
            <span class="token class-name">UsernamePasswordAuthenticationFilter</span> authFilter<span class="token punctuation">,</span>
            <span class="token class-name">AbstractAuthenticationProcessingFilter</span> openIDFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">init</span><span class="token punctuation">(</span>authFilter<span class="token punctuation">,</span> openIDFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 支持两种登录方式:用户名/密码表单登录,openID登录，根据提供的filter参数的类型</span>
    <span class="token comment">// 判断使用了哪种登录方式</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationFilter</span> authFilter<span class="token punctuation">,</span>
                      <span class="token class-name">AbstractAuthenticationProcessingFilter</span> openIDFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 登录页面，缺省为 /logoin</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loginPageUrl <span class="token operator">=</span> DEFAULT_LOGIN_PAGE_URL<span class="token punctuation">;</span>
        <span class="token comment">// 默认的退出登录成功页面 /login?logout</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logoutSuccessUrl <span class="token operator">=</span> DEFAULT_LOGIN_PAGE_URL <span class="token operator">+</span> <span class="token string">&quot;?logout&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 登录出错页面, 缺省为 /login?error</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failureUrl <span class="token operator">=</span> DEFAULT_LOGIN_PAGE_URL <span class="token operator">+</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> ERROR_PARAMETER_NAME<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authFilter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            formLoginEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            usernameParameter <span class="token operator">=</span> authFilter<span class="token punctuation">.</span><span class="token function">getUsernameParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            passwordParameter <span class="token operator">=</span> authFilter<span class="token punctuation">.</span><span class="token function">getPasswordParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>authFilter<span class="token punctuation">.</span><span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">AbstractRememberMeServices</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rememberMeParameter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractRememberMeServices</span><span class="token punctuation">)</span> authFilter
                        <span class="token punctuation">.</span><span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openIDFilter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            openIdEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            openIDusernameParameter <span class="token operator">=</span> <span class="token string">&quot;openid_identifier&quot;</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>openIDFilter<span class="token punctuation">.</span><span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">AbstractRememberMeServices</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                openIDrememberMeParameter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractRememberMeServices</span><span class="token punctuation">)</span> openIDFilter
                        <span class="token punctuation">.</span><span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets a Function used to resolve a Map of the hidden inputs where the key is the
     * name of the input and the value is the value of the input. Typically this is used
     * to resolve the CSRF token.
     *
     * @param resolveHiddenInputs the function to resolve the inputs
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResolveHiddenInputs</span><span class="token punctuation">(</span>
            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resolveHiddenInputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>resolveHiddenInputs<span class="token punctuation">,</span> <span class="token string">&quot;resolveHiddenInputs cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHiddenInputs <span class="token operator">=</span> resolveHiddenInputs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> formLoginEnabled <span class="token operator">||</span> openIdEnabled <span class="token operator">||</span> oauth2LoginEnabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLogoutSuccessUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> logoutSuccessUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logoutSuccessUrl <span class="token operator">=</span> logoutSuccessUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLoginPageUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> loginPageUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoginPageUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginPageUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loginPageUrl <span class="token operator">=</span> loginPageUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFailureUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> failureUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failureUrl <span class="token operator">=</span> failureUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFormLoginEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> formLoginEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>formLoginEnabled <span class="token operator">=</span> formLoginEnabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOpenIdEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> openIdEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>openIdEnabled <span class="token operator">=</span> openIdEnabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOauth2LoginEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> oauth2LoginEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>oauth2LoginEnabled <span class="token operator">=</span> oauth2LoginEnabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> authenticationUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationUrl <span class="token operator">=</span> authenticationUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsernameParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> usernameParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>usernameParameter <span class="token operator">=</span> usernameParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPasswordParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> passwordParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>passwordParameter <span class="token operator">=</span> passwordParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRememberMeParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> rememberMeParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeParameter <span class="token operator">=</span> rememberMeParameter<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>openIDrememberMeParameter <span class="token operator">=</span> rememberMeParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOpenIDauthenticationUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> openIDauthenticationUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>openIDauthenticationUrl <span class="token operator">=</span> openIDauthenticationUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOpenIDusernameParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> openIDusernameParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>openIDusernameParameter <span class="token operator">=</span> openIDusernameParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOauth2AuthenticationUrlToClientName</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oauth2AuthenticationUrlToClientName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>oauth2AuthenticationUrlToClientName <span class="token operator">=</span> oauth2AuthenticationUrlToClientName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token comment">// 检测是否登录错误页面请求</span>
        <span class="token keyword">boolean</span> loginError <span class="token operator">=</span> <span class="token function">isErrorPage</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检测是否退出登录成功页面请求</span>
        <span class="token keyword">boolean</span> logoutSuccess <span class="token operator">=</span> <span class="token function">isLogoutSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检测是否登录页面请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoginUrlRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">||</span> loginError <span class="token operator">||</span> logoutSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果是上面三种任何一种情况，则自动生成一个登录HTML页面写回响应，</span>
            <span class="token comment">// 该方法返回，当前请求的处理结束。</span>

            <span class="token comment">// 生成登录页面的HTML内容</span>
            <span class="token class-name">String</span> loginPageHtml <span class="token operator">=</span> <span class="token function">generateLoginPageHtml</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> loginError<span class="token punctuation">,</span>
                    logoutSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentLength</span><span class="token punctuation">(</span>loginPageHtml<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将登录页面HTML内容写回浏览器</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>loginPageHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 当前请求的处理已经结果，方法返回，不再继续filter chain的调用</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成登录页面</span>
    <span class="token comment">// 会根据当前是用户名/密码表单登录请求还是openID表单登录请求生成不同的HTML</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateLoginPageHtml</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">boolean</span> loginError<span class="token punctuation">,</span>
                                         <span class="token keyword">boolean</span> logoutSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token string">&quot;Invalid credentials&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果是登录错误，则从session中获取登录错误异常信息，该错误信息会组织到</span>
            <span class="token comment">// 回写给浏览器端的HTML页面中</span>
            <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AuthenticationException</span> ex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> session
                        <span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">WebAttributes</span><span class="token punctuation">.</span>AUTHENTICATION_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                errorMsg <span class="token operator">=</span> ex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;Invalid credentials&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;head&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta charset=\&quot;utf-8\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1, shrink-to-fit=no\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta name=\&quot;description\&quot; content=\&quot;\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta name=\&quot;author\&quot; content=\&quot;\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;title&gt;Please sign in&lt;/title&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;link href=\&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css\&quot; rel=\&quot;stylesheet\&quot; integrity=\&quot;sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M\&quot; crossorigin=\&quot;anonymous\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;link href=\&quot;https://getbootstrap.com/docs/4.0/examples/signin/signin.css\&quot; rel=\&quot;stylesheet\&quot; crossorigin=\&quot;anonymous\&quot;/&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;/head&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;body&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;     &lt;div class=\&quot;container\&quot;&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> contextPath <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>formLoginEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 针对用户名/密码表单登录的情形构建相应的表单</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;      &lt;form class=\&quot;form-signin\&quot; method=\&quot;post\&quot; action=\&quot;&quot;</span> <span class="token operator">+</span> contextPath <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationUrl <span class="token operator">+</span> <span class="token string">&quot;\&quot;&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;h2 class=\&quot;form-signin-heading\&quot;&gt;Please sign in&lt;/h2&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token function">createError</span><span class="token punctuation">(</span>loginError<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span> <span class="token comment">// 出现登录错误的情况下，需要把登录错误信息追加到页面中</span>
                    <span class="token operator">+</span> <span class="token function">createLogoutSuccess</span><span class="token punctuation">(</span>logoutSuccess<span class="token punctuation">)</span> <span class="token comment">// 如果该页面登录请求跳转自退出登录成功，在页面中追加该信息</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;p&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;          &lt;label for=\&quot;username\&quot; class=\&quot;sr-only\&quot;&gt;Username&lt;/label&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;          &lt;input type=\&quot;text\&quot; id=\&quot;username\&quot; name=\&quot;&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usernameParameter <span class="token operator">+</span> <span class="token string">&quot;\&quot; class=\&quot;form-control\&quot; placeholder=\&quot;Username\&quot; required autofocus&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;/p&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;p&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;          &lt;label for=\&quot;password\&quot; class=\&quot;sr-only\&quot;&gt;Password&lt;/label&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;          &lt;input type=\&quot;password\&quot; id=\&quot;password\&quot; name=\&quot;&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>passwordParameter <span class="token operator">+</span> <span class="token string">&quot;\&quot; class=\&quot;form-control\&quot; placeholder=\&quot;Password\&quot; required&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;/p&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token function">createRememberMe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeParameter<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token function">renderHiddenInputs</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;button class=\&quot;btn btn-lg btn-primary btn-block\&quot; type=\&quot;submit\&quot;&gt;Sign in&lt;/button&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;      &lt;/form&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openIdEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 针对OpenID表单登录的情形构建相应的表单</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;      &lt;form name=\&quot;oidf\&quot; class=\&quot;form-signin\&quot; method=\&quot;post\&quot; action=\&quot;&quot;</span> <span class="token operator">+</span> contextPath <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>openIDauthenticationUrl <span class="token operator">+</span> <span class="token string">&quot;\&quot;&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;h2 class=\&quot;form-signin-heading\&quot;&gt;Login with OpenID Identity&lt;/h2&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token function">createError</span><span class="token punctuation">(</span>loginError<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token function">createLogoutSuccess</span><span class="token punctuation">(</span>logoutSuccess<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;p&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;          &lt;label for=\&quot;username\&quot; class=\&quot;sr-only\&quot;&gt;Identity&lt;/label&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;          &lt;input type=\&quot;text\&quot; id=\&quot;username\&quot; name=\&quot;&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>openIDusernameParameter <span class="token operator">+</span> <span class="token string">&quot;\&quot; class=\&quot;form-control\&quot; placeholder=\&quot;Username\&quot; required autofocus&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;/p&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token function">createRememberMe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>openIDrememberMeParameter<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token function">renderHiddenInputs</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;        &lt;button class=\&quot;btn btn-lg btn-primary btn-block\&quot; type=\&quot;submit\&quot;&gt;Sign in&lt;/button&gt;\n&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;      &lt;/form&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>oauth2LoginEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;h2 class=\&quot;form-signin-heading\&quot;&gt;Login with OAuth 2.0&lt;/h2&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span>loginError<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">createLogoutSuccess</span><span class="token punctuation">(</span>logoutSuccess<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;table class=\&quot;table table-striped\&quot;&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clientAuthenticationUrlToClientName <span class="token operator">:</span> oauth2AuthenticationUrlToClientName<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &lt;tr&gt;&lt;td&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> url <span class="token operator">=</span> clientAuthenticationUrlToClientName<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;a href=\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>contextPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> clientName <span class="token operator">=</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>clientAuthenticationUrlToClientName<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/a&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/table&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/div&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果请求的属性:CsrfToken.class.getName()有值，则渲染一个隐藏的针对csrf token的表单输入框</span>
    <span class="token comment">// 默认名称是 _csrf</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">renderHiddenInputs</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> input <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHiddenInputs<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;input name=\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot; type=\&quot;hidden\&quot; value=\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot; /&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">createRememberMe</span><span class="token punctuation">(</span><span class="token class-name">String</span> paramName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>paramName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&lt;p&gt;&lt;input type='checkbox' name='&quot;</span>
                <span class="token operator">+</span> paramName
                <span class="token operator">+</span> <span class="token string">&quot;'/&gt; Remember me on this computer.&lt;/p&gt;\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isLogoutSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> logoutSuccessUrl <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> logoutSuccessUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检测当前请求是否是一个登录页面请求</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isLoginUrlRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> loginPageUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检测当前请求是否是一个登录错误页面请求</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isErrorPage</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> failureUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createError</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isError<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> isError <span class="token operator">?</span> <span class="token string">&quot;&lt;div class=\&quot;alert alert-danger\&quot; role=\&quot;alert\&quot;&gt;&quot;</span> <span class="token operator">+</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&lt;/div&gt;&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createLogoutSuccess</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isLogoutSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> isLogoutSuccess <span class="token operator">?</span> <span class="token string">&quot;&lt;div class=\&quot;alert alert-success\&quot; role=\&quot;alert\&quot;&gt;You have been signed out&lt;/div&gt;&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> url <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 参数检查:</span>
            <span class="token comment">// 1. 对登录页面的请求仅仅支持GET方式</span>
            <span class="token comment">// 2. url 不能为空</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取请求uri，注意其中不包含QueryString部分</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pathParamIndex <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathParamIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// strip everything after the first semi-colon</span>
            uri <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pathParamIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            uri <span class="token operator">+=</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 比较请求的uri和预期的url是否相同</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> uri<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> uri<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="defaultlogoutpagegeneratingfilter"><a href="#defaultlogoutpagegeneratingfilter" class="header-anchor">#</a> DefaultLogoutPageGeneratingFilter</h3> <h4 id="概述-7"><a href="#概述-7" class="header-anchor">#</a> 概述</h4> <p><code>DefaultLogoutPageGeneratingFilter</code>用于生成一个缺省的用户退出登录页面，默认情况下，当用户请求为<code>GET /logout</code>时，该过滤器会起作用，生成并展示相应的用户退出登录表单页面。用户点击其中的表单提交按钮会提交用户退出登录请求到<code>POST /logout</code>，缺省情况下，也就是由<code>LogoutFilte</code>r过滤器来执行相应的用户退出登录逻辑。</p> <p>该用户退出登录页面如下所示：</p> <p><img src="https://img-blog.csdnimg.cn/20181203132346883.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZHlfemhhbmcyMDA3,size_16,color_FFFFFF,t_70" alt="缺省用户退出登录页面"></p> <h4 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2002-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>ui</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">RequestMatcher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Function</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Generates a default log out page.
 *
 * @author Rob Winch
 * @since 5.1
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultLogoutPageGeneratingFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    <span class="token comment">// 缺省用户请求退出登录页面识别匹配器 : GET, /logout</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> matcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resolveHiddenInputs <span class="token operator">=</span> request <span class="token operator">-&gt;</span> <span class="token class-name">Collections</span>
            <span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果当前请求是请求退出登录页面，则渲染该页面给用户并结束对请求的处理</span>
            <span class="token function">renderLogout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果当前请求不是请求退出登录页面，继续filter chain的调用</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 往response中写入一个HTML，这个HTML包含一个FORM表单，该表单包含一个按钮，点击该按钮提交该表单</span>
    <span class="token comment">// 到退出登录处理URL(也就是由LogoutFilter所负责的逻辑)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renderLogout</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> page <span class="token operator">=</span> <span class="token string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;head&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta charset=\&quot;utf-8\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1, shrink-to-fit=no\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta name=\&quot;description\&quot; content=\&quot;\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;meta name=\&quot;author\&quot; content=\&quot;\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;title&gt;Confirm Log Out?&lt;/title&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;link href=\&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css\&quot; rel=\&quot;stylesheet\&quot; integrity=\&quot;sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M\&quot; crossorigin=\&quot;anonymous\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;link href=\&quot;https://getbootstrap.com/docs/4.0/examples/signin/signin.css\&quot; rel=\&quot;stylesheet\&quot; crossorigin=\&quot;anonymous\&quot;/&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;/head&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;body&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;     &lt;div class=\&quot;container\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;      &lt;form class=\&quot;form-signin\&quot; method=\&quot;post\&quot; action=\&quot;&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/logout\&quot;&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;        &lt;h2 class=\&quot;form-signin-heading\&quot;&gt;Are you sure you want to log out?&lt;/h2&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token function">renderHiddenInputs</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;        &lt;button class=\&quot;btn btn-lg btn-primary btn-block\&quot; type=\&quot;submit\&quot;&gt;Log Out&lt;/button&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;      &lt;/form&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;    &lt;/div&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;  &lt;/body&gt;\n&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;&lt;/html&gt;&quot;</span><span class="token punctuation">;</span>

        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets a Function used to resolve a Map of the hidden inputs where the key is the
     * name of the input and the value is the value of the input. Typically this is used
     * to resolve the CSRF token.
     *
     * @param resolveHiddenInputs the function to resolve the inputs
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResolveHiddenInputs</span><span class="token punctuation">(</span>
            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resolveHiddenInputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>resolveHiddenInputs<span class="token punctuation">,</span> <span class="token string">&quot;resolveHiddenInputs cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHiddenInputs <span class="token operator">=</span> resolveHiddenInputs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将一些隐藏输入字段，比如csrf token等，追加到退出登录页面</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">renderHiddenInputs</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> input <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHiddenInputs<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;input name=\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot; type=\&quot;hidden\&quot; value=\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot; /&gt;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="basicauthenticationfilter"><a href="#basicauthenticationfilter" class="header-anchor">#</a> BasicAuthenticationFilter</h3> <h4 id="概述-8"><a href="#概述-8" class="header-anchor">#</a> 概述</h4> <p>处理HTTP请求中的<code>BASIC authorization</code>头部，把认证结果写入<code>SecurityContextHolder</code>。</p> <p>当一个HTTP请求中包含一个名字为<code>Authorization</code>的头部，并且其值格式是<code>Basic xxx</code>时，该Filter会认为这是一个<code>BASIC authorization</code>头部，其中xxx部分应该是一个base64编码的<code>{username}:{password}</code>字符串。比如用户名/密码分别为 admin/secret, 则对应的该头部是 : <code>Basic YWRtaW46c2VjcmV0</code> 。</p> <p>该过滤器会从 <code>HTTP BASIC authorization</code>头部解析出相应的用户名和密码然后调用AuthenticationManager进行认证，成功的话会把认证了的结果写入到<code>SecurityContextHolder</code>中<code>SecurityContext</code>的属性<code>authentication</code>上面。同时还会做其他一些处理，比如<code>Remember Me</code>相关处理等等。</p> <p>如果头部分析失败，该过滤器会抛出异常<code>BadCredentialsException</code>。</p> <p>如果认证失败，则会清除<code>SecurityContextHolder</code>中的<code>SecurityContext</code>。并且不再继续<code>filter chain</code>的执行。</p> <h4 id="源代码解析-8"><a href="#源代码解析-8" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2004, 2005, 2006 Acegi Technology Pty Limited
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>www</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AnonymousAuthenticationToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">BadCredentialsException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationEntryPoint</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">NullRememberMeServices</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">RememberMeServices</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Processes a HTTP request's BASIC authorization headers, putting the result into the
 * &lt;code&gt;SecurityContextHolder&lt;/code&gt;.
 *
 * &lt;p&gt;
 * For a detailed background on what this filter is designed to process, refer to
 * &lt;a href=&quot;http://www.faqs.org/rfcs/rfc1945.html&quot;&gt;RFC 1945, Section 11.1&lt;/a&gt;. Any realm
 * name presented in the HTTP request is ignored.
 *
 * &lt;p&gt;
 * In summary, this filter is responsible for processing any request that has a HTTP
 * request header of &lt;code&gt;Authorization&lt;/code&gt; with an authentication scheme of
 * &lt;code&gt;Basic&lt;/code&gt; and a Base64-encoded &lt;code&gt;username:password&lt;/code&gt; token. For
 * example, to authenticate user &quot;Aladdin&quot; with password &quot;open sesame&quot; the following
 * header would be presented:
 *
 * &lt;pre&gt;
 *
 * Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==
 * &lt;/pre&gt;
 *
 * &lt;p&gt;
 * This filter can be used to provide BASIC authentication services to both remoting
 * protocol clients (such as Hessian and SOAP) as well as standard user agents (such as
 * Internet Explorer and Netscape).
 * &lt;p&gt;
 * If authentication is successful, the resulting {@link Authentication} object will be
 * placed into the &lt;code&gt;SecurityContextHolder&lt;/code&gt;.
 *
 * &lt;p&gt;
 * If authentication fails and &lt;code&gt;ignoreFailure&lt;/code&gt; is &lt;code&gt;false&lt;/code&gt; (the
 * default), an {@link AuthenticationEntryPoint} implementation is called (unless the
 * &lt;tt&gt;ignoreFailure&lt;/tt&gt; property is set to &lt;tt&gt;true&lt;/tt&gt;). Usually this should be
 * {@link BasicAuthenticationEntryPoint}, which will prompt the user to authenticate again
 * via BASIC authentication.
 *
 * &lt;p&gt;
 * Basic authentication is an attractive protocol because it is simple and widely
 * deployed. However, it still transmits a password in clear text and as such is
 * undesirable in many situations. Digest authentication is also provided by Spring
 * Security and should be used instead of Basic authentication wherever possible. See
 * {@link org.springframework.security.web.authentication.www.DigestAuthenticationFilter}.
 * &lt;p&gt;
 * Note that if a {@link RememberMeServices} is set, this filter will automatically send
 * back remember-me details to the client. Therefore, subsequent requests will not need to
 * present a BASIC authentication header as they will be authenticated using the
 * remember-me mechanism.
 *
 * @author Ben Alex
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BasicAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token comment">// 创建Authentication对象时设置details属性所使用的详情来源</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authenticationDetailsSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RememberMeServices</span> rememberMeServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> ignoreFailure <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> credentialsCharset <span class="token operator">=</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates an instance which will authenticate against the supplied
     * {@code AuthenticationManager} and which will ignore failed authentication attempts,
     * allowing the request to proceed down the filter chain.
     *
     * @param authenticationManager the bean to submit authentication requests to
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BasicAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> <span class="token string">&quot;authenticationManager cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ignoreFailure <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Creates an instance which will authenticate against the supplied
     * {@code AuthenticationManager} and use the supplied {@code AuthenticationEntryPoint}
     * to handle authentication failures.
     *
     * @param authenticationManager    the bean to submit authentication requests to
     * @param authenticationEntryPoint will be invoked when authentication fails.
     *                                 Typically an instance of {@link BasicAuthenticationEntryPoint}.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BasicAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">,</span>
                                     <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> <span class="token string">&quot;authenticationManager cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationEntryPoint<span class="token punctuation">,</span>
                <span class="token string">&quot;authenticationEntryPoint cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint <span class="token operator">=</span> authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">,</span>
                <span class="token string">&quot;An AuthenticationManager is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isIgnoreFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">,</span>
                    <span class="token string">&quot;An AuthenticationEntryPoint is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> debug <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取请求头部 Authorization</span>
        <span class="token class-name">String</span> header <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>header <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>header<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;basic &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果头部 Authorization 未设置或者不是 basic 认证头部，则当前</span>
            <span class="token comment">// 请求不是该过滤器关注的对象，直接放行，继续filter chain 的执行</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 这是一个 http basic authentication 请求的情况，也就是说，已经检测到</span>
        <span class="token comment">// 请求头部 Authorization 的值符合格式(大小写不敏感) : &quot;basic xxxxxx&quot;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 分析头部 Authorization 获取用户名和密码</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens <span class="token operator">=</span> <span class="token function">extractAndDecodeHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span> tokens<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">;</span>

            <span class="token comment">// 现在 tokens[0] 表示用户名， tokens[1] 表示密码</span>
            <span class="token class-name">String</span> username <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logger
                        <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Basic Authentication Authorization header found for user '&quot;</span>
                                <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 检测针对所请求的用户名 username 是否需要认证</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">authenticationIsRequired</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果需要认证，使用所获取到的用户名/密码构建一个 UsernamePasswordAuthenticationToken,</span>
                <span class="token comment">// 然后执行认证流程</span>
                <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
                        username<span class="token punctuation">,</span> tokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                authRequest<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 执行认证</span>
                <span class="token class-name">Authentication</span> authResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager
                        <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication success: &quot;</span> <span class="token operator">+</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 认证成功，将完全认证的Authentication authRequest设置到 SecurityContextHolder</span>
                <span class="token comment">// 中的 SecurityContext 上。</span>
                <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 认证成功时 RememberMe 相关处理</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 认证成功时的其他处理: 其实这个个空方法，什么都没做</span>
                <span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 认证失败，清除 SecurityContextHolder 的安全上下文</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication request for failed: &quot;</span> <span class="token operator">+</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 认证失败 RememberMe 相关处理</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 认证失败时的其他处理: 其实这个个空方法，什么都没做</span>
            <span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ignoreFailure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">commence</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果当前请求并非含有 http basic authentication 头部的请求，则直接放行，继续filter chain的执行</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Decodes the header into a username and password.
     * 从指定的 http basic authentication 请求头部解码出一个用户名和密码
     *
     * @throws BadCredentialsException if the Basic header is not present or is not valid
     *                                 Base64
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">extractAndDecodeHeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> header<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//     截取头部前6个字符之后的内容部分,使用字符集编码方式UTF-8</span>
        <span class="token comment">// 举例: 整个头部值为 &quot;Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==&quot;,</span>
        <span class="token comment">//       这里则是获取&quot;QWxhZGRpbjpvcGVuIHNlc2FtZQ==&quot;部分</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> base64Token <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用 Base64 字符编码方式解码 base64Token</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decoded<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            decoded <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>base64Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Failed to decode basic authentication token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 使用指定的字符集credentialsCharset重新构建&quot;{用户名}:{密码}&quot;字符串</span>
        <span class="token comment">// credentialsCharset 缺省也是 UTF-8</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decoded<span class="token punctuation">,</span> <span class="token function">getCredentialsCharset</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 提取用户名,密码并返回之</span>
        <span class="token keyword">int</span> delim <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>delim <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid basic authentication token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>token<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> delim<span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>delim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">authenticationIsRequired</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only reauthenticate if username doesn't match SecurityContextHolder and user</span>
        <span class="token comment">// isn't authenticated</span>
        <span class="token comment">// (see SEC-53)</span>
        <span class="token class-name">Authentication</span> existingAuth <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 检测 SecurityContextHolder 中 SecurityContext 的 Authentication,</span>
        <span class="token comment">// 如果它为 null 或者尚未认证，则认为需要认证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingAuth <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>existingAuth<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Limit username comparison to providers which use usernames (ie</span>
        <span class="token comment">// UsernamePasswordAuthenticationToken)</span>
        <span class="token comment">// (see SEC-348)</span>
        <span class="token comment">// 如果 SecurityContextHolder 中 SecurityContext 的 Authentication 是</span>
        <span class="token comment">// 已经认证状态，但是其中的用户名和这里的 username 不相同，也认为需要认证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingAuth <span class="token keyword">instanceof</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>existingAuth<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Handle unusual condition where an AnonymousAuthenticationToken is already</span>
        <span class="token comment">// present</span>
        <span class="token comment">// This shouldn't happen very often, as BasicProcessingFitler is meant to be</span>
        <span class="token comment">// earlier in the filter</span>
        <span class="token comment">// chain than AnonymousAuthenticationFilter. Nevertheless, presence of both an</span>
        <span class="token comment">// AnonymousAuthenticationToken</span>
        <span class="token comment">// together with a BASIC authentication request header should indicate</span>
        <span class="token comment">// reauthentication using the</span>
        <span class="token comment">// BASIC protocol is desirable. This behaviour is also consistent with that</span>
        <span class="token comment">// provided by form and digest,</span>
        <span class="token comment">// both of which force re-authentication if the respective header is detected (and</span>
        <span class="token comment">// in doing so replace</span>
        <span class="token comment">// any existing AnonymousAuthenticationToken). See SEC-610.</span>
        <span class="token comment">// 如果 SecurityContextHolder 中 SecurityContext 的 Authentication 是匿名认证，</span>
        <span class="token comment">// 则认为需要认证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingAuth <span class="token keyword">instanceof</span> <span class="token class-name">AnonymousAuthenticationToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果 SecurityContextHolder 中 SecurityContext 的 Authentication 是已认证状态,</span>
        <span class="token comment">// 并且是针对当前username的，则认为不需要认证</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                              <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                                <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token function">getAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isIgnoreFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoreFailure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authenticationDetailsSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationDetailsSource<span class="token punctuation">,</span>
                <span class="token string">&quot;AuthenticationDetailsSource required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource <span class="token operator">=</span> authenticationDetailsSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRememberMeServices</span><span class="token punctuation">(</span><span class="token class-name">RememberMeServices</span> rememberMeServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">,</span> <span class="token string">&quot;rememberMeServices cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices <span class="token operator">=</span> rememberMeServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCredentialsCharset</span><span class="token punctuation">(</span><span class="token class-name">String</span> credentialsCharset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>credentialsCharset<span class="token punctuation">,</span> <span class="token string">&quot;credentialsCharset cannot be null or empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentialsCharset <span class="token operator">=</span> credentialsCharset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getCredentialsCharset</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>credentialsCharset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="requestcacheawarefilter"><a href="#requestcacheawarefilter" class="header-anchor">#</a> RequestCacheAwareFilter</h3> <h4 id="概述-9"><a href="#概述-9" class="header-anchor">#</a> 概述</h4> <p><code>Spring Security Web</code>对请求提供了缓存机制，如果某个请求被缓存，它的提取和使用是交给<code>RequestCacheAwareFilter</code>完成的。</p> <p>系统在启动时，<code>Spring Security Web</code>会首先尝试从容器中获取一个<code>RequestCache bean</code>,获取失败的话，会构建一个缺省的<code>RequestCache</code>对象，然后实例化该过滤器 。</p> <p>如果容器中不存在<code>RequestCache bean</code>,<code>Spring Security Web</code>所使用的缺省<code>RequestCache</code>是一个<code>HttpSessionRequestCache</code>,它会将请求保存在<code>http session</code>中，而且不是所有的请求都会被缓存，而是只有符合以下条件的请求才被缓存 ：</p> <ol><li><p>必须是 GET /**</p></li> <li><p>并且不能是 /**/favicon.*</p></li> <li><p>并且不能是 application.json</p></li> <li><p>并且不能是 XMLHttpRequest (也就是一般意义上的 ajax 请求)</p></li> <li><p>上面请求缓存条件的定义在RequestCacheConfigurer#createDefaultSavedRequestMatcher中。</p></li></ol> <blockquote><p>上面请求缓存条件的定义在<code>RequestCacheConfigurer#createDefaultSavedRequestMatcher</code>中。</p></blockquote> <h4 id="源代码分析"><a href="#源代码分析" class="header-anchor">#</a> 源代码分析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2002-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>savedrequest</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GenericFilterBean</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Responsible for reconstituting the saved request if one is cached and it matches the
 * current request.
 * &lt;p&gt;
 * It will call
 * {@link RequestCache#getMatchingRequest(HttpServletRequest, HttpServletResponse)
 * getMatchingRequest} on the configured &lt;tt&gt;RequestCache&lt;/tt&gt;. If the method returns a
 * value (a wrapper of the saved request), it will pass this to the filter chain's
 * &lt;tt&gt;doFilter&lt;/tt&gt; method. If null is returned by the cache, the original request is
 * used and the filter has no effect.
 * 用于用户登录成功后，重新恢复因为登录被打断的请求
 * @author Luke Taylor
 * @since 3.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestCacheAwareFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">;</span>

    <span class="token comment">// 使用http session 作为请求缓存的构造函数</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestCacheAwareFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 外部指定请求缓存对象的构造函数</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestCacheAwareFilter</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requestCache<span class="token punctuation">,</span> <span class="token string">&quot;requestCache cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache <span class="token operator">=</span> requestCache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span>
                         <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

        <span class="token class-name">HttpServletRequest</span> wrappedSavedRequest <span class="token operator">=</span> requestCache<span class="token punctuation">.</span><span class="token function">getMatchingRequest</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>wrappedSavedRequest <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> request <span class="token operator">:</span> wrappedSavedRequest<span class="token punctuation">,</span>
                response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="securitycontextholderawarerequestfilter"><a href="#securitycontextholderawarerequestfilter" class="header-anchor">#</a> SecurityContextHolderAwareRequestFilter</h3> <h4 id="概述-10"><a href="#概述-10" class="header-anchor">#</a> 概述</h4> <p><code>SecurityContextHolderAwareRequestFilter</code>对请求<code>HttpServletRequest</code>采用<code>Wrapper/Decorator</code>模式包装成一个可以访问<code>SecurityContextHolder</code>中安全上下文的<code>SecurityContextHolderAwareRequestWrapper</code>。这样接口<code>HttpServletRequest</code>上定义的<code>getUserPrincipal</code>这种安全相关的方法才能访问到相应的安全信息。</p> <blockquote><p>针对<code>Servlet 2.5</code>和<code>Servlet 3</code>,该过滤器使用了不一样的工厂，但最终都是使用<code>SecurityContextHolderAwareRequestWrapper</code>封装请求使其具备访问<code>SecurityContextHolder</code>安全上下文的能力。</p></blockquote> <h4 id="源代码解析-9"><a href="#源代码解析-9" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextHolderAwareRequestFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token comment">// 缺省角色名称的前缀</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rolePrefix <span class="token operator">=</span> <span class="token string">&quot;ROLE_&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 用于封装HttpServletRequest的工厂类，最终目的是封装HttpServletRequest</span>
    <span class="token comment">// 使之具有访问SecurityContextHolder中安全上下文的能力。</span>
    <span class="token comment">// 针对 Servlet 2.5 和 Servlet 3 使用的不同实现类。</span>
    <span class="token keyword">private</span> <span class="token class-name">HttpServletRequestFactory</span> requestFactory<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogoutHandler</span><span class="token punctuation">&gt;</span></span> logoutHandlers<span class="token punctuation">;</span>

    <span class="token comment">// 判断认证对象Authentication是何种类型:是否匿名Authentication,</span>
    <span class="token comment">// 是否 Remember Me Authentication。</span>
    <span class="token comment">// 缺省使用实现AuthenticationTrustResolverImpl,</span>
    <span class="token comment">// 根据对象Authentication所使用的实现类是AnonymousAuthenticationToken</span>
    <span class="token comment">// 还是RememberMeAuthenticationToken达到上述目的</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationTrustResolver</span> trustResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationTrustResolverImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>
    <span class="token comment">// 指定角色前缀，</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRolePrefix</span><span class="token punctuation">(</span><span class="token class-name">String</span> rolePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rolePrefix<span class="token punctuation">,</span> <span class="token string">&quot;Role prefix must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix <span class="token operator">=</span> rolePrefix<span class="token punctuation">;</span>
        <span class="token comment">// 角色前缀变更时更新requestFactory工厂</span>
        <span class="token function">updateFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;p&gt;
     * Sets the {@link AuthenticationEntryPoint} used when integrating
     * {@link HttpServletRequest} with Servlet 3 APIs. Specifically, it will be used when
     * {@link HttpServletRequest#authenticate(HttpServletResponse)} is called and the user
     * is not authenticated.
     * &lt;/p&gt;
     * &lt;p&gt;
     * If the value is null (default), then the default container behavior will be be
     * retained when invoking {@link HttpServletRequest#authenticate(HttpServletResponse)}
     * .
     * &lt;/p&gt;
     *
     * @param authenticationEntryPoint the {@link AuthenticationEntryPoint} to use when
     *                                 invoking {@link HttpServletRequest#authenticate(HttpServletResponse)} if the user
     *                                 is not authenticated.
     * @throws IllegalStateException if the Servlet 3 APIs are not found on the classpath
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationEntryPoint</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint <span class="token operator">=</span> authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;p&gt;
     * Sets the {@link AuthenticationManager} used when integrating
     * {@link HttpServletRequest} with Servlet 3 APIs. Specifically, it will be used when
     * {@link HttpServletRequest#login(String, String)} is invoked to determine if the
     * user is authenticated.
     * &lt;/p&gt;
     * &lt;p&gt;
     * If the value is null (default), then the default container behavior will be
     * retained when invoking {@link HttpServletRequest#login(String, String)}.
     * &lt;/p&gt;
     *
     * @param authenticationManager the {@link AuthenticationManager} to use when invoking
     *                              {@link HttpServletRequest#login(String, String)}
     * @throws IllegalStateException if the Servlet 3 APIs are not found on the classpath
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;p&gt;
     * Sets the {@link LogoutHandler}s used when integrating with
     * {@link HttpServletRequest} with Servlet 3 APIs. Specifically it will be used when
     * {@link HttpServletRequest#logout()} is invoked in order to log the user out. So
     * long as the {@link LogoutHandler}s do not commit the {@link HttpServletResponse}
     * (expected), then the user is in charge of handling the response.
     * &lt;/p&gt;
     * &lt;p&gt;
     * If the value is null (default), the default container behavior will be retained
     * when invoking {@link HttpServletRequest#logout()}.
     * &lt;/p&gt;
     *
     * @param logoutHandlers the {@code List&amp;lt;LogoutHandler&amp;gt;}s when invoking
     *                       {@link HttpServletRequest#logout()}.
     * @throws IllegalStateException if the Servlet 3 APIs are not found on the classpath
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLogoutHandlers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogoutHandler</span><span class="token punctuation">&gt;</span></span> logoutHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandlers <span class="token operator">=</span> logoutHandlers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 本Filter因为继承自GenericFilterBean，从而隐含地实现了接口InitializingBean，</span>
        <span class="token comment">// 所以会有此方法。而此方法会在该Filter bean被初始化时调用。此时会确定具体使用的</span>
        <span class="token comment">// requestFactory 实例</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新封装HttpServletRequest的工厂实例requestFactory，</span>
        <span class="token comment">// 根据当前使用的Servlet版本的不同使用不同的工厂类</span>
        <span class="token class-name">String</span> rolePrefix <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requestFactory <span class="token operator">=</span> <span class="token function">isServlet3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">createServlet3Factory</span><span class="token punctuation">(</span>rolePrefix<span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">HttpServlet25RequestFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver<span class="token punctuation">,</span> rolePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets the {@link AuthenticationTrustResolver} to be used. The default is
     * {@link AuthenticationTrustResolverImpl}.
     *
     * @param trustResolver the {@link AuthenticationTrustResolver} to use. Cannot be
     *                      null.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTrustResolver</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationTrustResolver</span> trustResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>trustResolver<span class="token punctuation">,</span> <span class="token string">&quot;trustResolver cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver <span class="token operator">=</span> trustResolver<span class="token punctuation">;</span>
        <span class="token comment">// trustResolver 变更时更新requestFactory工厂</span>
        <span class="token function">updateFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">HttpServletRequestFactory</span> <span class="token function">createServlet3Factory</span><span class="token punctuation">(</span><span class="token class-name">String</span> rolePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServlet3RequestFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpServlet3RequestFactory</span><span class="token punctuation">(</span>rolePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setTrustResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setLogoutHandlers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns true if the Servlet 3 APIs are detected.
     *
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isServlet3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">hasMethod</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;startAsync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="remembermeauthenticationfilter"><a href="#remembermeauthenticationfilter" class="header-anchor">#</a> RememberMeAuthenticationFilter</h3> <h4 id="概述-11"><a href="#概述-11" class="header-anchor">#</a> 概述</h4> <p>缺省情况下，如果安全配置开启了<code>Remember Me</code>机制，用户在登录界面上会看到<code>Remember Me</code>选择框，如果用户选择了该选择框，会导致生成一个名为<code>remember-me</code>,属性<code>httpOnly</code>为<code>true</code>的<code>cookie</code>，其值是一个<code>RememberMe token</code>。</p> <blockquote><p><code>RememberMe token</code>是一个<code>Base64</code>编码的字符串，解码后格式为<code>{用户名}:{Token过期时间戳}:{Token签名摘要}</code>,比如:<code>admin:1545787408479:d0b0e7a53960e94b521bee3f02ba0bf5</code></p></blockquote> <p>而该过滤器在每次请求到达时会检测<code>SecurityContext</code>属性<code>Authentication</code>是否已经设置。如果没有设置，会进入该过滤器的职责逻辑。它尝试获取名为<code>remember-me</code>的<code>cookie</code>,获取到的话会认为这是一次<code>Remember Me</code>登录尝试，从中分析出用户名,<code>Token</code>过期时间戳，签名摘要，针对用户库验证这些信息，认证通过的话，就会往SecurityContext里面设置<code>Authentication</code>为一个针对请求中所指定用户的<code>RememberMeAuthenticationToken</code>。</p> <p>认证成功的话，也会向应用上下文发布事件<code>InteractiveAuthenticationSuccessEvent</code>。</p> <p>默认情况下不管认证成功还是失败，请求都会被继续执行。</p> <blockquote><p>不过也可以指定一个<code>AuthenticationSuccessHandler</code>给当前过滤器，这样当<code>Remember Me</code>登录认证成功时，处理委托给该<code>AuthenticationSuccessHandler</code>,而不再继续原请求的处理。利用这种机制，可以为<code>Remember Me</code>登录认证成功指定特定的跳转地址。</p></blockquote> <p><code>Remember Me</code>登录认证成功并不代表用户一定可以访问到目标页面，因为如果<code>Remember Me</code>登录认证成功对应用户访问权限级别为<code>isRememberMe</code>，而目标页面需要更高的访问权限级别<code>fullyAuthenticated</code>,这时候请求最终会被拒绝访问目标页面，原因是权限不足(虽然认证通过)。</p> <blockquote><p>如果你想观察该过滤器的行为，可以这么做：</p> <ol><li>在配置中开启<code>Remember Me</code>机制，则此过滤器会被使用;</li> <li>启动应用，打开浏览器,提供正确的用户名密码，选择<code>Remember Me</code>选项,然后提交完成一次成功的登录;</li> <li>关闭整个浏览器;</li> <li>重新打开刚刚关闭的浏览器;</li> <li>直接访问某个受<code>rememberMe</code>访问级别保护的页面，你会看到该过滤器的职责逻辑被执行，目标页面可以访问。
注意 : 这里如果访问某个受<code>fullyAuthenticated</code>访问级别保护的页面，目标页面则不能访问，浏览器会被跳转到登录页面。</li></ol></blockquote> <h4 id="源代码解析-10"><a href="#源代码解析-10" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RememberMeAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token keyword">implements</span>
        <span class="token class-name">ApplicationEventPublisherAware</span> <span class="token punctuation">{</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token keyword">private</span> <span class="token class-name">ApplicationEventPublisher</span> eventPublisher<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RememberMeServices</span> rememberMeServices<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RememberMeAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">,</span>
                                          <span class="token class-name">RememberMeServices</span> rememberMeServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> <span class="token string">&quot;authenticationManager cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">,</span> <span class="token string">&quot;rememberMeServices cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices <span class="token operator">=</span> rememberMeServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> <span class="token string">&quot;authenticationManager must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">,</span> <span class="token string">&quot;rememberMeServices must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果SecurityContext中authentication为空则尝试 remember me 自动认证,</span>
            <span class="token comment">// 缺省情况下这里rememberMeServices会是一个TokenBasedRememberMeServices,</span>
            <span class="token comment">// 其自动 remember me 认证过程如下:</span>
            <span class="token comment">// 1. 获取 cookie remember-me 的值 , 一个base64 编码串;</span>
            <span class="token comment">// 2. 从上面cookie之中解析出信息:用户名，token 过期时间，token 签名</span>
            <span class="token comment">// 3. 检查用户是否存在，token是否过期，token 签名是否一致,</span>
            <span class="token comment">// 上面三个步骤都通过的情况下再检查一下账号是否锁定，过期，禁用，密码过期等现象,</span>
            <span class="token comment">// 如果上面这些验证都通过，则认为认证成功，会构造一个</span>
            <span class="token comment">// RememberMeAuthenticationToken并返回</span>
            <span class="token comment">// 上面的认证失败会有rememberMeAuth==null</span>
            <span class="token class-name">Authentication</span> rememberMeAuth <span class="token operator">=</span> rememberMeServices<span class="token punctuation">.</span><span class="token function">autoLogin</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                    response<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeAuth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Attempt authenticaton via AuthenticationManager</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果上面的 Remember Me 认证成功，则需要使用 authenticationManager</span>
                    <span class="token comment">// 认证该rememberMeAuth</span>
                    rememberMeAuth <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Store to SecurityContextHolder</span>
                    <span class="token comment">// 将认证成功的rememberMeAuth放到SecurityContextHolder中的SecurityContext</span>
                    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 成功时的其他操作:空方法，其实没有其他在这里做</span>
                    <span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityContextHolder populated with remember-me token: '&quot;</span>
                                <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// Fire event</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 发布事件 InteractiveAuthenticationSuccessEvent 到应用上下文</span>
                        eventPublisher
                                <span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>
                                        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>successHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 如果指定了 successHandler ,则调用它，</span>
                        <span class="token comment">// 缺省情况下这个 successHandler  为 null</span>
                        successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
                                rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 如果指定了 successHandler，在它调用之后，不再继续 filter chain 的执行</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> authenticationException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Remember Me 认证失败的情况</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                                <span class="token string">&quot;SecurityContextHolder not populated with remember-me token, as &quot;</span>
                                        <span class="token operator">+</span> <span class="token string">&quot;AuthenticationManager rejected Authentication returned by RememberMeServices: '&quot;</span>
                                        <span class="token operator">+</span> rememberMeAuth
                                        <span class="token operator">+</span> <span class="token string">&quot;'; invalidating remember-me token&quot;</span><span class="token punctuation">,</span>
                                authenticationException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// rememberMeServices 的认证失败处理</span>
                    rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 空方法，这里什么都不做</span>
                    <span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
                            authenticationException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityContextHolder not populated with remember-me token, as it already contained: '&quot;</span>
                        <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 继续 filter chain 执行</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Called if a remember-me token is presented and successfully authenticated by the
     * {@code RememberMeServices} {@code autoLogin} method and the
     * {@code AuthenticationManager}.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                              <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Called if the {@code AuthenticationManager} rejects the authentication object
     * returned from the {@code RememberMeServices} {@code autoLogin} method. This method
     * will not be called when no remember-me token is present in the request and
     * {@code autoLogin} reurns null.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                                <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RememberMeServices</span> <span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rememberMeServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span> eventPublisher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">=</span> eventPublisher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Allows control over the destination a remembered user is sent to when they are
     * successfully authenticated. By default, the filter will just allow the current
     * request to proceed, but if an {@code AuthenticationSuccessHandler} is set, it will
     * be invoked and the {@code doFilter()} method will return immediately, thus allowing
     * the application to redirect the user to a specific URL, regardless of whatthe
     * original request was for.
     * 缺省情况下，Remember Me 登录认证成功时filter chain会继续执行。但是也允许指定一个
     * AuthenticationSuccessHandler , 这样就可以控制 Remember Me 登录认证成功时的目标
     * 跳转地址(当然会忽略原始的请求目标)。
     *
     * @param successHandler the strategy to invoke immediately before returning from
     *                       {@code doFilter()}.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>successHandler<span class="token punctuation">,</span> <span class="token string">&quot;successHandler cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler <span class="token operator">=</span> successHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="anonymousauthenticationfilter"><a href="#anonymousauthenticationfilter" class="header-anchor">#</a> AnonymousAuthenticationFilter</h3> <h4 id="概述-12"><a href="#概述-12" class="header-anchor">#</a> 概述</h4> <p>此过滤器过滤请求,检测<code>SecurityContextHolder</code>中是否存在<code>Authentication</code>对象，如果不存在，说明用户尚未登录，此时为其提供一个匿名<code>Authentication</code>对象:<code>AnonymousAuthentication</code>。</p> <blockquote><p>注意:在整个请求处理的开始,无论当前请求所对应的<code>session</code>中用户是否已经登录,<code>SecurityContextPersistenceFilter</code>
都会确保<code>SecurityContextHolder</code>中保持一个<code>SecurityContext</code>对象。但如果用户尚未登录，这个的<code>SecurityContext</code>对
象会是一个空对象，也就是其属性<code>Authentication</code>为null。然后在该请求处理过程中，如果一直到当前Filter执
行,<code>SecurityContextHolder</code>中<code>SecurityContext</code>对象属性<code>Authentication</code>仍是null,该<code>AnonymousAuthenticationFilter</code>就将其
修改为一个<code>AnonymousAuthentication</code>对象，表明这是一个匿名访问。</p></blockquote> <h4 id="源代码解析-11"><a href="#源代码解析-11" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2004, 2005, 2006 Acegi Technology Pty Limited
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AnonymousAuthenticationToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">AuthorityUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GenericFilterBean</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Detects if there is no {@code Authentication} object in the
 * {@code SecurityContextHolder}, and populates it with one if needed.
 * 检测 SecurityContextHolder中是否存在Authentication对象，如果不存在，说明
 * 用户尚未登录，此时为其提供一个匿名 Authentication: AnonymousAuthentication对象。
 *
 * @author Ben Alex
 * @author Luke Taylor
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnonymousAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token keyword">implements</span>
        <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token comment">// 用于构造匿名Authentication中详情属性的详情来源对象，这里使用一个WebAuthenticationDetailsSource</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authenticationDetailsSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates a filter with a principal named &quot;anonymousUser&quot; and the single authority
     * &quot;ROLE_ANONYMOUS&quot;.
     * 使用外部指定的key构造一个AnonymousAuthenticationFilter:
     * 1. 缺省情况下，Spring Security 配置机制为这里指定的key是一个随机的uuid;
     * 2. 所对应的 princpial(含义指当前登录主体) 是一个字符串&quot;anonymousUser&quot;;
     * 3. 所拥护的角色是 &quot;ROLE_ANONYMOUS&quot;;
     *
     * @param key the key to identify tokens created by this filter
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">AnonymousAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;anonymousUser&quot;</span><span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">createAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;ROLE_ANONYMOUS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用外部指定的参数构造一个AnonymousAuthenticationFilter
     *
     * @param key         key the key to identify tokens created by this filter
     * @param principal   the principal which will be used to represent anonymous users
     * @param authorities the authority list for anonymous users
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">AnonymousAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
                                         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;key cannot be null or empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> <span class="token string">&quot;Anonymous authentication principal must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> <span class="token string">&quot;Anonymous authorities must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authorities <span class="token operator">=</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在当前Filter bean被创建时调用，主要目的是断言三个主要属性都必须已经有效设置</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;key must have length&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> <span class="token string">&quot;Anonymous authentication principal must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authorities<span class="token punctuation">,</span> <span class="token string">&quot;Anonymous authorities must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果SecurityContextHolder中SecurityContext对象的属性authentication是null,</span>
            <span class="token comment">// 将其替换成一个匿名 Authentication: AnonymousAuthentication</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>
                    <span class="token function">createAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Populated SecurityContextHolder with anonymous token: '&quot;</span>
                        <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityContextHolder not populated with anonymous token, as it already contained: '&quot;</span>
                        <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 对SecurityContextHolder中SecurityContext对象的属性authentication做过以上处理之后，继续</span>
        <span class="token comment">// filter chain 的执行</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 根据指定属性key,princpial,authorities和当前环境(servlet web环境)构造一个AnonymousAuthenticationToken</span>
    <span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AnonymousAuthenticationToken</span> auth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnonymousAuthenticationToken</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>
                principal<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        auth<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> auth<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 可以外部指定Authentication对象的详情来源, 缺省情况下使用的是WebAuthenticationDetailsSource,</span>
    <span class="token comment">// 已经在属性authenticationDetailsSource初始化指定</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authenticationDetailsSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationDetailsSource<span class="token punctuation">,</span>
                <span class="token string">&quot;AuthenticationDetailsSource required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource <span class="token operator">=</span> authenticationDetailsSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> principal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="sessionmanagementfilter"><a href="#sessionmanagementfilter" class="header-anchor">#</a> SessionManagementFilter</h3> <h4 id="概述-13"><a href="#概述-13" class="header-anchor">#</a> 概述</h4> <p>该过滤器会检测从当前请求处理开始到目前为止的过程中是否发生了用户登录认证行为(比如这是一个用户名/密码表单提交的请求处理过程)，如果检测到这一情况，执行相应的<code>session</code>认证策略(一个<code>SessionAuthenticationStrategy</code>)，然后继续继续请求的处理。</p> <p>针对<code>Servlet 3.1+</code>,缺省所使用的<code>SessionAuthenticationStrategy</code>会是一个<code>ChangeSessionIdAuthenticationStrategy</code>和<code>CsrfAuthenticationStrategy</code>组合。<code>ChangeSessionIdAuthenticationStrategy</code>会为登录的用户创建一个新的<code>session</code>，而<code>CsrfAuthenticationStrategy</code>会创建新的<code>csrf token</code>用于<code>CSRF</code>保护。</p> <p>如果当前过滤器链中启用了<code>UsernamePasswordAuthenticationFilter</code>,实际上本过滤器<code>SessionManagementFilter</code>并不会真正被执行到上面所说的逻辑。因为在<code>UsernamePasswordAuthenticationFilter</code>中，一旦用户登录认证发生它会先执行上述的逻辑。因此到<code>SessionManagementFilter</code>执行的时候，它会发现安全上下文存储库中已经有相应的安全上下文了，从而不再重复执行上面的逻辑。</p> <p>另外需要注意的是，如果相应的<code>session</code>认证策略执行失败的话，整个成功的用户登录认证行为会被该过滤器否定，相应新建的<code>SecurityContextHolder</code>中的安全上下文会被清除，所设定的<code>AuthenticationFailureHandler</code>逻辑会被执行。</p> <h4 id="源代码解析-12"><a href="#源代码解析-12" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Detects that a user has been authenticated since the start of the request and, if they
 * have, calls the configured {@link SessionAuthenticationStrategy} to perform any
 * session-related activity such as activating session-fixation protection mechanisms or
 * checking for multiple concurrent logins.
 * &lt;p&gt;
 * 检测从当前请求处理最初到现在整个处理过程中是否发生了用户登录认证，如果确实发生了，调用所配置的
 * SessionAuthenticationStrategy(session认证策略)执行与session相关的操作。比如针对session-fxation攻击
 * 保护机制对应的策略可能是为废弃登录前的session为登录用户生成一个新的session等。
 *
 * @author Martin Algesten
 * @author Luke Taylor
 * @since 2.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionManagementFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
    <span class="token comment">// ~ Static fields/initializers</span>
    <span class="token comment">// =====================================================================================</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FILTER_APPLIED <span class="token operator">=</span> <span class="token string">&quot;__spring_security_session_mgmt_filter_applied&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token comment">// 安全上下文存储库，要和当前请求处理过程中其他filter配合，一般由配置阶段使用统一配置设置进来</span>
    <span class="token comment">// 缺省使用基于http session的安全上下文存储库:HttpSessionSecurityContextRepository</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">;</span>
    <span class="token comment">// session 认证策略</span>
    <span class="token comment">// 缺省是一个 CompositeSessionAuthenticationStrategy 对象，应用了组合模式，组合一些其他的</span>
    <span class="token comment">// session 认证策略实现，比如针对Servlet 3.1+,缺省会是 ChangeSessionIdAuthenticationStrategy跟</span>
    <span class="token comment">// CsrfAuthenticationStrategy组合</span>
    <span class="token keyword">private</span> <span class="token class-name">SessionAuthenticationStrategy</span> sessionAuthenticationStrategy<span class="token punctuation">;</span>
    <span class="token comment">// 用于识别一个Authentication是哪种类型:anonymous ? remember ?</span>
    <span class="token comment">// 配置阶段统一指定，缺省使用 AuthenticationTrustResolverImpl</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationTrustResolver</span> trustResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationTrustResolverImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遇到无效session时的处理策略，缺省值为null</span>
    <span class="token keyword">private</span> <span class="token class-name">InvalidSessionStrategy</span> invalidSessionStrategy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 认证失败处理器，比如form用户名/密码登录如果失败可能会引导用户重新发起表单认证</span>
    <span class="token comment">// 缺省使用SimpleUrlAuthenticationFailureHandler</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SessionManagementFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SessionFixationProtectionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">SessionManagementFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">,</span>
                                   <span class="token class-name">SessionAuthenticationStrategy</span> sessionStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">,</span>
                <span class="token string">&quot;SecurityContextRepository cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>sessionStrategy<span class="token punctuation">,</span> <span class="token string">&quot;SessionAuthenticationStrategy cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository <span class="token operator">=</span> securityContextRepository<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionAuthenticationStrategy <span class="token operator">=</span> sessionStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果在当前请求过程中该过滤器已经应用过，则不在二次应用，继续filter chain的执行</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 该过滤器要执行了，在请求上设置该过滤器已经执行过的标记，避免在该请求的同一处理过程中</span>
        <span class="token comment">// 本过滤器执行二遍</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 检测securityContextRepository是否已经保存了针对当前请求的安全上下文对象 ：</span>
        <span class="token comment">// 1. 未登录用户访问登录保护url的情况 : 否</span>
        <span class="token comment">// 2. 未登录用户访问登录页面url的情况 : (不会走到这里，已经被登录页面生成Filter拦截)</span>
        <span class="token comment">// 3. 未登录用户访问公开url的情况 : 否</span>
        <span class="token comment">// 4. 登录用户访问公开url的情况 : 是</span>
        <span class="token comment">// 5. 登录用户访问登录保护url的情况 : 是</span>
        <span class="token comment">// 6. 登录用户访问公开url的情况 : 是</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">containsContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果securityContextRepository中没有保存安全上下文对象，</span>
            <span class="token comment">// 但是SecurityContextHolder中安全上下文对象的authentication属性</span>
            <span class="token comment">// 不为null或者匿名，则说明从请求处理开始到现在出现了用户登录认证成功的情况</span>
            <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>trustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// The user has been authenticated during the current request, so call the</span>
                <span class="token comment">// session strategy</span>
                <span class="token comment">// 认证登录成功的情况被检测到，执行相应的session认证策略</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    sessionAuthenticationStrategy<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span>
                            request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果session认证策略执行出现异常，则拒绝该用户登录认证，</span>
                    <span class="token comment">// 清除已经登录成功的安全上下文，并调用相应的failureHandler认证失败逻辑</span>
                    <span class="token comment">// The session strategy can reject the authentication</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;SessionAuthenticationStrategy rejected the authentication object&quot;</span><span class="token punctuation">,</span>
                            e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Eagerly save the security context to make it available for any possible</span>
                <span class="token comment">// re-entrant</span>
                <span class="token comment">// requests which may occur before the current request completes.</span>
                <span class="token comment">// SEC-1396.</span>
                <span class="token comment">// 如果该请求处理过程中出现了用户成功登录的情况，并且相应的session认证策略已经</span>
                <span class="token comment">// 执行成功，直接在securityContextRepository保存新建的针对已经登录用户的安全上下文，</span>
                <span class="token comment">// 这样之后，在当前请求处理结束前，遇到任何可重入的请求，它们就可以利用该信息了。</span>
                securityContextRepository<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// No security context or authentication present. Check for a session</span>
                <span class="token comment">// timeout</span>
                <span class="token comment">// authentication 为 null 或者 匿名 或者 RememberMe 的情况,</span>
                <span class="token comment">// 检测是否遇到了session过期或者提供了无效的session id，如果遇到了，</span>
                <span class="token comment">// 并且设置了相应的无效session处理器invalidSessionStrategy，则最相应的处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isRequestedSessionIdValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Requested session ID &quot;</span>
                                <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is invalid.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>invalidSessionStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        invalidSessionStrategy
                                <span class="token punctuation">.</span><span class="token function">onInvalidSessionDetected</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets the strategy which will be invoked instead of allowing the filter chain to
     * prceed, if the user agent requests an invalid session Id. If the property is not
     * set, no action will be taken.
     *
     * @param invalidSessionStrategy the strategy to invoke. Typically a
     *                               {@link SimpleRedirectInvalidSessionStrategy}.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setInvalidSessionStrategy</span><span class="token punctuation">(</span><span class="token class-name">InvalidSessionStrategy</span> invalidSessionStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>invalidSessionStrategy <span class="token operator">=</span> invalidSessionStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * The handler which will be invoked if the &lt;tt&gt;AuthenticatedSessionStrategy&lt;/tt&gt;
     * raises a &lt;tt&gt;SessionAuthenticationException&lt;/tt&gt;, indicating that the user is not
     * allowed to be authenticated for this session (typically because they already have
     * too many sessions open).
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>failureHandler<span class="token punctuation">,</span> <span class="token string">&quot;failureHandler cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler <span class="token operator">=</span> failureHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Sets the {@link AuthenticationTrustResolver} to be used. The default is
     * {@link AuthenticationTrustResolverImpl}.
     *
     * @param trustResolver the {@link AuthenticationTrustResolver} to use. Cannot be
     *                      null.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTrustResolver</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationTrustResolver</span> trustResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>trustResolver<span class="token punctuation">,</span> <span class="token string">&quot;trustResolver cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver <span class="token operator">=</span> trustResolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="exceptiontranslationfilter"><a href="#exceptiontranslationfilter" class="header-anchor">#</a> ExceptionTranslationFilter</h3> <h4 id="概述-14"><a href="#概述-14" class="header-anchor">#</a> 概述</h4> <p>该过滤器的作用是处理过滤器链中发生的 <code>AccessDeniedException</code> 和 <code>AuthenticationException</code> 异常，将它们转换成相应的HTTP响应。</p> <p>当检测到 <code>AuthenticationException</code> 异常时，该过滤器会启动 <code>authenticationEntryPoint</code>,也就是启动认证流程。</p> <p>当检测到 <code>AccessDeniedException</code> 异常时，该过滤器先判断当前用户是否为匿名访问或者<code>Remember Me</code>访问。如果是这两种情况之一，会启动 <code>authenticationEntryPoint</code>逻辑。如果安全配置开启了用户名/密码表单认证，通常这个<code>authenticationEntryPoint</code>会对应到一个<code>LoginUrlAuthenticationEntryPoint</code>。它执行时会将用户带到登录页面，开启登录认证流程。</p> <p>如果不是匿名访问或者<code>Remember Me</code>访问，接下来的处理会交给一个 <code>AccessDeniedHandler</code> 来完成。缺省情况下，这个 <code>AccessDeniedHandler</code> 的实现类是 <code>AccessDeniedHandlerImpl</code>，它会:</p> <ol><li>请求添加<code>HTTP 403</code>异常属性,记录相应的异常;</li> <li>然后往写入响应HTTP状态码<code>403</code>;</li> <li>并<code>foward</code>到相应的错误页面。</li></ol> <p>使用该过滤器必须要设置以下属性:</p> <ol><li><code>authenticationEntryPoint</code>:用于启动认证流程的处理器(handler)</li> <li><code>requestCache</code>:认证过程中涉及到保存请求时使用的请求缓存策略，缺省情况下是基于<code>session</code>的<code>HttpSessionRequestCache</code></li></ol> <blockquote><p>如果你想观察该过滤器的行为，可以在未登录状态下访问一个受登录保护的页面，系统会抛出<code>AccessDeniedException</code>并最终进入该Filter的职责流程。</p></blockquote> <h4 id="源代码解析-13"><a href="#源代码解析-13" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2004-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>access</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationTrustResolver</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationTrustResolverImpl</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationEntryPoint</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>savedrequest<span class="token punctuation">.</span></span><span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>savedrequest<span class="token punctuation">.</span></span><span class="token class-name">RequestCache</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ThrowableAnalyzer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ThrowableCauseExtractor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GenericFilterBean</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionTranslationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token keyword">private</span> <span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedHandlerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token comment">// 用于判断一个Authentication是否Anonymous,Remember Me,</span>
    <span class="token comment">// 缺省使用 AuthenticationTrustResolverImpl</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationTrustResolver</span> authenticationTrustResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationTrustResolverImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于分析一个Throwable抛出的原因，使用本类自定义的嵌套类DefaultThrowableAnalyzer，</span>
    <span class="token comment">// 主要是加入了对ServletException的分析</span>
    <span class="token keyword">private</span> <span class="token class-name">ThrowableAnalyzer</span> throwableAnalyzer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultThrowableAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 请求缓存，缺省使用HttpSessionRequestCache，在遇到异常启动认证过程时会用到,</span>
    <span class="token comment">// 因为要先把原始请求缓存下来，一旦认证成功结果，需要把原始请求提出重新跳转到相应URL</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestCache</span> requestCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ExceptionTranslationFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>authenticationEntryPoint<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ExceptionTranslationFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">,</span>
                                      <span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationEntryPoint<span class="token punctuation">,</span>
                <span class="token string">&quot;authenticationEntryPoint cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requestCache<span class="token punctuation">,</span> <span class="token string">&quot;requestCache cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint <span class="token operator">=</span> authenticationEntryPoint<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache <span class="token operator">=</span> requestCache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationEntryPoint<span class="token punctuation">,</span>
                <span class="token string">&quot;authenticationEntryPoint must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

        <span class="token comment">// 在任何请求到达时不做任何操作，直接放行，继续filter chain的执行，</span>
        <span class="token comment">// 但是使用一个 try-catch 来捕获filter chain中接下来会发生的各种异常，</span>
        <span class="token comment">// 重点关注其中的以下异常，其他异常继续向外抛出 :</span>
        <span class="token comment">// AuthenticationException : 认证失败异常,通常因为认证信息错误导致</span>
        <span class="token comment">// AccessDeniedException : 访问被拒绝异常，通常因为权限不足导致</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Chain processed normally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Try to extract a SpringSecurityException from the stacktrace</span>
            <span class="token class-name">Throwable</span><span class="token punctuation">[</span><span class="token punctuation">]</span> causeChain <span class="token operator">=</span> throwableAnalyzer<span class="token punctuation">.</span><span class="token function">determineCauseChain</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 检测ex是否由AuthenticationException或者AccessDeniedException异常导致</span>
            <span class="token class-name">RuntimeException</span> ase <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> throwableAnalyzer
                    <span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ase <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ase <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> throwableAnalyzer<span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span>
                        <span class="token class-name">AccessDeniedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ase <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果response已经提交，则没办法向响应中转换和写入这些异常了，只好抛一个异常</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to handle the Spring Security Exception because the response is already committed.&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果ex是由AuthenticationException或者AccessDeniedException异常导致，</span>
                <span class="token comment">// 并且响应尚未提交，这里将这些Spring Security异常翻译成相应的 http response。</span>
                <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> ase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Rethrow ServletExceptions and RuntimeExceptions as-is</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">ServletException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">ServletException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Wrap other Exceptions. This shouldn't actually happen</span>
                <span class="token comment">// as we've already covered all the possibilities for doFilter</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token function">getAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationTrustResolver</span> <span class="token function">getAuthenticationTrustResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authenticationTrustResolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 此方法仅用于处理两种Spring Security 异常:</span>
    <span class="token comment">// AuthenticationException , AccessDeniedException</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                               <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Authentication exception occurred; redirecting to authentication entry point&quot;</span><span class="token punctuation">,</span>
                    exception<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果是 AuthenticationException 异常，启动认证流程</span>
            <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span> <span class="token operator">||</span> authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isRememberMe</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果当前认证token是匿名或者RememberMe token</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Access is denied (user is &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;anonymous&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;not fully authenticated&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;); redirecting to authentication entry point&quot;</span><span class="token punctuation">,</span>
                        exception<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果是 AccessDeniedException 异常，而且当前登录主体是匿名状态或者</span>
                <span class="token comment">// Remember Me认证，则也启动认证流程</span>
                <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>
                        request<span class="token punctuation">,</span>
                        response<span class="token punctuation">,</span>
                        chain<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">(</span>
                                messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>
                                        <span class="token string">&quot;ExceptionTranslationFilter.insufficientAuthentication&quot;</span><span class="token punctuation">,</span>
                                        <span class="token string">&quot;Full authentication is required to access this resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Access is denied (user is not anonymous); delegating to AccessDeniedHandler&quot;</span><span class="token punctuation">,</span>
                        exception<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果是 AccessDeniedException 异常,而且当前用户不是匿名，也不是</span>
                <span class="token comment">// Remember Me, 而是真正经过认证的某个用户，则说明是该用户权限不足,</span>
                <span class="token comment">// 则交给 accessDeniedHandler 处理，缺省告知其权限不足</span>
                <span class="token comment">// 注意 : 如果当前被请求的页面被配置成RememberMe权限可访问，但实际上</span>
                <span class="token comment">// 当前当前安全上下文中的token是fullAuthenticated的，则也会走到这个流程</span>
                accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发起认证流程</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
                                           <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
                                           <span class="token class-name">AuthenticationException</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// SEC-112: Clear the SecurityContextHolder's Authentication, as the</span>
        <span class="token comment">// existing Authentication is no longer considered valid</span>
        <span class="token comment">// 将SecurityContextHolder中SecurityContext的authentication设置为null</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 保存当前请求，一旦认证成功，认证机制会再次提取该请求并跳转到该请求对应的页面</span>
        requestCache<span class="token punctuation">.</span><span class="token function">saveRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 准备工作已经做完，开始认证流程</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Calling Authentication entry point.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">commence</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccessDeniedHandler</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>accessDeniedHandler<span class="token punctuation">,</span> <span class="token string">&quot;AccessDeniedHandler required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler <span class="token operator">=</span> accessDeniedHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationTrustResolver</span><span class="token punctuation">(</span>
            <span class="token class-name">AuthenticationTrustResolver</span> authenticationTrustResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authenticationTrustResolver<span class="token punctuation">,</span>
                <span class="token string">&quot;authenticationTrustResolver must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver <span class="token operator">=</span> authenticationTrustResolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThrowableAnalyzer</span><span class="token punctuation">(</span><span class="token class-name">ThrowableAnalyzer</span> throwableAnalyzer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>throwableAnalyzer<span class="token punctuation">,</span> <span class="token string">&quot;throwableAnalyzer must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer <span class="token operator">=</span> throwableAnalyzer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Default implementation of &lt;code&gt;ThrowableAnalyzer&lt;/code&gt; which is capable of also
     * unwrapping &lt;code&gt;ServletException&lt;/code&gt;s.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultThrowableAnalyzer</span> <span class="token keyword">extends</span> <span class="token class-name">ThrowableAnalyzer</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * @see org.springframework.security.web.util.ThrowableAnalyzer#initExtractorMap()
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initExtractorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initExtractorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">registerExtractor</span><span class="token punctuation">(</span><span class="token class-name">ServletException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableCauseExtractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Throwable</span> <span class="token function">extractCause</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ThrowableAnalyzer</span><span class="token punctuation">.</span><span class="token function">verifyThrowableHierarchy</span><span class="token punctuation">(</span>throwable<span class="token punctuation">,</span>
                            <span class="token class-name">ServletException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletException</span><span class="token punctuation">)</span> throwable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRootCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="filtersecurityinterceptor"><a href="#filtersecurityinterceptor" class="header-anchor">#</a> FilterSecurityInterceptor</h3> <h4 id="概述-15"><a href="#概述-15" class="header-anchor">#</a> 概述</h4> <p>此过滤器<code>FilterSecurityInterceptor</code>是一个请求处理过程中安全机制过滤器链中最后一个<code>filter</code>,它执行真正的<code>HTTP</code>资源安全控制。</p> <p>具体代码实现上，<code>FilterSecurityInterceptor</code>主要是将请求上下文包装成一个<code>FilterInvocation</code>然后对它进行操作。<code>FilterSecurityInterceptor</code>仅仅包含调用<code>FilterInvocation</code>的主要流程。具体的安全控制细节，在其基类<code>AbstractSecurityInterceptor</code>中实现。</p> <h4 id="源代码解析-14"><a href="#源代码解析-14" class="header-anchor">#</a> 源代码解析</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2004, 2005, 2006 Acegi Technology Pty Limited
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>access<span class="token punctuation">.</span>intercept</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">SecurityMetadataSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>intercept<span class="token punctuation">.</span></span><span class="token class-name">AbstractSecurityInterceptor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>intercept<span class="token punctuation">.</span></span><span class="token class-name">InterceptorStatusToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">FilterInvocation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Performs security handling of HTTP resources via a filter implementation.
 * &lt;p&gt;
 * The &lt;code&gt;SecurityMetadataSource&lt;/code&gt; required by this security interceptor is of
 * type {@link FilterInvocationSecurityMetadataSource}.
 * &lt;p&gt;
 * Refer to {@link AbstractSecurityInterceptor} for details on the workflow.
 * &lt;/p&gt;
 *
 * @author Ben Alex
 * @author Rob Winch
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterSecurityInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSecurityInterceptor</span> <span class="token keyword">implements</span>
        <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token comment">// ~ Static fields/initializers</span>
    <span class="token comment">// =====================================================================================</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FILTER_APPLIED <span class="token operator">=</span> <span class="token string">&quot;__spring_security_filterSecurityInterceptor_filterApplied&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token keyword">private</span> <span class="token class-name">FilterInvocationSecurityMetadataSource</span> securityMetadataSource<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> observeOncePerRequest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token comment">/**
     * Not used (we rely on IoC container lifecycle services instead)
     *
     * @param arg0 ignored
     * @throws ServletException never thrown
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> arg0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Not used (we rely on IoC container lifecycle services instead)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Method that is actually called by the filter chain. Simply delegates to the
     * {@link #invoke(FilterInvocation)} method.
     *
     * @param request  the servlet request
     * @param response the servlet response
     * @param chain    the filter chain
     * @throws IOException      if the filter chain fails
     * @throws ServletException if the filter chain fails
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span>
                         <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 封装请求上下文为一个FilterInvocation,然后调用该FilterInvocation执行安全认证</span>
        <span class="token class-name">FilterInvocation</span> fi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterInvocation</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">invoke</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">FilterInvocationSecurityMetadataSource</span> <span class="token function">getSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityMetadataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityMetadataSource</span> <span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityMetadataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token class-name">FilterInvocationSecurityMetadataSource</span> newSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>securityMetadataSource <span class="token operator">=</span> newSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">FilterInvocation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">FilterInvocation</span> fi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> observeOncePerRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// filter already applied to this request and user wants us to observe</span>
            <span class="token comment">// once-per-request handling, so don't re-do security checking</span>
            <span class="token comment">// 如果被指定为在整个请求处理过程中只能执行最多一次 ,并且监测到已经执行过,</span>
            <span class="token comment">// 则直接放行，继续 filter chain 的执行</span>
            fi<span class="token punctuation">.</span><span class="token function">getChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// first time this request being called, so perform security checking</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> observeOncePerRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果被指定为在整个请求处理过程中只能执行最多一次 ,并且监测到尚未执行,</span>
                <span class="token comment">// 则设置已经执行标志，随后执行职责逻辑</span>
                fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>FILTER_APPLIED<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 这里是该过滤器进行安全检查的职责逻辑,具体实现在基类AbstractSecurityInterceptor</span>
            <span class="token comment">// 主要是进行必要的认证和授权检查，如果遇到相关异常则抛出异常，之后的过滤器链</span>
            <span class="token comment">// 调用不会继续进行</span>
            <span class="token class-name">InterceptorStatusToken</span> token <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">beforeInvocation</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果上面通过安全检查，这里继续过滤器的执行</span>
                fi<span class="token punctuation">.</span><span class="token function">getChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finallyInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 指定是否在整个请求处理过程中该过滤器只被执行一次，缺省是 true。</span>
    <span class="token comment">// 也存在在整个请求处理过程中该过滤器需要执行多次的情况，比如JSP foward/include</span>
    <span class="token comment">// 等情况。</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isObserveOncePerRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> observeOncePerRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setObserveOncePerRequest</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> observeOncePerRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observeOncePerRequest <span class="token operator">=</span> observeOncePerRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2004, 2005, 2006 Acegi Technology Pty Limited
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>intercept</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>logging<span class="token punctuation">.</span></span><span class="token class-name">Log</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>logging<span class="token punctuation">.</span></span><span class="token class-name">LogFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDecisionManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">SecurityMetadataSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationCredentialsNotFoundEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationFailureEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">AuthorizedEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">PublicInvocationEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationCredentialsNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Abstract class that implements security interception for secure objects.
 * &lt;p&gt;
 * The &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; will ensure the proper startup
 * configuration of the security interceptor. It will also implement the proper handling
 * of secure object invocations, namely:
 * &lt;ol&gt;
 * &lt;li&gt;Obtain the {@link Authentication} object from the {@link SecurityContextHolder}.&lt;/li&gt;
 * &lt;li&gt;Determine if the request relates to a secured or public invocation by looking up
 * the secure object request against the {@link SecurityMetadataSource}.&lt;/li&gt;
 * &lt;li&gt;For an invocation that is secured (there is a list of &lt;code&gt;ConfigAttribute&lt;/code&gt;s
 * for the secure object invocation):
 * &lt;ol type=&quot;a&quot;&gt;
 * &lt;li&gt;If either the
 * {@link org.springframework.security.core.Authentication#isAuthenticated()} returns
 * &lt;code&gt;false&lt;/code&gt;, or the {@link #alwaysReauthenticate} is &lt;code&gt;true&lt;/code&gt;,
 * authenticate the request against the configured {@link AuthenticationManager}. When
 * authenticated, replace the &lt;code&gt;Authentication&lt;/code&gt; object on the
 * &lt;code&gt;SecurityContextHolder&lt;/code&gt; with the returned value.&lt;/li&gt;
 * &lt;li&gt;Authorize the request against the configured {@link AccessDecisionManager}.&lt;/li&gt;
 * &lt;li&gt;Perform any run-as replacement via the configured {@link RunAsManager}.&lt;/li&gt;
 * &lt;li&gt;Pass control back to the concrete subclass, which will actually proceed with
 * executing the object. A {@link InterceptorStatusToken} is returned so that after the
 * subclass has finished proceeding with execution of the object, its finally clause can
 * ensure the &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; is re-called and tidies up
 * correctly using {@link #finallyInvocation(InterceptorStatusToken)}.&lt;/li&gt;
 * &lt;li&gt;The concrete subclass will re-call the &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; via
 * the {@link #afterInvocation(InterceptorStatusToken, Object)} method.&lt;/li&gt;
 * &lt;li&gt;If the &lt;code&gt;RunAsManager&lt;/code&gt; replaced the &lt;code&gt;Authentication&lt;/code&gt; object,
 * return the &lt;code&gt;SecurityContextHolder&lt;/code&gt; to the object that existed after the call
 * to &lt;code&gt;AuthenticationManager&lt;/code&gt;.&lt;/li&gt;
 * &lt;li&gt;If an &lt;code&gt;AfterInvocationManager&lt;/code&gt; is defined, invoke the invocation manager
 * and allow it to replace the object due to be returned to the caller.&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 * &lt;li&gt;For an invocation that is public (there are no &lt;code&gt;ConfigAttribute&lt;/code&gt;s for
 * the secure object invocation):
 * &lt;ol type=&quot;a&quot;&gt;
 * &lt;li&gt;As described above, the concrete subclass will be returned an
 * &lt;code&gt;InterceptorStatusToken&lt;/code&gt; which is subsequently re-presented to the
 * &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; after the secure object has been executed. The
 * &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; will take no further action when its
 * {@link #afterInvocation(InterceptorStatusToken, Object)} is called.&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 * &lt;li&gt;Control again returns to the concrete subclass, along with the &lt;code&gt;Object&lt;/code&gt;
 * that should be returned to the caller. The subclass will then return that result or
 * exception to the original caller.&lt;/li&gt;
 * &lt;/ol&gt;
 *
 * @author Ben Alex
 * @author Rob Winch
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSecurityInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span>
        <span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>
    <span class="token comment">// ~ Static fields/initializers</span>
    <span class="token comment">// =====================================================================================</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Instance fields</span>
    <span class="token comment">// ================================================================================================</span>

    <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ApplicationEventPublisher</span> eventPublisher<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AccessDecisionManager</span> accessDecisionManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AfterInvocationManager</span> afterInvocationManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NoOpAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RunAsManager</span> runAsManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullRunAsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> alwaysReauthenticate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> rejectPublicInvocations <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> validateConfigAttributes <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> publishAuthorizationSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// ~ Methods</span>
    <span class="token comment">// ========================================================================================================</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Subclass must provide a non-null response to getSecureObjectClass()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">,</span> <span class="token string">&quot;A message source must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">,</span> <span class="token string">&quot;An AuthenticationManager is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">,</span> <span class="token string">&quot;An AccessDecisionManager is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>runAsManager<span class="token punctuation">,</span> <span class="token string">&quot;A RunAsManager is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;An SecurityMetadataSource is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;SecurityMetadataSource does not support secure object class: &quot;</span>
                        <span class="token operator">+</span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>runAsManager<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;RunAsManager does not support secure object class: &quot;</span>
                        <span class="token operator">+</span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;AccessDecisionManager does not support secure object class: &quot;</span>
                        <span class="token operator">+</span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;AfterInvocationManager does not support secure object class: &quot;</span>
                            <span class="token operator">+</span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validateConfigAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributeDefs <span class="token operator">=</span> <span class="token keyword">this</span>
                    <span class="token punctuation">.</span><span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllConfigAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>attributeDefs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Could not validate configuration attributes as the SecurityMetadataSource did not return &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;any attributes from getAllConfigAttributes()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> unsupportedAttrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attr <span class="token operator">:</span> attributeDefs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>runAsManager<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager
                        <span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    unsupportedAttrs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>unsupportedAttrs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Unsupported configuration attributes: &quot;</span> <span class="token operator">+</span> unsupportedAttrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Validated configuration attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">InterceptorStatusToken</span> <span class="token function">beforeInvocation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">&quot;Object was null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> debug <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Security invocation attempted for object &quot;</span>
                            <span class="token operator">+</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">&quot; but AbstractSecurityInterceptor only configured to support secure objects of type: &quot;</span>
                            <span class="token operator">+</span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 从安全配置中获取安全元数据,记录在 attributes</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> attributes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明该安全对象没有配置安全控制，可以被公开访问</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rejectPublicInvocations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果系统配置了拒绝公开调用，则抛出异常拒绝当前请求</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Secure object invocation &quot;</span>
                                <span class="token operator">+</span> object
                                <span class="token operator">+</span> <span class="token string">&quot; was denied as public invocations are not allowed via this interceptor. &quot;</span>
                                <span class="token operator">+</span> <span class="token string">&quot;This indicates a configuration error because the &quot;</span>
                                <span class="token operator">+</span> <span class="token string">&quot;rejectPublicInvocations property is set to 'true'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Public object - authentication not attempted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PublicInvocationEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 该资源没有设置安全，可以公开访问，不做相应的安全检查，返回 null，</span>
            <span class="token comment">// 表示不需要做后续处理</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// no further work post-invocation</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Secure object: &quot;</span> <span class="token operator">+</span> object <span class="token operator">+</span> <span class="token string">&quot;; Attributes: &quot;</span> <span class="token operator">+</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果安全认证token不存在，则抛出异常 AuthenticationCredentialsNotFoundException</span>
            <span class="token function">credentialsNotFound</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;AbstractSecurityInterceptor.authenticationNotFound&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;An Authentication object was not found in the SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果安全认证token存在，则检查是否需要认证，如果需要，则执行认证并更行</span>
        <span class="token comment">// 安全上下文中的安全认证token，如果认证失败，抛出异常 AuthenticationException</span>
        <span class="token class-name">Authentication</span> authenticated <span class="token operator">=</span> <span class="token function">authenticateIfRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Attempt authorization</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 现在已经确保用户通过了认证，现在基于登录的当前用户信息，和目标资源的安全配置属性</span>
            <span class="token comment">// 进行相应的权限检查,如果检查失败，则抛出相应的异常 AccessDeniedException</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">.</span><span class="token function">decide</span><span class="token punctuation">(</span>authenticated<span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorizationFailureEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> authenticated<span class="token punctuation">,</span>
                    accessDeniedException<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> accessDeniedException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization successful&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>publishAuthorizationSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorizedEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> authenticated<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Attempt to run as a different user</span>
        <span class="token comment">// 如果设置了 RunAsManager， 尝试将当前安全认证token修改为另外一个run-as用户,</span>
        <span class="token comment">// 缺省是 NullRunAsManager， 其实相当于没有启用 run-as, 下面的 runAs 缺省会是</span>
        <span class="token comment">// null</span>
        <span class="token class-name">Authentication</span> runAs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>runAsManager<span class="token punctuation">.</span><span class="token function">buildRunAs</span><span class="token punctuation">(</span>authenticated<span class="token punctuation">,</span> object<span class="token punctuation">,</span>
                attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>runAs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;RunAsManager did not change Authentication object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// no further work post-invocation</span>
            <span class="token comment">// 注意这里第二个参数为 false, 表示请求处理完之后再次回到该filter时不需要在刷新安全认证token</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorStatusToken</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    attributes<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Switching to RunAs Authentication: &quot;</span> <span class="token operator">+</span> runAs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">SecurityContext</span> origCtx <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>runAs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// need to revert to token.Authenticated post-invocation</span>
            <span class="token comment">// 注意这里第二个参数为 true, 表示请求处理完之后再次回到该filter时需要在刷新安全认证token :</span>
            <span class="token comment">// 恢复到 run-as 之前的安全认证token</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorStatusToken</span><span class="token punctuation">(</span>origCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Cleans up the work of the &lt;tt&gt;AbstractSecurityInterceptor&lt;/tt&gt; after the secure
     * object invocation has been completed. This method should be invoked after the
     * secure object invocation and before afterInvocation regardless of the secure object
     * invocation returning successfully (i.e. it should be done in a finally block).
     *
     * @param token as returned by the {@link #beforeInvocation(Object)} method
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finallyInvocation</span><span class="token punctuation">(</span><span class="token class-name">InterceptorStatusToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span><span class="token function">isContextHolderRefreshRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Reverting to original Authentication: &quot;</span>
                        <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Completes the work of the &lt;tt&gt;AbstractSecurityInterceptor&lt;/tt&gt; after the secure
     * object invocation has been completed.
     *
     * @param token          as returned by the {@link #beforeInvocation(Object)} method
     * @param returnedObject any object returned from the secure object invocation (may be
     *                       &lt;tt&gt;null&lt;/tt&gt;)
     * @return the object the secure object invocation should ultimately return to its
     * caller (may be &lt;tt&gt;null&lt;/tt&gt;)
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">afterInvocation</span><span class="token punctuation">(</span><span class="token class-name">InterceptorStatusToken</span> token<span class="token punctuation">,</span> <span class="token class-name">Object</span> returnedObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// public object</span>
            <span class="token keyword">return</span> returnedObject<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">finallyInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// continue to clean in this method for passivity</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>afterInvocationManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Attempt after invocation handling</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                returnedObject <span class="token operator">=</span> afterInvocationManager<span class="token punctuation">.</span><span class="token function">decide</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getSecureObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token
                        <span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> returnedObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AuthorizationFailureEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationFailureEvent</span><span class="token punctuation">(</span>
                        token<span class="token punctuation">.</span><span class="token function">getSecureObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token
                        <span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        accessDeniedException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">throw</span> accessDeniedException<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> returnedObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Checks the current authentication token and passes it to the AuthenticationManager
     * if {@link org.springframework.security.core.Authentication#isAuthenticated()}
     * returns false or the property &lt;tt&gt;alwaysReauthenticate&lt;/tt&gt; has been set to true.
     *
     * @return an authenticated &lt;tt&gt;Authentication&lt;/tt&gt; object.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Authentication</span> <span class="token function">authenticateIfRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>alwaysReauthenticate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Previously Authenticated: &quot;</span> <span class="token operator">+</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        authentication <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// We don't authenticated.setAuthentication(true), because each provider should do</span>
        <span class="token comment">// that</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Successfully Authenticated: &quot;</span> <span class="token operator">+</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Helper method which generates an exception containing the passed reason, and
     * publishes an event to the application context.
     * &lt;p&gt;
     * Always throws an exception.
     *
     * @param reason        to be provided in the exception detail
     * @param secureObject  that was being called
     * @param configAttribs that were defined for the secureObject
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">credentialsNotFound</span><span class="token punctuation">(</span><span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token class-name">Object</span> secureObject<span class="token punctuation">,</span>
                                     <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttribs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AuthenticationCredentialsNotFoundException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationCredentialsNotFoundException</span><span class="token punctuation">(</span>
                reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AuthenticationCredentialsNotFoundEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationCredentialsNotFoundEvent</span><span class="token punctuation">(</span>
                secureObject<span class="token punctuation">,</span> configAttribs<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AccessDecisionManager</span> <span class="token function">getAccessDecisionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> accessDecisionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AfterInvocationManager</span> <span class="token function">getAfterInvocationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> afterInvocationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RunAsManager</span> <span class="token function">getRunAsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> runAsManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Indicates the type of secure objects the subclass will be presenting to the
     * abstract parent for processing. This is used to ensure collaborators wired to the
     * {@code AbstractSecurityInterceptor} all support the indicated secure object class.
     *
     * @return the type of secure object the subclass provides services for
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlwaysReauthenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> alwaysReauthenticate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRejectPublicInvocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rejectPublicInvocations<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValidateConfigAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> validateConfigAttributes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">SecurityMetadataSource</span> <span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccessDecisionManager</span><span class="token punctuation">(</span><span class="token class-name">AccessDecisionManager</span> accessDecisionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager <span class="token operator">=</span> accessDecisionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAfterInvocationManager</span><span class="token punctuation">(</span><span class="token class-name">AfterInvocationManager</span> afterInvocationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager <span class="token operator">=</span> afterInvocationManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Indicates whether the &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; should ignore the
     * {@link Authentication#isAuthenticated()} property. Defaults to &lt;code&gt;false&lt;/code&gt;,
     * meaning by default the &lt;code&gt;Authentication.isAuthenticated()&lt;/code&gt; property is
     * trusted and re-authentication will not occur if the principal has already been
     * authenticated.
     *
     * @param alwaysReauthenticate &lt;code&gt;true&lt;/code&gt; to force
     *                             &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; to disregard the value of
     *                             &lt;code&gt;Authentication.isAuthenticated()&lt;/code&gt; and always re-authenticate the
     *                             request (defaults to &lt;code&gt;false&lt;/code&gt;).
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAlwaysReauthenticate</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> alwaysReauthenticate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>alwaysReauthenticate <span class="token operator">=</span> alwaysReauthenticate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span>
            <span class="token class-name">ApplicationEventPublisher</span> applicationEventPublisher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">=</span> applicationEventPublisher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> newManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> newManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Only {@code AuthorizationFailureEvent} will be published. If you set this property
     * to {@code true}, {@code AuthorizedEvent}s will also be published.
     *
     * @param publishAuthorizationSuccess default value is {@code false}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPublishAuthorizationSuccess</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> publishAuthorizationSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>publishAuthorizationSuccess <span class="token operator">=</span> publishAuthorizationSuccess<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * By rejecting public invocations (and setting this property to &lt;tt&gt;true&lt;/tt&gt;),
     * essentially you are ensuring that every secure object invocation advised by
     * &lt;code&gt;AbstractSecurityInterceptor&lt;/code&gt; has a configuration attribute defined.
     * This is useful to ensure a &quot;fail safe&quot; mode where undeclared secure objects will be
     * rejected and configuration omissions detected early. An
     * &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; will be thrown by the
     * &lt;tt&gt;AbstractSecurityInterceptor&lt;/tt&gt; if you set this property to &lt;tt&gt;true&lt;/tt&gt; and
     * an attempt is made to invoke a secure object that has no configuration attributes.
     *
     * @param rejectPublicInvocations set to &lt;code&gt;true&lt;/code&gt; to reject invocations of
     *                                secure objects that have no configuration attributes (by default it is
     *                                &lt;code&gt;false&lt;/code&gt; which treats undeclared secure objects as &quot;public&quot; or
     *                                unauthorized).
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRejectPublicInvocations</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> rejectPublicInvocations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectPublicInvocations <span class="token operator">=</span> rejectPublicInvocations<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRunAsManager</span><span class="token punctuation">(</span><span class="token class-name">RunAsManager</span> runAsManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runAsManager <span class="token operator">=</span> runAsManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValidateConfigAttributes</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> validateConfigAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>validateConfigAttributes <span class="token operator">=</span> validateConfigAttributes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">NoOpAuthenticationManager</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationManager</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span>
                <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot authenticate &quot;</span>
                    <span class="token operator">+</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ty-wssf/blog-docs/edit/master/docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security源码解析 - 过滤器.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">9/1/2021, 8:12:18 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-docs/technology/java/基于OAuth2.0的统一身份认证中心/Spring Security oAuth2.html" class="prev">
        Spring Security oAuth2
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog-docs/assets/js/app.8540afd8.js" defer></script><script src="/blog-docs/assets/js/2.d20fb779.js" defer></script><script src="/blog-docs/assets/js/140.2b733f65.js" defer></script>
  </body>
</html>
