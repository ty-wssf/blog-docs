# åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ

åœ¨æˆ‘ä»¬å‰é¢ä»‹ç»Nacosçš„æ—¶å€™ï¼Œè¯´åˆ°ï¼ŒNacosé™¤äº†å¯ä»¥ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè¿˜å¯ä»¥ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œè€Œåœ¨SpringCloud Netfilxçš„ä½“ç³»ä¸‹ï¼Œè¿™ä¸ªå·¥ä½œæ˜¯ç”±Spring Cloud Configå®Œæˆçš„ã€‚

è‡³äºä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒï¼Ÿå¤§å®¶æƒ³ä¸€ä¸‹ï¼Œåœ¨å¾®æœåŠ¡å¼€å‘ä½“ç³»ä¸‹ï¼Œæ•´ä¸ªç³»ç»Ÿå¯èƒ½è¢«æ‹†åˆ†æˆå‡ åã€ä¸Šç™¾ä¸ªæœåŠ¡ï¼Œåœ¨ç”Ÿäº§çš„æ—¶å€™ï¼Œæ¯ä¸ªæœåŠ¡å¯èƒ½éƒ¨ç½²å‡ åä¸Šç™¾ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸”é€šå¸¸æ˜¯åˆå¤šä¸ªç¯å¢ƒï¼Œå¦‚å¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒã€æˆäº§ç­‰ç­‰ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªé›†ä¸­å¼çš„é…ç½®ä¸­å¿ƒï¼Œä¸€ä¸ªä¸ªå»ç®¡ç†ï¼Œé‚£æ˜¯ä¸€ä¸ªå¤šä¹ˆğŸ˜¥çš„äº‹æƒ…ã€‚

å¥½äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ„‰å¿«åœ°å­¦ä¹ Nacosä½œä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒå§ï¼

## Nacosé…ç½®åŸºæœ¬æ¦‚å¿µ

åœ¨æ­£å¼å¼€å§‹å®æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹Nacosé…ç½®çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚

![Nacosé…ç½®ä¸­å¿ƒæ¦‚å¿µ](https://gitee.com/wuyilong/picture-bed/raw/master/img/9caaf5891cde4f468f16e9a96b112180~tplv-k3u1fbpfcp-watermark.png)

ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Nacosä½œä¸ºé…ç½®ä¸­å¿ƒçš„å‡ ä¸ªä¸»è¦æ¦‚å¿µï¼š

- **å‘½åç©ºé—´**

> åŒºåˆ†ç¯å¢ƒï¼Œæ¯”å¦‚ï¼šdevã€testã€prod ç­‰ç­‰ã€‚

ç”¨äºè¿›è¡Œç§Ÿæˆ·ç²’åº¦çš„é…ç½®éš”ç¦»ã€‚ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥å­˜åœ¨ç›¸åŒçš„ Group æˆ– Data ID çš„é…ç½®ã€‚Namespace çš„å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„é…ç½®çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰ã€‚

- **é…ç½®åˆ†ç»„**

> å¤šä¸ªé…ç½®æ–‡ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œå½¢æˆç»„ï¼Œä¸€èˆ¬ç”¨äºåŒºåˆ†é¡¹ç›®ã€‚ä¾‹å¦‚ï¼ŒæŸå­¦æ ¡å¤šåº”ç”¨ä¹‹é—´çš„åŒºåˆ†ï¼Œæ•™å¸ˆåº”ç”¨ TEACHER_GROUPï¼Œå­¦ç”Ÿåº”ç”¨ STUDENT_GROUPã€‚

Nacos ä¸­çš„ä¸€ç»„é…ç½®é›†ï¼Œæ˜¯ç»„ç»‡é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚é€šè¿‡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ Buy æˆ– Trade ï¼‰å¯¹é…ç½®é›†è¿›è¡Œåˆ†ç»„ï¼Œä»è€ŒåŒºåˆ† Data  ID ç›¸åŒçš„é…ç½®é›†ã€‚å½“æ‚¨åœ¨ Nacos ä¸Šåˆ›å»ºä¸€ä¸ªé…ç½®æ—¶ï¼Œå¦‚æœæœªå¡«å†™é…ç½®åˆ†ç»„çš„åç§°ï¼Œåˆ™é…ç½®åˆ†ç»„çš„åç§°é»˜è®¤é‡‡ç”¨ DEFAULT_GROUP  ã€‚é…ç½®åˆ†ç»„çš„å¸¸è§åœºæ™¯ï¼šä¸åŒçš„åº”ç”¨æˆ–ç»„ä»¶ä½¿ç”¨äº†ç›¸åŒçš„é…ç½®ç±»å‹ï¼Œå¦‚ database_url é…ç½®å’Œ MQ_topic é…ç½®ã€‚

- **é…ç½®é›†**

> å¤šä¸ªé”®å€¼å¯¹ï¼Œä¸€èˆ¬æŒ‡ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚

ä¸€ç»„ç›¸å…³æˆ–è€…ä¸ç›¸å…³çš„é…ç½®é¡¹çš„é›†åˆç§°ä¸ºé…ç½®é›†ï¼ˆå¤šä¸ªé”®å€¼å¯¹/ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼‰ã€‚åœ¨ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶é€šå¸¸å°±æ˜¯ä¸€ä¸ªé…ç½®é›†ï¼ŒåŒ…å«äº†ç³»ç»Ÿå„ä¸ªæ–¹é¢çš„é…ç½®ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé…ç½®é›†å¯èƒ½åŒ…å«äº†æ•°æ®æºã€çº¿ç¨‹æ± ã€æ—¥å¿—çº§åˆ«ç­‰é…ç½®é¡¹ã€‚

- **é…ç½®é›†ID**

> ç»™è¿™ä¸ªé…ç½®æ–‡ä»¶èµ·ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDã€‚

Nacos ä¸­çš„æŸä¸ªé…ç½®é›†çš„ IDã€‚é…ç½®é›† ID æ˜¯ç»„ç»‡åˆ’åˆ†é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚Data ID  é€šå¸¸ç”¨äºç»„ç»‡åˆ’åˆ†ç³»ç»Ÿçš„é…ç½®é›†ã€‚ä¸€ä¸ªç³»ç»Ÿæˆ–è€…åº”ç”¨å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®é›†ï¼Œæ¯ä¸ªé…ç½®é›†éƒ½å¯ä»¥è¢«ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°æ ‡è¯†ã€‚Data ID é€šå¸¸é‡‡ç”¨ç±» Java  åŒ…ï¼ˆå¦‚ com.taobao.tc.refund.log.levelï¼‰çš„å‘½åè§„åˆ™ä¿è¯å…¨å±€å”¯ä¸€æ€§ã€‚æ­¤å‘½åè§„åˆ™éå¼ºåˆ¶ã€‚

- **é…ç½®é¡¹**

> ä¸€ä¸ªé”®å€¼å¯¹ <Key = Value>

ä¸€ä¸ªå…·ä½“çš„å¯é…ç½®çš„å‚æ•°ä¸å…¶å€¼åŸŸï¼ˆä¸€ä¸ªé”®å€¼å¯¹ï¼‰ï¼Œé€šå¸¸ä»¥ param-key=param-value çš„å½¢å¼å­˜åœ¨ã€‚ä¾‹å¦‚æˆ‘ä»¬å¸¸é…ç½®ç³»ç»Ÿçš„æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼ˆlogLevel=INFO|WARN|ERRORï¼‰ å°±æ˜¯ä¸€ä¸ªé…ç½®é¡¹ã€‚

ç»™å¤§å®¶çœ‹ä¸€ä¸ªNacosçš„é…ç½®ç¤ºä¾‹ï¼Œè¿™äº›æ¦‚å¿µç›¸ä¿¡ä½ å°±éƒ½æ˜ç™½ã€‚

![Nacosé…ç½®ç¤ºä¾‹](https://gitee.com/wuyilong/picture-bed/raw/master/img/549b5b29e72b44b596796da9dc69453a~tplv-k3u1fbpfcp-watermark.png)

## å¼•å…¥Nacosé…ç½®ä¸­å¿ƒ

æˆ‘ä»¬ä»¥eshop-userä¸ºä¾‹æ¼”ç¤ºæˆ‘ä»¬çš„é…ç½®ä¸­å¿ƒã€‚

### å¼•å…¥nacos-configä¾èµ–

```java
        <!-- spring cloud alibaba nacos config ä¾èµ– -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>

```

### é…ç½®æ–‡ä»¶

å’ŒSpringCloud Conigç±»ä¼¼ï¼Œæˆ‘ä»¬å¿…éœ€è¦åœ¨ `bootstrap.yml`é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼Œåœ¨`application.yml`ä¸­æ— æ•ˆï¼Œ`bootstrap.yml`ä¼˜å…ˆçº§é«˜äº`application.yml`ã€‚

```java
spring:
  application:
    name: user-service # åº”ç”¨åç§°
  profiles:
    active: dev      # å½“å‰ç¯å¢ƒå¯¹åº”çš„ profile
  cloud:
    nacos:
      config:
        enabled: true     # å¦‚æœä¸æƒ³ä½¿ç”¨ Nacos è¿›è¡Œé…ç½®ç®¡ç†ï¼Œè®¾ç½®ä¸º false å³å¯
        server-addr: 127.0.0.1:8848   # Nacos Server åœ°å€
        group: DEFAULT_GROUP     # ç»„ï¼Œé»˜è®¤ä¸º DEFAULT_GROUP
        file-extension: yaml    # é…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œé»˜è®¤ä¸º properties

```

> è¯´æ˜ï¼šä¹‹æ‰€ä»¥éœ€è¦é…ç½® `spring.application.name`ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯æ„æˆ Nacos é…ç½®ç®¡ç† `dataId`å­—æ®µçš„ä¸€éƒ¨åˆ†ã€‚

ã€€ã€€åœ¨ Nacos Spring Cloud ä¸­ï¼Œ`dataId` çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š

```
${prefix}-${spring.profile.active}.${file-extension}
```

- `prefix` é»˜è®¤ä¸º `spring.application.name` çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ `spring.cloud.nacos.config.prefix`æ¥é…ç½®ã€‚
- `spring.profile.active` å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileã€‚**æ³¨æ„ï¼šå½“ `spring.profile.active` ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ `-` ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å°†å˜æˆ `${prefix}.${file-extension}`**
- `file-exetension` ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ `spring.cloud.nacos.config.file-extension` æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ `properties` å’Œ `yaml` ç±»å‹ï¼Œé»˜è®¤ä¸º `properties`ã€‚

### Nacos Serveråˆ›å»ºé…ç½®

æˆ‘ä»¬åœ¨Nacos Serverçš„é…ç½®åˆ—è¡¨ä¸­æ–°å»ºä¸€ä¸ªé…ç½®ã€‚

`Data Id` ä¸º `user-service.yaml`ï¼Œç»„ä½¿ç”¨é»˜è®¤ç»„ï¼Œå¹¶æ·»åŠ  `yaml` æ ¼å¼çš„é…ç½®ä¿¡æ¯ã€‚

![Nacoosæ–°å»ºé…ç½®](https://gitee.com/wuyilong/picture-bed/raw/master/img/d77edb0147e547f0b559dbf0446db823~tplv-k3u1fbpfcp-watermark.png)

```java
project:
  name: e-shop-userservice
  author: fighter3

```

### æ§åˆ¶å±‚

ä½¿ç”¨ Spring çš„ `@Value` æ³¨è§£æ¥è·å–é…ç½®ä¿¡æ¯ï¼Œ`${}` ä¸­å¯¹åº” Nacos é…ç½®ä¸­å¿ƒé…ç½®å†…å®¹çš„ keyï¼Œ`:`åè·Ÿé»˜è®¤å€¼ã€‚

å¹¶ä¸”é€šè¿‡ Spring Cloud åŸç”Ÿæ³¨è§£ `@RefreshScope` å®ç°é…ç½®è‡ªåŠ¨æ›´æ–°ã€‚

```java
/**
 * @Author: ä¸‰åˆ†æ¶
 * @Date: 2021/5/30
 * @Description: Nacosé…ç½®é¡¹è·å–
 **/

@RefreshScope
@RestController
@RequestMapping("/shop-user")
@Api(value = "é…ç½®ä¿¡æ¯æ¥å£", tags = "é…ç½®ä¿¡æ¯æ¥å£")
public class NacosConfigController {
    @Value("${project.name:}")
    private String projectName;

    @Value("${project.author:}")
    private String projectAuthor;

    @GetMapping("/config")
    @ApiOperation(value = "è·å–Nacosé…ç½®é¡¹")
    public Map<String, Object> getConfig() {
        Map<String, Object> configMap = new HashMap();
        configMap.put("projectName", projectName);
        configMap.put("projectAuthor", projectAuthor);
        return configMap;
    }

}

```

### æµ‹è¯•

å¯åŠ¨`user-service`æœåŠ¡ã€‚

è®¿é—®knife4jæ¥å£åœ°å€ï¼š[http://localhost:8080/doc.html](https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdoc.html)  ï¼Œè°ƒç”¨è·å–Nacosé…ç½®é¡¹æ¥å£ï¼š

![è·å–é…ç½®é¡¹](https://gitee.com/wuyilong/picture-bed/raw/master/img/129e8f21d5be4514ac8e24978df71eec~tplv-k3u1fbpfcp-watermark.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹é…ç½®é¡¹ï¼Œå¹¶å‘å¸ƒï¼š

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°è¾“å‡ºï¼š

![æ§åˆ¶å°æ‰“å°è¾“å‡º](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7723bc43316d4cb9827b2bcda383816b~tplv-k3u1fbpfcp-watermark.awebp)

å†æ¬¡è®¿é—®è·å–é…ç½®æ¥å£ï¼š

![è·å–ä¿®æ”¹åçš„é…ç½®é¡¹](https://gitee.com/wuyilong/picture-bed/raw/master/img/288822f6feba4e3cb75fc2b4f8cef823~tplv-k3u1fbpfcp-watermark.png)

OKï¼Œåˆ°è¿™æˆ‘ä»¬å·²ç»æˆåŠŸåœ°è¯»å–äº†Nacosé…ç½®ä¸­å¿ƒçš„é…ç½®ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•å°†æœåŠ¡çš„é…ç½®ï¼Œä¾‹å¦‚æ•°æ®æºæ¥è¿›è¡Œç»Ÿä¸€çš„é›†ä¸­é…ç½®ã€‚

## é›†ä¸­é…ç½®

å¥½ï¼Œæˆ‘ä»¬å¼€å§‹è¿›è¡ŒNacosé›†ä¸­é…ç½®çš„å®æˆ˜ï¼š

### æ–°å»ºå‘½åç©ºé—´

æˆ‘ä»¬ä¹‹å‰ç”¨çš„æ˜¯é»˜è®¤çš„å‘½åç©ºé—´ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼Œç”¨äºæˆ‘ä»¬å¼€å‘ç¯å¢ƒçš„é…ç½®ã€‚æˆ‘ä»¬ç»™å®ƒå‘½åä¸º`dev_space`:

![æ–°å»ºå‘½åç©ºé—´](https://gitee.com/wuyilong/picture-bed/raw/master/img/e5181a8669c64f5bab095b729f2a939b~tplv-k3u1fbpfcp-watermark.png)

è¿™é‡Œä½¿ç”¨äº†å‘½åç©ºé—´æ¥éš”ç¦»é…ç½®ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒçš„é…ç½®ï¼Œå¦‚æ³•ç‚®åˆ¶ï¼Œå»ºä¸€ä¸ªæ–°çš„ç©ºé—´å°±è¡Œäº†ã€‚

### åˆ›å»ºæ•°æ®æºé…ç½®

æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨`dev_space`ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®`user-service-dev.yaml`

![æ–°å»ºé…ç½®](https://gitee.com/wuyilong/picture-bed/raw/master/img/3dcefeba722a431485654feff6534256~tplv-k3u1fbpfcp-watermark.png)

```java
project:
  name: e-shop-userservice
  author: fighter3
# æ•°æ®æºé…ç½®
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/shop_user?characterEncoding=utf-8&allowMultiQueries=true&serverTimezone=GMT%2B8
    username: root
    password: root 

```

![dev-space](https://gitee.com/wuyilong/picture-bed/raw/master/img/3d498c4d23af4dae8f8bad426638db77~tplv-k3u1fbpfcp-watermark.png)

### ä¿®æ”¹æœ¬åœ°é…ç½®

æˆ‘ä»¬åœ¨bootstrap.ymlä¸­æŒ‡å®šå‘½åç©ºé—´ï¼Œå®Œæ•´bootstrap.ymlå¦‚ä¸‹ï¼š

```java
spring:
  application:
    name: user-service # åº”ç”¨åç§°
  profiles:
    active: dev      # å½“å‰ç¯å¢ƒå¯¹åº”çš„ profile
  cloud:
    nacos:
      config:
        enabled: true     # å¦‚æœä¸æƒ³ä½¿ç”¨ Nacos è¿›è¡Œé…ç½®ç®¡ç†ï¼Œè®¾ç½®ä¸º false å³å¯
        server-addr: 127.0.0.1:8848   # Nacos Server åœ°å€
        group: DEFAULT_GROUP     # ç»„ï¼Œé»˜è®¤ä¸º DEFAULT_GROUP
        file-extension: yaml    # é…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œé»˜è®¤ä¸º properties
        namespace: dev_space    # æŒ‡å®šå‘½åç©ºé—´ï¼Œé»˜è®¤ä¸ºpublic

```

ä¿®æ”¹application.ymlï¼Œæ³¨é‡Šæ‰æ•°æ®æºç›¸å…³é…ç½®ï¼š

![æ•°æ®æºé…ç½®æ³¨é‡Š](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dffabdf4b1f9476185543362f3ad58af~tplv-k3u1fbpfcp-watermark.awebp)

### æµ‹è¯•

å¯åŠ¨ç”¨æˆ·æœåŠ¡ï¼ŒæœåŠ¡æ­£å¸¸å¯åŠ¨ä»¥åï¼Œæˆ‘ä»¬åˆ†åˆ«è°ƒè¯•è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£å’Œè·å–é…ç½®æ¥å£ã€‚

![è·å–ç”¨æˆ·](https://gitee.com/wuyilong/picture-bed/raw/master/img/e7894aded8da4af284096a437b94be67~tplv-k3u1fbpfcp-watermark.png)

![é…ç½®é¡¹](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9da5470e4f1f46b7817bb20b92c1ad7e~tplv-k3u1fbpfcp-watermark.awebp)

OKï¼Œè·å–åˆ°äº†é¢„æœŸçš„ç»“æœã€‚

å¥½äº†ï¼ŒNacosä½œä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒçš„å®æˆ˜åˆ°æ­¤ç»“æŸäº†ï¼Œäº†è§£æ›´å¤šå¯ä»¥ç›´æ¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼


ä½œè€…ï¼šä¸‰åˆ†æ¶
é“¾æ¥ï¼šhttps://juejin.cn/post/6979915003881226270
æ¥æºï¼šæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚